{"bugs":{"612447":{"comments":[{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T00:37:05Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"I can consistently crash Firefox's latest trunk nightly on win7 by visiting http://jsbin.com/odoho3 and clicking the \"edit with js bin\" link in the top right corner of the window. \n\nOr, just click here http://jsbin.com/odoho3/edit\n\nhere's a crash report http://crash-stats.mozilla.com/report/index/bp-22051991-0c88-4f8d-aa1d-775812101115","id":5083940,"creation_time":"2010-11-16T00:37:05Z","raw_text":"I can consistently crash Firefox's latest trunk nightly on win7 by visiting http://jsbin.com/odoho3 and clicking the \"edit with js bin\" link in the top right corner of the window. \n\nOr, just click here http://jsbin.com/odoho3/edit\n\nhere's a crash report http://crash-stats.mozilla.com/report/index/bp-22051991-0c88-4f8d-aa1d-775812101115"},{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T00:38:57Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"actually, it's not enough to click the link directly. You must first visit http://jsbin.com/odoho3 and then click the link.","id":5083945,"creation_time":"2010-11-16T00:38:57Z","raw_text":"actually, it's not enough to click the link directly. You must first visit http://jsbin.com/odoho3 and then click the link."},{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T00:41:26Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"http://crash-stats.mozilla.com/report/index/bp-8d5be0c6-7b2b-4443-89c9-dab982101115 is the same crash, I think, with a better report.  So, -> editor?\n\nnsEditor::DeleteNode","id":5083951,"creation_time":"2010-11-16T00:41:26Z","raw_text":"http://crash-stats.mozilla.com/report/index/bp-8d5be0c6-7b2b-4443-89c9-dab982101115 is the same crash, I think, with a better report.  So, -> editor?\n\nnsEditor::DeleteNode"},{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T00:47:40Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"ehsan, is this in anything you're working on?","id":5083959,"creation_time":"2010-11-16T00:47:40Z","raw_text":"ehsan, is this in anything you're working on?"},{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T00:49:04Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"comment #1 was wrong. I can reproduce simply by clicking this link http://jsbin.com/odoho3/edit","id":5083962,"creation_time":"2010-11-16T00:49:04Z","raw_text":"comment #1 was wrong. I can reproduce simply by clicking this link http://jsbin.com/odoho3/edit"},{"is_private":false,"attachment_id":null,"creator":"mozillamarcia.knous@gmail.com","time":"2010-11-16T00:59:01Z","author":"mozillamarcia.knous@gmail.com","bug_id":612447,"tags":[],"text":"Occurs using Mac as well, just by clicking the link in Comment 4.","id":5083997,"creation_time":"2010-11-16T00:59:01Z","raw_text":"Occurs using Mac as well, just by clicking the link in Comment 4."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2010-11-16T16:58:46Z","author":"mats@mozilla.com","bug_id":612447,"tags":[],"text":"*** Bug 612525 has been marked as a duplicate of this bug. ***","id":5085223,"creation_time":"2010-11-16T16:58:46Z","raw_text":""},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2010-11-16T21:41:55Z","author":"bugs@pettay.fi","bug_id":612447,"tags":[],"text":"Regression from bug 611182?","id":5086132,"creation_time":"2010-11-16T21:41:55Z","raw_text":"Regression from bug 611182?"},{"is_private":false,"attachment_id":null,"creator":"asa@mozilla.org","time":"2010-11-16T21:47:37Z","author":"asa@mozilla.org","bug_id":612447,"tags":[],"text":"why is this marked security-confidential? not contesting, just interested.","id":5086150,"creation_time":"2010-11-16T21:47:37Z","raw_text":"why is this marked security-confidential? not contesting, just interested."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2010-11-16T22:03:51Z","author":"scoobidiver@netcourrier.com","bug_id":612447,"tags":[],"text":"From the dupe, here is the regression range:\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=674f2ed15cea&tochange=edf41ff32f08","id":5086216,"creation_time":"2010-11-16T22:03:51Z","raw_text":"From the dupe, here is the regression range:\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=674f2ed15cea&tochange=edf41ff32f08"},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2010-11-16T22:16:06Z","author":"bugs@pettay.fi","bug_id":612447,"tags":[],"text":"e091e8999c1d doesn't crash, 98b0ae888195 does.\n\nThe first one is right before https://bugzilla.mozilla.org/show_bug.cgi?id=611182#c29","id":5086254,"creation_time":"2010-11-16T22:16:06Z","raw_text":"e091e8999c1d doesn't crash, 98b0ae888195 does.\n\nThe first one is right before https://bugzilla.mozilla.org/show_bug.cgi?id=611182#c29"},{"is_private":false,"attachment_id":null,"creator":"ehsan@mozilla.com","time":"2010-11-16T23:22:39Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"So, this doesn't happen with the fix to bug 612565 on jsbin.com, but the issue is very serious, and it could potentially happen in a lot of other cases.\n\nWhat's happening is that we call nsIEditor::DeleteNode, which indirectly calls nsHTMLCSSUtils::GetComputedProperty, which flushes.  When the flush is finished and we call nsContentUtils::RemoveScriptBlocker, nsFrameLoader::Show gets called, which calls SetDesignMode(\"off\") and SetDesignMode(\"on\") to restore the editor on the frame.  This causes the original editor attached to the document to be destroyed with a stack like this:\n\n#0  0x00000001143fed82 in nsPlaintextEditor::~nsPlaintextEditor (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/text/nsPlaintextEditor.cpp:110\n#1  0x000000011476a011 in nsHTMLEditor::~nsHTMLEditor (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:228\n#2  0x0000000114418bb0 in nsEditor::Release (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/base/nsEditor.cpp:215\n#3  0x0000000114767d99 in nsHTMLEditor::Release (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:238\n#4  0x0000000113b72578 in nsCOMPtr<nsIEditor>::~nsCOMPtr (this=0x7fff5fbfa1c0) at nsCOMPtr.h:533\n#5  0x0000000113b7b77f in nsEditingSession::TearDownEditorOnWindow (this=0x127d881f0, aWindow=0x127e0f0e0) at /Users/ehsanakhgari/moz/mozilla-central/editor/composer/src/nsEditingSession.cpp:623\n#6  0x0000000114189a6d in nsHTMLDocument::TurnEditingOff (this=0x12993a800) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3197\n#7  0x0000000114193d23 in nsHTMLDocument::EditingStateChanged (this=0x12993a800) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3244\n#8  0x0000000114195110 in nsHTMLDocument::SetDesignMode (this=0x12993a800, aDesignMode=@0x7fff5fbfa6b0) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3439\n#9  0x0000000113fa83cd in nsFrameLoader::Show (this=0x127e0e790, marginWidth=-1, marginHeight=-1, scrollbarPrefX=1, scrollbarPrefY=1, frame=0x101638ca8) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsFrameLoader.cpp:689\n#10 0x0000000113d8af6a in nsSubDocumentFrame::ShowViewer (this=0x101638ca8) at /Users/ehsanakhgari/moz/mozilla-central/layout/generic/nsSubDocumentFrame.cpp:235\n#11 0x0000000113d8dbb7 in AsyncFrameInit::Run (this=0x11d87be50) at /Users/ehsanakhgari/moz/mozilla-central/layout/generic/nsSubDocumentFrame.cpp:152\n#12 0x0000000113f34154 in nsContentUtils::RemoveScriptBlocker () at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsContentUtils.cpp:4758\n#13 0x0000000113c1e981 in nsAutoScriptBlocker::~nsAutoScriptBlocker (this=0x7fff5fbfa8ff) at nsContentUtils.h:1892\n#14 0x0000000113c9ca5a in PresShell::FlushPendingNotifications (this=0x127c77350, aType=Flush_Layout) at /Users/ehsanakhgari/moz/mozilla-central/layout/base/nsPresShell.cpp:4851\n#15 0x0000000113f6bb86 in nsDocument::FlushPendingNotifications (this=0x10142b400, aType=Flush_Layout) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:6437\n#16 0x0000000113f6bb41 in nsDocument::FlushPendingNotifications (this=0x12993a800, aType=Flush_Style) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:6432\n#17 0x0000000113e1808e in nsComputedDOMStyle::GetPropertyCSSValue (this=0x127e574a0, aPropertyName=@0x7fff5fbfac20, aReturn=0x7fff5fbfab00) at /Users/ehsanakhgari/moz/mozilla-central/layout/style/nsComputedDOMStyle.cpp:486\n#18 0x0000000113e17a7f in nsComputedDOMStyle::GetPropertyValue (this=0x127e574a0, aPropertyName=@0x7fff5fbfac20, aReturn=@0x7fff5fbfab80) at /Users/ehsanakhgari/moz/mozilla-central/layout/style/nsComputedDOMStyle.cpp:310\n#19 0x0000000114748060 in nsHTMLCSSUtils::GetCSSInlinePropertyBase (this=0x127eb5b20, aNode=0x127dc1198, aProperty=0x101843d70, aValue=@0x7fff5fbfadf0, aViewCSS=0x127e0f188, aStyleType=2 '\\002') at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLCSSUtils.cpp:571\n#20 0x00000001147494b6 in nsHTMLCSSUtils::GetComputedProperty (this=0x127eb5b20, aNode=0x127dc1198, aProperty=0x101843d70, aValue=@0x7fff5fbfadf0) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLCSSUtils.cpp:545\n#21 0x0000000114755cdc in nsHTMLEditor::FindUserSelectAllNode (this=0x127d88500, aNode=0x127dc1198) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:3918\n#22 0x0000000114755f69 in nsHTMLEditor::DeleteNode (this=0x127d88500, aNode=0x127dc1198) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:3801\n#23 0x0000000114777b17 in nsHTMLEditRules::DocumentModifiedWorker (this=0x129f07400) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditRules.cpp:9181\n#24 0x00000001147af65d in nsRunnableMethodImpl<void (nsHTMLEditRules::*)(), true>::Run (this=0x12ea311c0) at nsThreadUtils.h:347\n#25 0x0000000113f34154 in nsContentUtils::RemoveScriptBlocker () at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsContentUtils.cpp:4758\n#26 0x0000000113fc7e74 in nsContentUtils::RemoveRemovableScriptBlocker () at nsContentUtils.h:1483\n#27 0x0000000113f89759 in nsDocument::EndUpdate (this=0x12993a800, aUpdateType=1) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:3968\n#28 0x0000000114196d7f in nsHTMLDocument::EndUpdate (this=0x12993a800, aUpdateType=1) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:2961\n#29 0x0000000113e2f9fe in mozAutoDocConditionalContentUpdateBatch::~mozAutoDocConditionalContentUpdateBatch (this=0x7fff5fbfb1a0) at mozAutoDocUpdate.h:112\n#30 0x0000000113fbbf48 in nsINode::ReplaceOrInsertBefore (this=0x1277e3570, aReplace=0, aNewChild=0x127dc3e60, aRefChild=0x0) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsGenericElement.cpp:4283\n#31 0x00000001140e07b2 in nsINode::ReplaceOrInsertBefore (this=0x1277e3570, aReplace=0, aNewChild=0x127dc3e60, aRefChild=0x0, aReturn=0x7fff5fbfb38c) at nsINode.h:1222\n#32 0x00000001140e0831 in nsINode::InsertBefore (this=0x1277e3570, aNewChild=0x127dc3e60, aRefChild=0x0, aReturn=0x7fff5fbfb38c) at nsINode.h:457\n#33 0x00000001148f04a8 in nsIDOMNode_InsertBefore (cx=0x1264eae30, argc=2, vp=0x1178e3658) at dom_quickstubs.cpp:6063\n#34 0x00000001001b591c in js::CallJSNative (cx=0x1264eae30, native=0x1148f0218 <nsIDOMNode_InsertBefore(JSContext*, unsigned int, jsval_layout*)>, argc=2, vp=0x1178e3658) at jscntxtinlines.h:684\n\nWhen we return to nsHTMLEditor::DeleteNode, |*this| is dead, and later on in nsAutoRules constructor we try to dereference |this|, which causes us to crash.\n\nI'm not sure if this crash is exploitable...","id":5086445,"creation_time":"2010-11-16T23:22:39Z","raw_text":"So, this doesn't happen with the fix to bug 612565 on jsbin.com, but the issue is very serious, and it could potentially happen in a lot of other cases.\n\nWhat's happening is that we call nsIEditor::DeleteNode, which indirectly calls nsHTMLCSSUtils::GetComputedProperty, which flushes.  When the flush is finished and we call nsContentUtils::RemoveScriptBlocker, nsFrameLoader::Show gets called, which calls SetDesignMode(\"off\") and SetDesignMode(\"on\") to restore the editor on the frame.  This causes the original editor attached to the document to be destroyed with a stack like this:\n\n#0  0x00000001143fed82 in nsPlaintextEditor::~nsPlaintextEditor (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/text/nsPlaintextEditor.cpp:110\n#1  0x000000011476a011 in nsHTMLEditor::~nsHTMLEditor (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:228\n#2  0x0000000114418bb0 in nsEditor::Release (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/base/nsEditor.cpp:215\n#3  0x0000000114767d99 in nsHTMLEditor::Release (this=0x127d88500) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:238\n#4  0x0000000113b72578 in nsCOMPtr<nsIEditor>::~nsCOMPtr (this=0x7fff5fbfa1c0) at nsCOMPtr.h:533\n#5  0x0000000113b7b77f in nsEditingSession::TearDownEditorOnWindow (this=0x127d881f0, aWindow=0x127e0f0e0) at /Users/ehsanakhgari/moz/mozilla-central/editor/composer/src/nsEditingSession.cpp:623\n#6  0x0000000114189a6d in nsHTMLDocument::TurnEditingOff (this=0x12993a800) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3197\n#7  0x0000000114193d23 in nsHTMLDocument::EditingStateChanged (this=0x12993a800) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3244\n#8  0x0000000114195110 in nsHTMLDocument::SetDesignMode (this=0x12993a800, aDesignMode=@0x7fff5fbfa6b0) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:3439\n#9  0x0000000113fa83cd in nsFrameLoader::Show (this=0x127e0e790, marginWidth=-1, marginHeight=-1, scrollbarPrefX=1, scrollbarPrefY=1, frame=0x101638ca8) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsFrameLoader.cpp:689\n#10 0x0000000113d8af6a in nsSubDocumentFrame::ShowViewer (this=0x101638ca8) at /Users/ehsanakhgari/moz/mozilla-central/layout/generic/nsSubDocumentFrame.cpp:235\n#11 0x0000000113d8dbb7 in AsyncFrameInit::Run (this=0x11d87be50) at /Users/ehsanakhgari/moz/mozilla-central/layout/generic/nsSubDocumentFrame.cpp:152\n#12 0x0000000113f34154 in nsContentUtils::RemoveScriptBlocker () at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsContentUtils.cpp:4758\n#13 0x0000000113c1e981 in nsAutoScriptBlocker::~nsAutoScriptBlocker (this=0x7fff5fbfa8ff) at nsContentUtils.h:1892\n#14 0x0000000113c9ca5a in PresShell::FlushPendingNotifications (this=0x127c77350, aType=Flush_Layout) at /Users/ehsanakhgari/moz/mozilla-central/layout/base/nsPresShell.cpp:4851\n#15 0x0000000113f6bb86 in nsDocument::FlushPendingNotifications (this=0x10142b400, aType=Flush_Layout) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:6437\n#16 0x0000000113f6bb41 in nsDocument::FlushPendingNotifications (this=0x12993a800, aType=Flush_Style) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:6432\n#17 0x0000000113e1808e in nsComputedDOMStyle::GetPropertyCSSValue (this=0x127e574a0, aPropertyName=@0x7fff5fbfac20, aReturn=0x7fff5fbfab00) at /Users/ehsanakhgari/moz/mozilla-central/layout/style/nsComputedDOMStyle.cpp:486\n#18 0x0000000113e17a7f in nsComputedDOMStyle::GetPropertyValue (this=0x127e574a0, aPropertyName=@0x7fff5fbfac20, aReturn=@0x7fff5fbfab80) at /Users/ehsanakhgari/moz/mozilla-central/layout/style/nsComputedDOMStyle.cpp:310\n#19 0x0000000114748060 in nsHTMLCSSUtils::GetCSSInlinePropertyBase (this=0x127eb5b20, aNode=0x127dc1198, aProperty=0x101843d70, aValue=@0x7fff5fbfadf0, aViewCSS=0x127e0f188, aStyleType=2 '\\002') at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLCSSUtils.cpp:571\n#20 0x00000001147494b6 in nsHTMLCSSUtils::GetComputedProperty (this=0x127eb5b20, aNode=0x127dc1198, aProperty=0x101843d70, aValue=@0x7fff5fbfadf0) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLCSSUtils.cpp:545\n#21 0x0000000114755cdc in nsHTMLEditor::FindUserSelectAllNode (this=0x127d88500, aNode=0x127dc1198) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:3918\n#22 0x0000000114755f69 in nsHTMLEditor::DeleteNode (this=0x127d88500, aNode=0x127dc1198) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditor.cpp:3801\n#23 0x0000000114777b17 in nsHTMLEditRules::DocumentModifiedWorker (this=0x129f07400) at /Users/ehsanakhgari/moz/mozilla-central/editor/libeditor/html/nsHTMLEditRules.cpp:9181\n#24 0x00000001147af65d in nsRunnableMethodImpl<void (nsHTMLEditRules::*)(), true>::Run (this=0x12ea311c0) at nsThreadUtils.h:347\n#25 0x0000000113f34154 in nsContentUtils::RemoveScriptBlocker () at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsContentUtils.cpp:4758\n#26 0x0000000113fc7e74 in nsContentUtils::RemoveRemovableScriptBlocker () at nsContentUtils.h:1483\n#27 0x0000000113f89759 in nsDocument::EndUpdate (this=0x12993a800, aUpdateType=1) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsDocument.cpp:3968\n#28 0x0000000114196d7f in nsHTMLDocument::EndUpdate (this=0x12993a800, aUpdateType=1) at /Users/ehsanakhgari/moz/mozilla-central/content/html/document/src/nsHTMLDocument.cpp:2961\n#29 0x0000000113e2f9fe in mozAutoDocConditionalContentUpdateBatch::~mozAutoDocConditionalContentUpdateBatch (this=0x7fff5fbfb1a0) at mozAutoDocUpdate.h:112\n#30 0x0000000113fbbf48 in nsINode::ReplaceOrInsertBefore (this=0x1277e3570, aReplace=0, aNewChild=0x127dc3e60, aRefChild=0x0) at /Users/ehsanakhgari/moz/mozilla-central/content/base/src/nsGenericElement.cpp:4283\n#31 0x00000001140e07b2 in nsINode::ReplaceOrInsertBefore (this=0x1277e3570, aReplace=0, aNewChild=0x127dc3e60, aRefChild=0x0, aReturn=0x7fff5fbfb38c) at nsINode.h:1222\n#32 0x00000001140e0831 in nsINode::InsertBefore (this=0x1277e3570, aNewChild=0x127dc3e60, aRefChild=0x0, aReturn=0x7fff5fbfb38c) at nsINode.h:457\n#33 0x00000001148f04a8 in nsIDOMNode_InsertBefore (cx=0x1264eae30, argc=2, vp=0x1178e3658) at dom_quickstubs.cpp:6063\n#34 0x00000001001b591c in js::CallJSNative (cx=0x1264eae30, native=0x1148f0218 <nsIDOMNode_InsertBefore(JSContext*, unsigned int, jsval_layout*)>, argc=2, vp=0x1178e3658) at jscntxtinlines.h:684\n\nWhen we return to nsHTMLEditor::DeleteNode, |*this| is dead, and later on in nsAutoRules constructor we try to dereference |this|, which causes us to crash.\n\nI'm not sure if this crash is exploitable..."},{"is_private":false,"attachment_id":491345,"creator":"ehsan@mozilla.com","time":"2010-11-17T23:16:26Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"Created attachment 491345\nPatch (v1)\n\nThis patch makes nsFrameLoader::Show not recreate the editor object, but use the same object.  It also makes a few changes to nsHTMLEditor to make it safe for reuse.","id":5089321,"creation_time":"2010-11-17T23:16:26Z","raw_text":"This patch makes nsFrameLoader::Show not recreate the editor object, but use the same object.  It also makes a few changes to nsHTMLEditor to make it safe for reuse."},{"is_private":false,"attachment_id":null,"creator":"bzbarsky@mit.edu","time":"2010-11-18T04:23:08Z","author":"bzbarsky@mit.edu","bug_id":612447,"tags":[],"text":"That doesn't seem to make this safe, though.  If you're flushing, arbitrary script can run.  So whatever is up the stack from a flush needs to be able to deal with that.","id":5090024,"creation_time":"2010-11-18T04:23:08Z","raw_text":"That doesn't seem to make this safe, though.  If you're flushing, arbitrary script can run.  So whatever is up the stack from a flush needs to be able to deal with that."},{"is_private":false,"attachment_id":null,"creator":"ehsan@mozilla.com","time":"2010-11-18T19:42:25Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"(In reply to comment #13)\n> That doesn't seem to make this safe, though.  If you're flushing, arbitrary\n> script can run.  So whatever is up the stack from a flush needs to be able to\n> deal with that.\n\nSo, seems like all of the HTML editor commands which can be executed via the nsIDOMNSHTMLDocuemnt methods already hold a strong reference to the HTML editor's object (which is the weak command context pointer.  See <http://mxr.mozilla.org/mozilla-central/source/embedding/components/commandhandler/src/nsBaseCommandController.cpp#124> to the end of this file (note the variables named |weak|).","id":5091317,"creation_time":"2010-11-18T19:42:25Z","raw_text":"(In reply to comment #13)\n> That doesn't seem to make this safe, though.  If you're flushing, arbitrary\n> script can run.  So whatever is up the stack from a flush needs to be able to\n> deal with that.\n\nSo, seems like all of the HTML editor commands which can be executed via the nsIDOMNSHTMLDocuemnt methods already hold a strong reference to the HTML editor's object (which is the weak command context pointer.  See <http://mxr.mozilla.org/mozilla-central/source/embedding/components/commandhandler/src/nsBaseCommandController.cpp#124> to the end of this file (note the variables named |weak|)."},{"is_private":false,"attachment_id":491636,"creator":"ehsan@mozilla.com","time":"2010-11-18T21:00:25Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"Created attachment 491636\nPart 2\n\nThis patch protects the editor object from dying while executing a mutation event handler.  With this, I think we should be good to go here.","id":5091556,"creation_time":"2010-11-18T21:00:25Z","raw_text":"This patch protects the editor object from dying while executing a mutation event handler.  With this, I think we should be good to go here."},{"is_private":false,"attachment_id":null,"creator":"bzbarsky@mit.edu","time":"2010-11-18T21:26:28Z","author":"bzbarsky@mit.edu","bug_id":612447,"tags":[],"text":"How does part 2 help?  The code in the stack above doesn't run while that nsCOMPtr is on the stack, since it runs off a script runner.  Shouldn't we hold the ref in the script runner runnable?","id":5091667,"creation_time":"2010-11-18T21:26:28Z","raw_text":"How does part 2 help?  The code in the stack above doesn't run while that nsCOMPtr is on the stack, since it runs off a script runner.  Shouldn't we hold the ref in the script runner runnable?"},{"is_private":false,"attachment_id":null,"creator":"ehsan@mozilla.com","time":"2010-11-18T23:06:56Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"(In reply to comment #16)\n> How does part 2 help?  The code in the stack above doesn't run while that\n> nsCOMPtr is on the stack, since it runs off a script runner.  Shouldn't we hold\n> the ref in the script runner runnable?\n\nThis doesn't directly relate to this bug, but it will potentially help in similar situations which we don't know about yet.  Note that DocumentModified is not the only thing executed by these two functions.  But you're right, I need to submit another patch for the part which is run off the script runner as well.","id":5092073,"creation_time":"2010-11-18T23:06:56Z","raw_text":"(In reply to comment #16)\n> How does part 2 help?  The code in the stack above doesn't run while that\n> nsCOMPtr is on the stack, since it runs off a script runner.  Shouldn't we hold\n> the ref in the script runner runnable?\n\nThis doesn't directly relate to this bug, but it will potentially help in similar situations which we don't know about yet.  Note that DocumentModified is not the only thing executed by these two functions.  But you're right, I need to submit another patch for the part which is run off the script runner as well."},{"is_private":false,"attachment_id":491683,"creator":"ehsan@mozilla.com","time":"2010-11-18T23:10:59Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"Created attachment 491683\nPart 3","id":5092089,"creation_time":"2010-11-18T23:10:59Z","raw_text":""},{"is_private":false,"attachment_id":491636,"creator":"bzbarsky@mit.edu","time":"2010-11-20T04:01:47Z","author":"bzbarsky@mit.edu","bug_id":612447,"tags":[],"text":"Comment on attachment 491636\nPart 2\n\nr=me, but watch out for this showing up in profiles...","id":5095674,"creation_time":"2010-11-20T04:01:47Z","raw_text":"r=me, but watch out for this showing up in profiles..."},{"is_private":false,"attachment_id":491683,"creator":"bzbarsky@mit.edu","time":"2010-11-20T04:02:07Z","author":"bzbarsky@mit.edu","bug_id":612447,"tags":[],"text":"Comment on attachment 491683\nPart 3\n\nr=me","id":5095675,"creation_time":"2010-11-20T04:02:07Z","raw_text":"r=me"},{"is_private":false,"attachment_id":491345,"creator":"bzbarsky@mit.edu","time":"2010-11-20T04:03:50Z","author":"bzbarsky@mit.edu","bug_id":612447,"tags":[],"text":"Comment on attachment 491345\nPatch (v1)\n\nr=me","id":5095677,"creation_time":"2010-11-20T04:03:50Z","raw_text":"r=me"},{"is_private":false,"attachment_id":null,"creator":"ehsan@mozilla.com","time":"2010-11-20T21:55:32Z","author":"ehsan@mozilla.com","bug_id":612447,"tags":[],"text":"http://hg.mozilla.org/mozilla-central/rev/64fdcad8cb11\nhttp://hg.mozilla.org/mozilla-central/rev/406748270073\nhttp://hg.mozilla.org/mozilla-central/rev/70116ee1ea9a","id":5096125,"creation_time":"2010-11-20T21:55:32Z","raw_text":"http://hg.mozilla.org/mozilla-central/rev/64fdcad8cb11\nhttp://hg.mozilla.org/mozilla-central/rev/406748270073\nhttp://hg.mozilla.org/mozilla-central/rev/70116ee1ea9a"}]}},"comments":{}}