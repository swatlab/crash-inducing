{"bugs":{"817342":{"comments":[{"is_private":false,"attachment_id":687457,"creator":"fehe@hotmail.com","time":"2012-12-01T23:13:30Z","author":"fehe@hotmail.com","bug_id":817342,"tags":[],"text":"Created attachment 687457\nstack trace\n\nAs a result of bug 790338, there is a new crash that can be exposed when the Print Edit and Redirector extensions are present and Print Edit is invoked.\n\nbp-da0b6941-aaee-4977-aa90-fe7372121201\n\nRegression window: http://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=7e6ac3bfbae9&tochange=26172ff887ae\n\nSTR\n1. Launch Firefox with a new profile\n2. Install the following extensions and restart Firefox:\na) Print Edit: https://addons.mozilla.org/en-US/firefox/addon/print-edit/\nb) Redirector: https://addons.mozilla.org/en-US/firefox/addon/redirector/\n3. Click the home button to load the Firefox default home page\n4. Right-click the page and choose Print... --> Print Edit\n5. Wait a few seconds\n\n\nCrashing Thread\nFrame \tModule \tSignature \tSource\n0 \tmozjs.dll \tjs::GCMarker::processMarkStackTop \tjs/src/gc/Marking.cpp:1348\n1 \tmozjs.dll \tjs::GCMarker::drainMarkStack \tjs/src/gc/Marking.cpp:1407\n2 \tmozjs.dll \tMarkGrayReferences \tjs/src/jsgc.cpp:2743\n3 \tmozjs.dll \tEndMarkingCompartmentGroup \tjs/src/jsgc.cpp:3214\n4 \tmozjs.dll \tSweepPhase \tjs/src/jsgc.cpp:3441\n5 \tmozjs.dll \tIncrementalCollectSlice \tjs/src/jsgc.cpp:3879\n6 \tmozjs.dll \tGCCycle \tjs/src/jsgc.cpp:4006\n7 \tmozjs.dll \tCollect \tjs/src/jsgc.cpp:4121\n8 \tmozjs.dll \tjs::GCFinalSlice \tjs/src/jsgc.cpp:4166\n9 \txul.dll \tCCTimerFired \tdom/base/nsJSEnvironment.cpp:3256\n10 \txul.dll \tnsTimerEvent::Run \txpcom/threads/nsTimerImpl.cpp:565\n11 \txul.dll \tnsThread::ProcessNextEvent \txpcom/threads/nsThread.cpp:627\n12 \txul.dll \tmozilla::ipc::MessagePump::Run \tipc/glue/MessagePump.cpp:82\n13 \txul.dll \tMessageLoop::RunHandler \tipc/chromium/src/base/message_loop.cc:208\n14 \txul.dll \tMessageLoop::Run \tipc/chromium/src/base/message_loop.cc:182\n15 \txul.dll \tnsBaseAppShell::Run \twidget/xpwidgets/nsBaseAppShell.cpp:163\n16 \txul.dll \tnsAppShell::Run \twidget/windows/nsAppShell.cpp:229\n17 \txul.dll \tnsAppStartup::Run \ttoolkit/components/startup/nsAppStartup.cpp:290\n18 \txul.dll \tXREMain::XRE_mainRun \ttoolkit/xre/nsAppRunner.cpp:3823\n19 \txul.dll \tXREMain::XRE_main \ttoolkit/xre/nsAppRunner.cpp:3890\n20 \txul.dll \tXRE_main \ttoolkit/xre/nsAppRunner.cpp:4084\n21 \tfirefox.exe \twmain \ttoolkit/xre/nsWindowsWMain.cpp:105\n22 \tfirefox.exe \t__tmainCRTStartup \tcrtexe.c:552\n23 \tkernel32.dll \tBaseThreadInitThunk \t\n24 \tntdll.dll \t__RtlUserThreadStart \t\n25 \tntdll.dll \t_RtlUserThreadStart","id":6871803,"creation_time":"2012-12-01T23:13:30Z","raw_text":"As a result of bug 790338, there is a new crash that can be exposed when the Print Edit and Redirector extensions are present and Print Edit is invoked.\n\nbp-da0b6941-aaee-4977-aa90-fe7372121201\n\nRegression window: http://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=7e6ac3bfbae9&tochange=26172ff887ae\n\nSTR\n1. Launch Firefox with a new profile\n2. Install the following extensions and restart Firefox:\na) Print Edit: https://addons.mozilla.org/en-US/firefox/addon/print-edit/\nb) Redirector: https://addons.mozilla.org/en-US/firefox/addon/redirector/\n3. Click the home button to load the Firefox default home page\n4. Right-click the page and choose Print... --> Print Edit\n5. Wait a few seconds\n\n\nCrashing Thread\nFrame \tModule \tSignature \tSource\n0 \tmozjs.dll \tjs::GCMarker::processMarkStackTop \tjs/src/gc/Marking.cpp:1348\n1 \tmozjs.dll \tjs::GCMarker::drainMarkStack \tjs/src/gc/Marking.cpp:1407\n2 \tmozjs.dll \tMarkGrayReferences \tjs/src/jsgc.cpp:2743\n3 \tmozjs.dll \tEndMarkingCompartmentGroup \tjs/src/jsgc.cpp:3214\n4 \tmozjs.dll \tSweepPhase \tjs/src/jsgc.cpp:3441\n5 \tmozjs.dll \tIncrementalCollectSlice \tjs/src/jsgc.cpp:3879\n6 \tmozjs.dll \tGCCycle \tjs/src/jsgc.cpp:4006\n7 \tmozjs.dll \tCollect \tjs/src/jsgc.cpp:4121\n8 \tmozjs.dll \tjs::GCFinalSlice \tjs/src/jsgc.cpp:4166\n9 \txul.dll \tCCTimerFired \tdom/base/nsJSEnvironment.cpp:3256\n10 \txul.dll \tnsTimerEvent::Run \txpcom/threads/nsTimerImpl.cpp:565\n11 \txul.dll \tnsThread::ProcessNextEvent \txpcom/threads/nsThread.cpp:627\n12 \txul.dll \tmozilla::ipc::MessagePump::Run \tipc/glue/MessagePump.cpp:82\n13 \txul.dll \tMessageLoop::RunHandler \tipc/chromium/src/base/message_loop.cc:208\n14 \txul.dll \tMessageLoop::Run \tipc/chromium/src/base/message_loop.cc:182\n15 \txul.dll \tnsBaseAppShell::Run \twidget/xpwidgets/nsBaseAppShell.cpp:163\n16 \txul.dll \tnsAppShell::Run \twidget/windows/nsAppShell.cpp:229\n17 \txul.dll \tnsAppStartup::Run \ttoolkit/components/startup/nsAppStartup.cpp:290\n18 \txul.dll \tXREMain::XRE_mainRun \ttoolkit/xre/nsAppRunner.cpp:3823\n19 \txul.dll \tXREMain::XRE_main \ttoolkit/xre/nsAppRunner.cpp:3890\n20 \txul.dll \tXRE_main \ttoolkit/xre/nsAppRunner.cpp:4084\n21 \tfirefox.exe \twmain \ttoolkit/xre/nsWindowsWMain.cpp:105\n22 \tfirefox.exe \t__tmainCRTStartup \tcrtexe.c:552\n23 \tkernel32.dll \tBaseThreadInitThunk \t\n24 \tntdll.dll \t__RtlUserThreadStart \t\n25 \tntdll.dll \t_RtlUserThreadStart"},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2012-12-01T23:32:30Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"Excellent! I'm able to reproduce on Windows. Setting OS to \"Windows 7\" even though it also happens on XP.","id":6871816,"creation_time":"2012-12-01T23:32:30Z","raw_text":"Excellent! I'm able to reproduce on Windows. Setting OS to \"Windows 7\" even though it also happens on XP."},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2012-12-05T01:15:15Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"I could have sworn I tried this earlier in a debug build, but I guess I forgot. Anyway, this trips a compartment assertion in a Linux debug build for me. It seems to have something to do with the document's JS wrapper not having the same global as the window. It also nearly trips this assertion in nsDocument::SetScriptGlobalObject:\n\n              NS_ASSERTION(JS_GetGlobalForObject(cx, obj) == newScope,\n                           \"Wrong scope, this is really bad!\");\n\nHowever, the call to JS_GetGlobalForObject dies first because cx->compartment != obj->compartment().\n\nCould a DOM person please look into this?","id":6881648,"creation_time":"2012-12-05T01:15:15Z","raw_text":"I could have sworn I tried this earlier in a debug build, but I guess I forgot. Anyway, this trips a compartment assertion in a Linux debug build for me. It seems to have something to do with the document's JS wrapper not having the same global as the window. It also nearly trips this assertion in nsDocument::SetScriptGlobalObject:\n\n              NS_ASSERTION(JS_GetGlobalForObject(cx, obj) == newScope,\n                           \"Wrong scope, this is really bad!\");\n\nHowever, the call to JS_GetGlobalForObject dies first because cx->compartment != obj->compartment().\n\nCould a DOM person please look into this?"},{"is_private":false,"attachment_id":688528,"creator":"wmccloskey@mozilla.com","time":"2012-12-05T01:16:33Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"Created attachment 688528\nstack trace of assertion\n\nHere's a stack trace of the assertion. It might have something to do with printing.","id":6881653,"creation_time":"2012-12-05T01:16:33Z","raw_text":"Here's a stack trace of the assertion. It might have something to do with printing."},{"is_private":false,"attachment_id":null,"creator":"bzbarsky@mit.edu","time":"2012-12-05T02:07:35Z","author":"bzbarsky@mit.edu","bug_id":817342,"tags":[],"text":"So in this case we have:\n\n1)  The document has a wrapper.\n2)  The JSContext of the new global is not same-compartment with that wrapper.\n3)  In either case, the global of the document's wrapper is not the new global.\n\nPresumably the context compartment either matches the new global or matches whatever script is running on that context...","id":6881837,"creation_time":"2012-12-05T02:07:35Z","raw_text":"So in this case we have:\n\n1)  The document has a wrapper.\n2)  The JSContext of the new global is not same-compartment with that wrapper.\n3)  In either case, the global of the document's wrapper is not the new global.\n\nPresumably the context compartment either matches the new global or matches whatever script is running on that context..."},{"is_private":false,"attachment_id":null,"creator":"dveditz@mozilla.com","time":"2012-12-05T18:46:38Z","author":"dveditz@mozilla.com","bug_id":817342,"tags":[],"text":"This could potentially be due to bugs in the addons themselves, maybe moving objects between compartments when they shouldn't.","id":6884470,"creation_time":"2012-12-05T18:46:38Z","raw_text":"This could potentially be due to bugs in the addons themselves, maybe moving objects between compartments when they shouldn't."},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2012-12-05T20:57:08Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"(In reply to Daniel Veditz [:dveditz] from comment #5)\n> This could potentially be due to bugs in the addons themselves, maybe moving\n> objects between compartments when they shouldn't.\n\nThese addons don't have any binary components. And stuff written in JS is supposed to be safe against compartment mismatches. So I think it's our bug.","id":6885192,"creation_time":"2012-12-05T20:57:08Z","raw_text":"(In reply to Daniel Veditz [:dveditz] from comment #5)\n> This could potentially be due to bugs in the addons themselves, maybe moving\n> objects between compartments when they shouldn't.\n\nThese addons don't have any binary components. And stuff written in JS is supposed to be safe against compartment mismatches. So I think it's our bug."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2012-12-05T21:55:04Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"If nobody else is looking at this, I can try to take a look.","id":6885471,"creation_time":"2012-12-05T21:55:04Z","raw_text":"If nobody else is looking at this, I can try to take a look."},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2012-12-05T22:34:18Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"Go for it. It would be great to get this fixed.","id":6885688,"creation_time":"2012-12-05T22:34:18Z","raw_text":"Go for it. It would be great to get this fixed."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2012-12-14T01:24:29Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"In addition to Print Edit, doing Print Preview or even just Print seem to cause the same problem.\n\nThe Print Edit addon doesn't even seem to be needed. With just Redirector enabled, using the standard \"print\" command on the default homepage causes the same problem. Disabling the addon causes the problem to go away.","id":6913237,"creation_time":"2012-12-14T01:24:29Z","raw_text":"In addition to Print Edit, doing Print Preview or even just Print seem to cause the same problem.\n\nThe Print Edit addon doesn't even seem to be needed. With just Redirector enabled, using the standard \"print\" command on the default homepage causes the same problem. Disabling the addon causes the problem to go away."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2012-12-14T01:30:38Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Also, the STR for the crash indicates that it takes a few seconds (suggesting that it needs to wait for a GC to run), but the assertion happens immediately. It might be useful to see if this trips the assert before the above regression range where the crash starts happening.","id":6913257,"creation_time":"2012-12-14T01:30:38Z","raw_text":"Also, the STR for the crash indicates that it takes a few seconds (suggesting that it needs to wait for a GC to run), but the assertion happens immediately. It might be useful to see if this trips the assert before the above regression range where the crash starts happening."},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2012-12-14T01:35:54Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"(In reply to Andrew McCreight [:mccr8] from comment #10)\n> Also, the STR for the crash indicates that it takes a few seconds\n> (suggesting that it needs to wait for a GC to run), but the assertion\n> happens immediately. It might be useful to see if this trips the assert\n> before the above regression range where the crash starts happening.\n\nI'm reasonably certain that this has been a problem forever. If that's not true, please assign it back to me.","id":6913281,"creation_time":"2012-12-14T01:35:54Z","raw_text":"(In reply to Andrew McCreight [:mccr8] from comment #10)\n> Also, the STR for the crash indicates that it takes a few seconds\n> (suggesting that it needs to wait for a GC to run), but the assertion\n> happens immediately. It might be useful to see if this trips the assert\n> before the above regression range where the crash starts happening.\n\nI'm reasonably certain that this has been a problem forever. If that's not true, please assign it back to me."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2012-12-17T20:51:13Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Olli, could you take a look at this? It looks like it is a problem in printing code, and you are more familiar with it than me.","id":6922204,"creation_time":"2012-12-17T20:51:13Z","raw_text":"Olli, could you take a look at this? It looks like it is a problem in printing code, and you are more familiar with it than me."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2012-12-29T16:42:17Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Will look at this next week. Sorry about the delay.","id":6951354,"creation_time":"2012-12-29T16:42:17Z","raw_text":"Will look at this next week. Sorry about the delay."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-05T00:04:33Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Ghostery also seems to cause the same problem.","id":6965566,"creation_time":"2013-01-05T00:04:33Z","raw_text":"Ghostery also seems to cause the same problem."},{"is_private":false,"attachment_id":null,"creator":"dholbert@mozilla.com","time":"2013-01-05T00:10:33Z","author":"dholbert@mozilla.com","bug_id":817342,"tags":[],"text":"Yup, bug 825380 is filed on that (but is probably a dupe of this).","id":6965594,"creation_time":"2013-01-05T00:10:33Z","raw_text":"Yup, bug 825380 is filed on that (but is probably a dupe of this)."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-09T19:45:28Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"So we end up running script runners for <link> for example and content policy touches document which\ndoesn't have script global object yet. Printing is pretty unique here, because of its cloning.\nPatch coming.","id":6981353,"creation_time":"2013-01-09T19:45:28Z","raw_text":"So we end up running script runners for <link> for example and content policy touches document which\ndoesn't have script global object yet. Printing is pretty unique here, because of its cloning.\nPatch coming."},{"is_private":false,"attachment_id":700019,"creator":"bugs@pettay.fi","time":"2013-01-09T21:00:21Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Created attachment 700019\n-w","id":6981689,"creation_time":"2013-01-09T21:00:21Z","raw_text":""},{"is_private":false,"attachment_id":700022,"creator":"bugs@pettay.fi","time":"2013-01-09T21:04:56Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Created attachment 700022\npatch\n\nMake sure we don't run things which might cause content policy checks etc\nbefore the documents have their script globals set.\n\nIt would be nice to have script blocker for longer time, but unfortunately\nprinting related dialogs require scripts to run.\nThough, it is only chrome scripts which can access documents, so running \nscripts isn't that bad.","id":6981703,"creation_time":"2013-01-09T21:04:56Z","raw_text":"Make sure we don't run things which might cause content policy checks etc\nbefore the documents have their script globals set.\n\nIt would be nice to have script blocker for longer time, but unfortunately\nprinting related dialogs require scripts to run.\nThough, it is only chrome scripts which can access documents, so running \nscripts isn't that bad."},{"is_private":false,"attachment_id":700022,"creator":"bugs@pettay.fi","time":"2013-01-09T21:37:05Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Comment on attachment 700022\npatch\n\n[Security approval request comment]\nHow easily could an exploit be constructed based on the patch?\nNot easy, and as far as I see it requires some chrome js (like addons).\n\nDo comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?\nComment will be about delaying script runners in order to run them all at the same time.\nKind of vague. Nothing about compartments though.\n\nWhich older supported branches are affected by this flaw?\nAll\n\nDo you have backports for the affected branches? If not, how different, hard to create, and risky will they be?\nThe same patch should applies everywhere\n\nHow likely is this patch to cause regressions; how much testing does it need?\nChanges to printing are always a bit regression risky since we don't have good tests (because for many\nthings we just don't have the testing framework which could handle such tests).","id":6981830,"creation_time":"2013-01-09T21:37:05Z","raw_text":"[Security approval request comment]\nHow easily could an exploit be constructed based on the patch?\nNot easy, and as far as I see it requires some chrome js (like addons).\n\nDo comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?\nComment will be about delaying script runners in order to run them all at the same time.\nKind of vague. Nothing about compartments though.\n\nWhich older supported branches are affected by this flaw?\nAll\n\nDo you have backports for the affected branches? If not, how different, hard to create, and risky will they be?\nThe same patch should applies everywhere\n\nHow likely is this patch to cause regressions; how much testing does it need?\nChanges to printing are always a bit regression risky since we don't have good tests (because for many\nthings we just don't have the testing framework which could handle such tests)."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-09T21:44:00Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"*** Bug 825401 has been marked as a duplicate of this bug. ***","id":6981868,"creation_time":"2013-01-09T21:44:00Z","raw_text":""},{"is_private":false,"attachment_id":700022,"creator":"bugs@pettay.fi","time":"2013-01-09T22:15:45Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Comment on attachment 700022\npatch\n\nPer https://wiki.mozilla.org/Security/Bug_Approval_Process this shouldn't\nneed approval.\n\nI'll land tomorrow.","id":6982045,"creation_time":"2013-01-09T22:15:45Z","raw_text":"Per https://wiki.mozilla.org/Security/Bug_Approval_Process this shouldn't\nneed approval.\n\nI'll land tomorrow."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-09T22:27:13Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"https://tbpl.mozilla.org/?tree=Try&rev=7a5d8e164707","id":6982125,"creation_time":"2013-01-09T22:27:13Z","raw_text":"https://tbpl.mozilla.org/?tree=Try&rev=7a5d8e164707"},{"is_private":false,"attachment_id":700022,"creator":"continuation@gmail.com","time":"2013-01-09T22:47:12Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Comment on attachment 700022\npatch\n\nOlli cleared the wrong flag. Carrying forward roc's r+.","id":6982237,"creation_time":"2013-01-09T22:47:12Z","raw_text":"Olli cleared the wrong flag. Carrying forward roc's r+."},{"is_private":false,"attachment_id":null,"creator":"abillings@mozilla.com","time":"2013-01-09T22:49:01Z","author":"abillings@mozilla.com","bug_id":817342,"tags":[],"text":"(In reply to Olli Pettay [:smaug] from comment #21)\n> Comment on attachment 700022\n> patch\n> \n> Per https://wiki.mozilla.org/Security/Bug_Approval_Process this shouldn't\n> need approval.\n\nThat's right.","id":6982246,"creation_time":"2013-01-09T22:49:01Z","raw_text":"(In reply to Olli Pettay [:smaug] from comment #21)\n> Comment on attachment 700022\n> patch\n> \n> Per https://wiki.mozilla.org/Security/Bug_Approval_Process this shouldn't\n> need approval.\n\nThat's right."},{"is_private":false,"attachment_id":null,"creator":"kairo@kairo.at","time":"2013-01-10T01:08:45Z","author":"kairo@kairo.at","bug_id":817342,"tags":[],"text":"https://crash-stats.mozilla.com/report/list?signature=js%3A%3AGCMarker%3A%3AprocessMarkStackTop%28js%3A%3ASliceBudget%26%29 is a top crash across all our somewhat recent versions, what amount of those crashes do you think this patch should fix? If a major part, we should consider to uplift this to as many versions as possible.","id":6982891,"creation_time":"2013-01-10T01:08:45Z","raw_text":"https://crash-stats.mozilla.com/report/list?signature=js%3A%3AGCMarker%3A%3AprocessMarkStackTop%28js%3A%3ASliceBudget%26%29 is a top crash across all our somewhat recent versions, what amount of those crashes do you think this patch should fix? If a major part, we should consider to uplift this to as many versions as possible."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-10T01:24:11Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"It is difficult to say, as that is a generic stack we hit any time there is any kind of GC-related problem. This patch only affects people trying to do print-preview with certain addons (Redirector, Ghostery, probably others).\n\nIn Nightly, my theory is that these errors are bucketed somewhere else due to additional runtime checks (js::CompartmentChecker::fail), so if we look at the Nightly 20 numbers, we see that 1.37% of crashes have the compartment checker assertion, and 1.14% have the processMarkStackTop stack.\n\nIf we look at Aurora 19, we see that 3.19% of crashes are processMarkStackTop, which happens to be in the ballpark of 1.37+1.14. Thus, very optimistically, we could say we might get rid of half of them.\n\nOn the other hand, I would guess these kinds of addons are much rarer beyond Nightly and Aurora, and thus this patch may have little overall effect. It may also be the case that this problem doesn't result in crashes all the time without the assertion, so we are overestimating the % that seem print preview related, and thus landing this fix will not help nearly so much.\n\nAnother way to get an estimate would be to see what % of processMarkStackTop crashes have Ghostery or this Redirector thing, compared to the over all number. If the corrrelation is high, that suggests a decent number could also be print preview related, and thus fixed by this bug.","id":6982949,"creation_time":"2013-01-10T01:24:11Z","raw_text":"It is difficult to say, as that is a generic stack we hit any time there is any kind of GC-related problem. This patch only affects people trying to do print-preview with certain addons (Redirector, Ghostery, probably others).\n\nIn Nightly, my theory is that these errors are bucketed somewhere else due to additional runtime checks (js::CompartmentChecker::fail), so if we look at the Nightly 20 numbers, we see that 1.37% of crashes have the compartment checker assertion, and 1.14% have the processMarkStackTop stack.\n\nIf we look at Aurora 19, we see that 3.19% of crashes are processMarkStackTop, which happens to be in the ballpark of 1.37+1.14. Thus, very optimistically, we could say we might get rid of half of them.\n\nOn the other hand, I would guess these kinds of addons are much rarer beyond Nightly and Aurora, and thus this patch may have little overall effect. It may also be the case that this problem doesn't result in crashes all the time without the assertion, so we are overestimating the % that seem print preview related, and thus landing this fix will not help nearly so much.\n\nAnother way to get an estimate would be to see what % of processMarkStackTop crashes have Ghostery or this Redirector thing, compared to the over all number. If the corrrelation is high, that suggests a decent number could also be print preview related, and thus fixed by this bug."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2013-01-10T09:12:21Z","author":"scoobidiver@netcourrier.com","bug_id":817342,"tags":[],"text":"(In reply to Robert Kaiser (:kairo@mozilla.com) from comment #25)\n> If a major part, we should consider to uplift this to as many versions as possible.\nThis bug is a regression in Firefox 20 (see comment 0 and tracking flags) so it should be uplifted only in Aurora.","id":6983775,"creation_time":"2013-01-10T09:12:21Z","raw_text":"(In reply to Robert Kaiser (:kairo@mozilla.com) from comment #25)\n> If a major part, we should consider to uplift this to as many versions as possible.\nThis bug is a regression in Firefox 20 (see comment 0 and tracking flags) so it should be uplifted only in Aurora."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-10T10:45:59Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"https://hg.mozilla.org/mozilla-central/rev/5a74a94f6d44","id":6984146,"creation_time":"2013-01-10T10:45:59Z","raw_text":"https://hg.mozilla.org/mozilla-central/rev/5a74a94f6d44"},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-10T10:47:03Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"I think we could uplift the patch, but I'd like to wait for few days to get at least tiny\namount testing.","id":6984151,"creation_time":"2013-01-10T10:47:03Z","raw_text":"I think we could uplift the patch, but I'd like to wait for few days to get at least tiny\namount testing."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-10T13:48:46Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Nominating for tracking as a speculative partial fix for a top crash.","id":6984724,"creation_time":"2013-01-10T13:48:46Z","raw_text":"Nominating for tracking as a speculative partial fix for a top crash."},{"is_private":false,"attachment_id":null,"creator":"wmccloskey@mozilla.com","time":"2013-01-10T20:01:24Z","author":"wmccloskey@mozilla.com","bug_id":817342,"tags":[],"text":"(In reply to Scoobidiver from comment #27)\n> (In reply to Robert Kaiser (:kairo@mozilla.com) from comment #25)\n> > If a major part, we should consider to uplift this to as many versions as possible.\n> This bug is a regression in Firefox 20 (see comment 0 and tracking flags) so\n> it should be uplifted only in Aurora.\n\nThat's not exactly true. This particular test case only reproduces in FF20. However, as far as I know the bug has been present since long before that. It just didn't reproduce in this circumstance until bug 790338. I think we should uplift everywhere we can, although it's up to Olli to evaluate the risk of that.","id":6986756,"creation_time":"2013-01-10T20:01:24Z","raw_text":"(In reply to Scoobidiver from comment #27)\n> (In reply to Robert Kaiser (:kairo@mozilla.com) from comment #25)\n> > If a major part, we should consider to uplift this to as many versions as possible.\n> This bug is a regression in Firefox 20 (see comment 0 and tracking flags) so\n> it should be uplifted only in Aurora.\n\nThat's not exactly true. This particular test case only reproduces in FF20. However, as far as I know the bug has been present since long before that. It just didn't reproduce in this circumstance until bug 790338. I think we should uplift everywhere we can, although it's up to Olli to evaluate the risk of that."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-10T20:26:36Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"This needs some testing. Manual testing I'm afraid.\nUnfortunately printing is so rarely used feature nowadays that regression bugs may be filed\nmonths after fixing the bug.","id":6986894,"creation_time":"2013-01-10T20:26:36Z","raw_text":"This needs some testing. Manual testing I'm afraid.\nUnfortunately printing is so rarely used feature nowadays that regression bugs may be filed\nmonths after fixing the bug."},{"is_private":false,"attachment_id":null,"creator":"anthony.s.hughes@gmail.com","time":"2013-01-10T21:23:15Z","author":"anthony.s.hughes@gmail.com","bug_id":817342,"tags":[],"text":"(In reply to Olli Pettay [:smaug] from comment #32)\n> This needs some testing. Manual testing I'm afraid.\n> Unfortunately printing is so rarely used feature nowadays that regression\n> bugs may be filed\n> months after fixing the bug.\n\nAdding qawanted to fulfil this request. I've talked with Olli via IRC about this and we agreed to getting some broad, generic print testing using the Softvision team. I'll coordinate this testing and try to report back any results in the next week.","id":6987179,"creation_time":"2013-01-10T21:23:15Z","raw_text":"(In reply to Olli Pettay [:smaug] from comment #32)\n> This needs some testing. Manual testing I'm afraid.\n> Unfortunately printing is so rarely used feature nowadays that regression\n> bugs may be filed\n> months after fixing the bug.\n\nAdding qawanted to fulfil this request. I've talked with Olli via IRC about this and we agreed to getting some broad, generic print testing using the Softvision team. I'll coordinate this testing and try to report back any results in the next week."},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-14T19:20:12Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"*** Bug 821842 has been marked as a duplicate of this bug. ***","id":6999220,"creation_time":"2013-01-14T19:20:12Z","raw_text":""},{"is_private":false,"attachment_id":null,"creator":"anthony.s.hughes@gmail.com","time":"2013-01-18T17:30:43Z","author":"anthony.s.hughes@gmail.com","bug_id":817342,"tags":[],"text":"The print testing has been completed and is currently stored on a protected Google Doc. Olli, I'm working on getting the doc shared with you so you can view the raw results. If you have no questions or concerns with the results I will try to post a distilled version in this and related bugs.","id":7016979,"creation_time":"2013-01-18T17:30:43Z","raw_text":"The print testing has been completed and is currently stored on a protected Google Doc. Olli, I'm working on getting the doc shared with you so you can view the raw results. If you have no questions or concerns with the results I will try to post a distilled version in this and related bugs."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2013-01-22T16:40:53Z","author":"scoobidiver@netcourrier.com","bug_id":817342,"tags":[],"text":"*** Bug 832287 has been marked as a duplicate of this bug. ***","id":7025794,"creation_time":"2013-01-22T16:40:53Z","raw_text":""},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-22T16:48:15Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"So I didn't see any regressions based on that doc. Anthony, could you verify (once you're back).","id":7025819,"creation_time":"2013-01-22T16:48:15Z","raw_text":"So I didn't see any regressions based on that doc. Anthony, could you verify (once you're back)."},{"is_private":false,"attachment_id":700022,"creator":"bugs@pettay.fi","time":"2013-01-22T17:26:43Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"Comment on attachment 700022\npatch\n\n[Approval Request Comment]\nBug caused by (feature/regressing bug #): bug 487667 and compartments\nUser impact if declined: Crashes\nTesting completed (on m-c, etc.): Landed m-c 2013-01-10 and see comment 33 and comment 35\nRisk to taking this patch (and alternatives if risky): Tiny bit risky, since\nscript runners end up running later\nString or UUID changes made by this patch: NA","id":7026026,"creation_time":"2013-01-22T17:26:43Z","raw_text":"[Approval Request Comment]\nBug caused by (feature/regressing bug #): bug 487667 and compartments\nUser impact if declined: Crashes\nTesting completed (on m-c, etc.): Landed m-c 2013-01-10 and see comment 33 and comment 35\nRisk to taking this patch (and alternatives if risky): Tiny bit risky, since\nscript runners end up running later\nString or UUID changes made by this patch: NA"},{"is_private":false,"attachment_id":null,"creator":"continuation@gmail.com","time":"2013-01-22T17:31:51Z","author":"continuation@gmail.com","bug_id":817342,"tags":[],"text":"Release mode assertions that this patch fixes are something like 3% of all crashes on Aurora.  Every time somebody with one of a wide variety of addons tries to do print preview, they hit this assertion.  The assertion is disabled in beta and later, but at least some of these will turn into real crashes.","id":7026052,"creation_time":"2013-01-22T17:31:51Z","raw_text":"Release mode assertions that this patch fixes are something like 3% of all crashes on Aurora.  Every time somebody with one of a wide variety of addons tries to do print preview, they hit this assertion.  The assertion is disabled in beta and later, but at least some of these will turn into real crashes."},{"is_private":false,"attachment_id":700022,"creator":"lukasblakk+bugs@gmail.com","time":"2013-01-24T00:03:32Z","author":"lukasblakk+bugs@gmail.com","bug_id":817342,"tags":[],"text":"Comment on attachment 700022\npatch\n\nWilling to take the risk on Aurora since this might help with some topcrashers and qa should continue to verify as well as watch for regressions since we'll have time to backout if the payoff isn't what we hoped here.","id":7032459,"creation_time":"2013-01-24T00:03:32Z","raw_text":"Willing to take the risk on Aurora since this might help with some topcrashers and qa should continue to verify as well as watch for regressions since we'll have time to backout if the payoff isn't what we hoped here."},{"is_private":false,"attachment_id":null,"creator":"bugs@pettay.fi","time":"2013-01-24T09:27:43Z","author":"bugs@pettay.fi","bug_id":817342,"tags":[],"text":"https://hg.mozilla.org/releases/mozilla-aurora/rev/0abbd04b2dc9","id":7033634,"creation_time":"2013-01-24T09:27:43Z","raw_text":"https://hg.mozilla.org/releases/mozilla-aurora/rev/0abbd04b2dc9"},{"is_private":false,"attachment_id":null,"creator":"anthony.s.hughes@gmail.com","time":"2013-02-01T00:28:20Z","author":"anthony.s.hughes@gmail.com","bug_id":817342,"tags":[],"text":"(In reply to Olli Pettay [:smaug] from comment #37)\n> So I didn't see any regressions based on that doc. Anthony, could you verify\n> (once you're back).\n\nI confirm that the testing found no regressions.","id":7060023,"creation_time":"2013-02-01T00:28:20Z","raw_text":"(In reply to Olli Pettay [:smaug] from comment #37)\n> So I didn't see any regressions based on that doc. Anthony, could you verify\n> (once you're back).\n\nI confirm that the testing found no regressions."}]}},"comments":{}}