{"bugs":{"787818":{"comments":[{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-02T17:43:43Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"It's a low volume crash in 15.0, but much higher in 17.0a2 where it's #14 top browser crasher.\n\nSignature \tnsMenuPopupFrame::HidePopup(bool, nsPopupState) More Reports Search\nUUID\tc1acceb4-a6e9-444f-a5bb-f936b2120902\nDate Processed\t2012-09-02 17:20:07\nUptime\t735\nInstall Age\t1.3 hours since version was first installed.\nInstall Time\t2012-09-02 16:04:00\nProduct\tFirefox\nVersion\t17.0a2\nBuild ID\t20120901042009\nRelease Channel\taurora\nOS\tWindows NT\nOS Version\t5.1.2600 Dodatek Service Pack 3\nBuild Architecture\tx86\nBuild Architecture Info\tAuthenticAMD family 16 model 4 stepping 2\nCrash Reason\tEXCEPTION_ACCESS_VIOLATION_EXEC\nCrash Address\t0x616e616d\nApp Notes \t\nAdapterVendorID: 0x1002, AdapterDeviceID: 0x9442, AdapterSubsysID: 040110b0, AdapterDriverVersion: 8.970.100.3000\nD3D10 Layers? D3D10 Layers- D3D9 Layers? D3D9 Layers+ \nEMCheckCompatibility\tTrue\nAdapter Vendor ID\t0x1002\nAdapter Device ID\t0x9442\nTotal Virtual Memory\t2147352576\nAvailable Virtual Memory\t1833201664\nSystem Memory Use Percentage\t21\nAvailable Page File\t4861616128\nAvailable Physical Memory\t2730385408\n\nFrame \tModule \tSignature \tSource\n0 \t\t@0x616e616d \t\n1 \txul.dll \tnsMenuPopupFrame::HidePopup \tlayout/xul/base/src/nsMenuPopupFrame.cpp:795\n2 \txul.dll \tnsXULPopupManager::HidePopupCallback \tlayout/xul/base/src/nsXULPopupManager.cpp:879\n3 \txul.dll \tnsXULPopupManager::FirePopupHidingEvent \tlayout/xul/base/src/nsXULPopupManager.cpp:1231\n4 \txul.dll \tnsXULElement::AddRef \tcontent/xul/content/src/nsXULElement.cpp:312\n5 \tmozjs.dll \tJS_GetFrameFunctionObject \tjs/src/jsdbgapi.cpp:597\n6 \txul.dll \tnsPopupBoxObject::HidePopup \tlayout/xul/base/src/nsPopupBoxObject.cpp:49\n7 \txul.dll \tNS_InvokeByIndex_P \txpcom/reflect/xptcall/src/md/win32/xptcinvoke.cpp:70\n8 \txul.dll \tXPCNativeMember::Resolve \tjs/xpconnect/src/XPCWrappedNativeInfo.cpp:102\n9 \txul.dll \tnsXPConnect::GetXPConnect \tjs/xpconnect/src/nsXPConnect.cpp:139\n10 \txul.dll \tXPCWrappedNative::GetAttribute \tjs/xpconnect/src/xpcprivate.h:2822\n11 \tgkmedias.dll \tdefine_gf_group \tmedia/libvpx/vp8/encoder/firstpass.c:1800\n\nMore reports at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsMenuPopupFrame%3A%3AHidePopup%28bool%2C+nsPopupState%29","id":6604236,"creation_time":"2012-09-02T17:43:43Z","raw_text":"It's a low volume crash in 15.0, but much higher in 17.0a2 where it's #14 top browser crasher.\n\nSignature \tnsMenuPopupFrame::HidePopup(bool, nsPopupState) More Reports Search\nUUID\tc1acceb4-a6e9-444f-a5bb-f936b2120902\nDate Processed\t2012-09-02 17:20:07\nUptime\t735\nInstall Age\t1.3 hours since version was first installed.\nInstall Time\t2012-09-02 16:04:00\nProduct\tFirefox\nVersion\t17.0a2\nBuild ID\t20120901042009\nRelease Channel\taurora\nOS\tWindows NT\nOS Version\t5.1.2600 Dodatek Service Pack 3\nBuild Architecture\tx86\nBuild Architecture Info\tAuthenticAMD family 16 model 4 stepping 2\nCrash Reason\tEXCEPTION_ACCESS_VIOLATION_EXEC\nCrash Address\t0x616e616d\nApp Notes \t\nAdapterVendorID: 0x1002, AdapterDeviceID: 0x9442, AdapterSubsysID: 040110b0, AdapterDriverVersion: 8.970.100.3000\nD3D10 Layers? D3D10 Layers- D3D9 Layers? D3D9 Layers+ \nEMCheckCompatibility\tTrue\nAdapter Vendor ID\t0x1002\nAdapter Device ID\t0x9442\nTotal Virtual Memory\t2147352576\nAvailable Virtual Memory\t1833201664\nSystem Memory Use Percentage\t21\nAvailable Page File\t4861616128\nAvailable Physical Memory\t2730385408\n\nFrame \tModule \tSignature \tSource\n0 \t\t@0x616e616d \t\n1 \txul.dll \tnsMenuPopupFrame::HidePopup \tlayout/xul/base/src/nsMenuPopupFrame.cpp:795\n2 \txul.dll \tnsXULPopupManager::HidePopupCallback \tlayout/xul/base/src/nsXULPopupManager.cpp:879\n3 \txul.dll \tnsXULPopupManager::FirePopupHidingEvent \tlayout/xul/base/src/nsXULPopupManager.cpp:1231\n4 \txul.dll \tnsXULElement::AddRef \tcontent/xul/content/src/nsXULElement.cpp:312\n5 \tmozjs.dll \tJS_GetFrameFunctionObject \tjs/src/jsdbgapi.cpp:597\n6 \txul.dll \tnsPopupBoxObject::HidePopup \tlayout/xul/base/src/nsPopupBoxObject.cpp:49\n7 \txul.dll \tNS_InvokeByIndex_P \txpcom/reflect/xptcall/src/md/win32/xptcinvoke.cpp:70\n8 \txul.dll \tXPCNativeMember::Resolve \tjs/xpconnect/src/XPCWrappedNativeInfo.cpp:102\n9 \txul.dll \tnsXPConnect::GetXPConnect \tjs/xpconnect/src/nsXPConnect.cpp:139\n10 \txul.dll \tXPCWrappedNative::GetAttribute \tjs/xpconnect/src/xpcprivate.h:2822\n11 \tgkmedias.dll \tdefine_gf_group \tmedia/libvpx/vp8/encoder/firstpass.c:1800\n\nMore reports at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsMenuPopupFrame%3A%3AHidePopup%28bool%2C+nsPopupState%29"},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-02T17:46:58Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"More reports also at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsView%3A%3ANotifyEffectiveVisibilityChanged%28bool%29\n\nWith combined signatures, it's even #8 top browser crasher in 17.0a2.","id":6604240,"creation_time":"2012-09-02T17:46:58Z","raw_text":"More reports also at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsView%3A%3ANotifyEffectiveVisibilityChanged%28bool%29\n\nWith combined signatures, it's even #8 top browser crasher in 17.0a2."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-02T18:40:53Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"795: viewManager->ResizeView(view, nsRect(0, 0, 0, 0));\n\nFwiw, bug 786421 removed that particular line a few days ago.","id":6604271,"creation_time":"2012-09-02T18:40:53Z","raw_text":"795: viewManager->ResizeView(view, nsRect(0, 0, 0, 0));\n\nFwiw, bug 786421 removed that particular line a few days ago."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-02T19:38:17Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #2)\n> 795: viewManager->ResizeView(view, nsRect(0, 0, 0, 0));\n> \n> Fwiw, bug 786421 removed that particular line a few days ago.\n\nThe set of crashes in comment 1 crash on the line just before, so removing that line doesn't seem to help us here. Looks like the view manager pointer is invalid?","id":6604293,"creation_time":"2012-09-02T19:38:17Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #2)\n> 795: viewManager->ResizeView(view, nsRect(0, 0, 0, 0));\n> \n> Fwiw, bug 786421 removed that particular line a few days ago.\n\nThe set of crashes in comment 1 crash on the line just before, so removing that line doesn't seem to help us here. Looks like the view manager pointer is invalid?"},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-02T22:03:51Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"I clicked through 20 or so crashes and I didn't see one that is on the\nline before.  There seems to be two sets of crashes:\n\nThe first set is on the \"viewManager->ResizeView\" line, these usually have\na crash addresses NOT near zero: 0x616e616d, 0x857cd43, 0x4bdaac2, 0x6f7365b6\nMost of these are for 17.0a2:\nbp-9a5aac85-2c13-486c-846e-59e262120830\nbp-52df2bba-e295-48f1-b9bd-4b8d92120901\n\nThe second set crash one or two lines after ResizeView:\n  FireDOMEvent(NS_LITERAL_STRING(\"DOMMenuInactive\"), mContent);\nor\n  nsEventStates state = mContent->AsElement()->State();\nand usually have a crash address near zero: 0x15, 0x30, 0x4\nbp-ccfcbc57-239b-4816-9d67-b45c82120830\nbp-6582bb5e-fb27-40be-b8b0-4dfcb2120828\nMost of these are for 15.0 or older.\n\nIf the viewManager/view is bogus already in HidePopup I would expect the\nfirst set to crash on the SetViewVisibility call.  So, could it be the\nResizeView call that leads up to a layout flush?","id":6604380,"creation_time":"2012-09-02T22:03:51Z","raw_text":"I clicked through 20 or so crashes and I didn't see one that is on the\nline before.  There seems to be two sets of crashes:\n\nThe first set is on the \"viewManager->ResizeView\" line, these usually have\na crash addresses NOT near zero: 0x616e616d, 0x857cd43, 0x4bdaac2, 0x6f7365b6\nMost of these are for 17.0a2:\nbp-9a5aac85-2c13-486c-846e-59e262120830\nbp-52df2bba-e295-48f1-b9bd-4b8d92120901\n\nThe second set crash one or two lines after ResizeView:\n  FireDOMEvent(NS_LITERAL_STRING(\"DOMMenuInactive\"), mContent);\nor\n  nsEventStates state = mContent->AsElement()->State();\nand usually have a crash address near zero: 0x15, 0x30, 0x4\nbp-ccfcbc57-239b-4816-9d67-b45c82120830\nbp-6582bb5e-fb27-40be-b8b0-4dfcb2120828\nMost of these are for 15.0 or older.\n\nIf the viewManager/view is bogus already in HidePopup I would expect the\nfirst set to crash on the SetViewVisibility call.  So, could it be the\nResizeView call that leads up to a layout flush?"},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-02T22:08:36Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"Ah, now I see that you said comment 1.  (I looked at the set in comment 0).\nRight, so there's a third set.  Seems like there could be more than one bug\nhere.","id":6604387,"creation_time":"2012-09-02T22:08:36Z","raw_text":"Ah, now I see that you said comment 1.  (I looked at the set in comment 0).\nRight, so there's a third set.  Seems like there could be more than one bug\nhere."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-03T06:44:57Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #4)\n> bp-ccfcbc57-239b-4816-9d67-b45c82120830\n> bp-6582bb5e-fb27-40be-b8b0-4dfcb2120828\n> Most of these are for 15.0 or older.\nThose crashes are fixed in 16.0 and above, that is why I haven't post their stack traces.\n\nIn addition to those of comment 0 and comment 1, more reports also at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsView%3A%3ADropMouseGrabbing%28%29","id":6604826,"creation_time":"2012-09-03T06:44:57Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #4)\n> bp-ccfcbc57-239b-4816-9d67-b45c82120830\n> bp-6582bb5e-fb27-40be-b8b0-4dfcb2120828\n> Most of these are for 15.0 or older.\nThose crashes are fixed in 16.0 and above, that is why I haven't post their stack traces.\n\nIn addition to those of comment 0 and comment 1, more reports also at:\nhttps://crash-stats.mozilla.com/report/list?signature=nsView%3A%3ADropMouseGrabbing%28%29"},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-03T14:31:06Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"Hiding this bug since I don't want to speculate about causes in the public...","id":6605390,"creation_time":"2012-09-03T14:31:06Z","raw_text":"Hiding this bug since I don't want to speculate about causes in the public..."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-03T14:45:48Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"There's a few nsEventDispatcher::Dispatch calls in nsXULPopupManager.cpp, e.g.\nhttp://mxr.mozilla.org/mozilla-central/source/layout/xul/base/src/nsXULPopupManager.cpp#1198\nI think we need to check that all objects we touch are still alive after those.\nAfter the one in FirePopupHidingEvent, presShell->IsDestroying() could be\ntrue, which could be the cause of the bad View/ViewManager.","id":6605417,"creation_time":"2012-09-03T14:45:48Z","raw_text":"There's a few nsEventDispatcher::Dispatch calls in nsXULPopupManager.cpp, e.g.\nhttp://mxr.mozilla.org/mozilla-central/source/layout/xul/base/src/nsXULPopupManager.cpp#1198\nI think we need to check that all objects we touch are still alive after those.\nAfter the one in FirePopupHidingEvent, presShell->IsDestroying() could be\ntrue, which could be the cause of the bad View/ViewManager."},{"is_private":false,"attachment_id":658151,"creator":"tnikkel@gmail.com","time":"2012-09-04T18:00:21Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Created attachment 658151\nweakframe check\n\nSo I checked all frames and content nodes and I think this is the only possibly bad use of a frame and I think all content nodes have nsCOMPtr's holding onto them (possibly in the calling function, which isn't ideal).\n\nDo you think we also need to check if the presshell is destroying after unsafe calls?","id":6608031,"creation_time":"2012-09-04T18:00:21Z","raw_text":"So I checked all frames and content nodes and I think this is the only possibly bad use of a frame and I think all content nodes have nsCOMPtr's holding onto them (possibly in the calling function, which isn't ideal).\n\nDo you think we also need to check if the presshell is destroying after unsafe calls?"},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-04T19:39:58Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"> So I checked all frames and content nodes and I think this is the only\n> possibly bad use of a frame and I think all content nodes have nsCOMPtr's\n> holding onto them (possibly in the calling function, which isn't ideal).\n\nOK, I'm looking through nsXULPopupManager.cpp and I'm worried that\nnsMenuChainItem::mFrame might be stale.  E.g.\nHidePopupsInList\n  HidePopup\n    FirePopupHidingEvent\n      HidePopupCallback\n        Dispatch\n          * destroys the world *\n* unwind to HidePopupsInList *\n  SetCaptureState(nullptr)\n    item = GetTopVisibleMenu()\n    popup = item->Frame();\n    * popup is destroyed *\n\nAlso applies to calls to item->Content():\nnsIContent* nsMenuChainItem::Content()\n{\n  return mFrame->GetContent();\n}\n\nso we need to check all methods that can reach Dispatch if they use\na nsMenuChainItem after such a call.\n\n> Do you think we also need to check if the presshell is destroying after\n> unsafe calls?\n\nProbably not necessary, PresShell::Destroy nulls out its VM pointer.","id":6608424,"creation_time":"2012-09-04T19:39:58Z","raw_text":"> So I checked all frames and content nodes and I think this is the only\n> possibly bad use of a frame and I think all content nodes have nsCOMPtr's\n> holding onto them (possibly in the calling function, which isn't ideal).\n\nOK, I'm looking through nsXULPopupManager.cpp and I'm worried that\nnsMenuChainItem::mFrame might be stale.  E.g.\nHidePopupsInList\n  HidePopup\n    FirePopupHidingEvent\n      HidePopupCallback\n        Dispatch\n          * destroys the world *\n* unwind to HidePopupsInList *\n  SetCaptureState(nullptr)\n    item = GetTopVisibleMenu()\n    popup = item->Frame();\n    * popup is destroyed *\n\nAlso applies to calls to item->Content():\nnsIContent* nsMenuChainItem::Content()\n{\n  return mFrame->GetContent();\n}\n\nso we need to check all methods that can reach Dispatch if they use\na nsMenuChainItem after such a call.\n\n> Do you think we also need to check if the presshell is destroying after\n> unsafe calls?\n\nProbably not necessary, PresShell::Destroy nulls out its VM pointer."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-04T19:42:37Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #10)\n> OK, I'm looking through nsXULPopupManager.cpp and I'm worried that\n> nsMenuChainItem::mFrame might be stale.  E.g.\n\nAh, good point. I assumed that the lifetime management of those items was not suspect so I didn't give them any scrutiny.","id":6608432,"creation_time":"2012-09-04T19:42:37Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #10)\n> OK, I'm looking through nsXULPopupManager.cpp and I'm worried that\n> nsMenuChainItem::mFrame might be stale.  E.g.\n\nAh, good point. I assumed that the lifetime management of those items was not suspect so I didn't give them any scrutiny."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-04T19:44:48Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"nsIContent* nsXULPopupManager::Rollup(...)\n{\n  nsIContent* lastRolledUpPopup;\n  // ... assign lastRolledUpPopup ...\n  HidePopup() // reach Dispatch\n  return lastRolledUpPopup;\n}\n\nwhat is keeping lastRolledUpPopup alive?","id":6608435,"creation_time":"2012-09-04T19:44:48Z","raw_text":"nsIContent* nsXULPopupManager::Rollup(...)\n{\n  nsIContent* lastRolledUpPopup;\n  // ... assign lastRolledUpPopup ...\n  HidePopup() // reach Dispatch\n  return lastRolledUpPopup;\n}\n\nwhat is keeping lastRolledUpPopup alive?"},{"is_private":false,"attachment_id":658151,"creator":"mats@mozilla.com","time":"2012-09-04T19:50:55Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"Comment on attachment 658151\nweakframe check\n\nThis looks good, and is likely the cause of the crash at hand.\nWe can investigate the other issues separately if you wish.","id":6608453,"creation_time":"2012-09-04T19:50:55Z","raw_text":"This looks good, and is likely the cause of the crash at hand.\nWe can investigate the other issues separately if you wish."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-04T19:59:32Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Thanks for the review. Yeah, I think we should land this clearly correct fix ASAP and then look at the other issues.","id":6608479,"creation_time":"2012-09-04T19:59:32Z","raw_text":"Thanks for the review. Yeah, I think we should land this clearly correct fix ASAP and then look at the other issues."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-04T19:59:52Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"https://hg.mozilla.org/integration/mozilla-inbound/rev/f182ead52cd9","id":6608480,"creation_time":"2012-09-04T19:59:52Z","raw_text":"https://hg.mozilla.org/integration/mozilla-inbound/rev/f182ead52cd9"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-04T20:01:22Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #12)\n> nsIContent* nsXULPopupManager::Rollup(...)\n> {\n>   nsIContent* lastRolledUpPopup;\n>   // ... assign lastRolledUpPopup ...\n>   HidePopup() // reach Dispatch\n>   return lastRolledUpPopup;\n> }\n> \n> what is keeping lastRolledUpPopup alive?\n\nMy somewhat narrow search didn't look at all HidePopup callers so I didn't find this issue.","id":6608483,"creation_time":"2012-09-04T20:01:22Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #12)\n> nsIContent* nsXULPopupManager::Rollup(...)\n> {\n>   nsIContent* lastRolledUpPopup;\n>   // ... assign lastRolledUpPopup ...\n>   HidePopup() // reach Dispatch\n>   return lastRolledUpPopup;\n> }\n> \n> what is keeping lastRolledUpPopup alive?\n\nMy somewhat narrow search didn't look at all HidePopup callers so I didn't find this issue."},{"is_private":false,"attachment_id":658151,"creator":"tnikkel@gmail.com","time":"2012-09-04T20:56:29Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Comment on attachment 658151\nweakframe check\n\nWe don't actually use the weak frame later in this function. So maybe I was too hasty in this patch. Still doesn't hurt anything though.","id":6608667,"creation_time":"2012-09-04T20:56:29Z","raw_text":"We don't actually use the weak frame later in this function. So maybe I was too hasty in this patch. Still doesn't hurt anything though."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-04T21:10:36Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"It guarantees that the pres shell is alive, and more importantly\nthat all its ancestor frames are alive, which are used through\nmPopups later in the method.  (Assuming that a nsMenuChainItem\nancestor also is a frame ancestor).","id":6608733,"creation_time":"2012-09-04T21:10:36Z","raw_text":"It guarantees that the pres shell is alive, and more importantly\nthat all its ancestor frames are alive, which are used through\nmPopups later in the method.  (Assuming that a nsMenuChainItem\nancestor also is a frame ancestor)."},{"is_private":false,"attachment_id":null,"creator":"ryanvm@gmail.com","time":"2012-09-05T01:55:23Z","author":"ryanvm@gmail.com","bug_id":787818,"tags":[],"text":"https://hg.mozilla.org/mozilla-central/rev/f182ead52cd9","id":6609672,"creation_time":"2012-09-05T01:55:23Z","raw_text":"https://hg.mozilla.org/mozilla-central/rev/f182ead52cd9"},{"is_private":false,"attachment_id":null,"creator":"enndeakin@gmail.com","time":"2012-09-05T14:03:59Z","author":"enndeakin@gmail.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #10)\n> > So I checked all frames and content nodes and I think this is the only\n> > possibly bad use of a frame and I think all content nodes have nsCOMPtr's\n> > holding onto them (possibly in the calling function, which isn't ideal).\n> \n> OK, I'm looking through nsXULPopupManager.cpp and I'm worried that\n> nsMenuChainItem::mFrame might be stale.  E.g.\n> HidePopupsInList\n>   HidePopup\n>     FirePopupHidingEvent\n>       HidePopupCallback\n>         Dispatch\n>           * destroys the world *\n> * unwind to HidePopupsInList *\n>   SetCaptureState(nullptr)\n>     item = GetTopVisibleMenu()\n>     popup = item->Frame();\n>     * popup is destroyed *\n> \n\nNote though that the corresponding nsMenuChainItems are removed from the mFrames/mNoHidePanels lists within PopupDestroyed when their frames are destroyed so the call to GetTopVisibleMenu won't iterate over any destroyed items.","id":6610892,"creation_time":"2012-09-05T14:03:59Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #10)\n> > So I checked all frames and content nodes and I think this is the only\n> > possibly bad use of a frame and I think all content nodes have nsCOMPtr's\n> > holding onto them (possibly in the calling function, which isn't ideal).\n> \n> OK, I'm looking through nsXULPopupManager.cpp and I'm worried that\n> nsMenuChainItem::mFrame might be stale.  E.g.\n> HidePopupsInList\n>   HidePopup\n>     FirePopupHidingEvent\n>       HidePopupCallback\n>         Dispatch\n>           * destroys the world *\n> * unwind to HidePopupsInList *\n>   SetCaptureState(nullptr)\n>     item = GetTopVisibleMenu()\n>     popup = item->Frame();\n>     * popup is destroyed *\n> \n\nNote though that the corresponding nsMenuChainItems are removed from the mFrames/mNoHidePanels lists within PopupDestroyed when their frames are destroyed so the call to GetTopVisibleMenu won't iterate over any destroyed items."},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-05T15:37:22Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"Ah, good point.  We still need to be very careful about local\nnsMenuChainItem* on the stack though.\n\nOK, so the patch that landed is redundant -- then I don't see\nwhat could have caused the crash stack, assuming all involved\nnsIContent* have a strong ref somewhere.\n\nNeil, do you have a theory for the crash stack?","id":6611186,"creation_time":"2012-09-05T15:37:22Z","raw_text":"Ah, good point.  We still need to be very careful about local\nnsMenuChainItem* on the stack though.\n\nOK, so the patch that landed is redundant -- then I don't see\nwhat could have caused the crash stack, assuming all involved\nnsIContent* have a strong ref somewhere.\n\nNeil, do you have a theory for the crash stack?"},{"is_private":false,"attachment_id":null,"creator":"mats@mozilla.com","time":"2012-09-05T15:50:05Z","author":"mats@mozilla.com","bug_id":787818,"tags":[],"text":"How about |popupsToHide| in PopupDestroyed():\n\n  nsTArray<nsMenuPopupFrame *> popupsToHide;\n  while {\n    ...\n    HidePopup() // destroys the world\n    break;\n  }\n  HidePopupsInList(popupsToHide, false);\n\nThe pointers in it could be stale when we pass it on to HidePopupsInList?","id":6611238,"creation_time":"2012-09-05T15:50:05Z","raw_text":"How about |popupsToHide| in PopupDestroyed():\n\n  nsTArray<nsMenuPopupFrame *> popupsToHide;\n  while {\n    ...\n    HidePopup() // destroys the world\n    break;\n  }\n  HidePopupsInList(popupsToHide, false);\n\nThe pointers in it could be stale when we pass it on to HidePopupsInList?"},{"is_private":false,"attachment_id":null,"creator":"enndeakin@gmail.com","time":"2012-09-05T16:02:57Z","author":"enndeakin@gmail.com","bug_id":787818,"tags":[],"text":"(In reply to Mats Palmgren [:mats] from comment #22)\n> How about |popupsToHide| in PopupDestroyed():\n> \n>   nsTArray<nsMenuPopupFrame *> popupsToHide;\n>   while {\n>     ...\n>     HidePopup() // destroys the world\n\nHidePopup is called here with aAsynchronous = true, so events fire asynchronously.","id":6611280,"creation_time":"2012-09-05T16:02:57Z","raw_text":"(In reply to Mats Palmgren [:mats] from comment #22)\n> How about |popupsToHide| in PopupDestroyed():\n> \n>   nsTArray<nsMenuPopupFrame *> popupsToHide;\n>   while {\n>     ...\n>     HidePopup() // destroys the world\n\nHidePopup is called here with aAsynchronous = true, so events fire asynchronously."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-05T16:35:20Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"There's only one crash in 18.0a1, bp-e0709a31-c4c4-4a6c-9a09-629aa2120903, whereas it's #8 top browser crasher in 17.0a2.\nIt might be a regression from bug 785626 that landed after the merge but before the first Aurora build in 17.0a2.","id":6611381,"creation_time":"2012-09-05T16:35:20Z","raw_text":"There's only one crash in 18.0a1, bp-e0709a31-c4c4-4a6c-9a09-629aa2120903, whereas it's #8 top browser crasher in 17.0a2.\nIt might be a regression from bug 785626 that landed after the merge but before the first Aurora build in 17.0a2."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-09-06T17:33:13Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Not working on this directly at the moment.","id":6615237,"creation_time":"2012-09-06T17:33:13Z","raw_text":"Not working on this directly at the moment."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-08T07:39:24Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"Bug 785626 is a partial backout of bug 785333.\nThe rest of bug 785333 only landed in branch 18.","id":6620049,"creation_time":"2012-09-08T07:39:24Z","raw_text":"Bug 785626 is a partial backout of bug 785333.\nThe rest of bug 785333 only landed in branch 18."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-11T22:06:29Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"*** Bug 790396 has been marked as a duplicate of this bug. ***","id":6626956,"creation_time":"2012-09-11T22:06:29Z","raw_text":""},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-19T08:39:35Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"It's #2 top browser crasher in 17.0a2 and accounts for 11% of all crashes.\n\nIt's related to TestPilot according to comments (survey popup) and correlations:\n  nsAsyncDOMEvent::nsAsyncDOMEvent(nsINode*, nsAString_internal const&, bool, bool)|EXCEPTION_ACCESS_VIOLATION_READ (329 crashes)\n     99% (327/329) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n  nsView::NotifyEffectiveVisibilityChanged(bool)|EXCEPTION_ACCESS_VIOLATION_READ (272 crashes)\n     99% (268/272) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n  nsView::DropMouseGrabbing()|EXCEPTION_ACCESS_VIOLATION_READ (96 crashes)\n    100% (96/96) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)","id":6646701,"creation_time":"2012-09-19T08:39:35Z","raw_text":"It's #2 top browser crasher in 17.0a2 and accounts for 11% of all crashes.\n\nIt's related to TestPilot according to comments (survey popup) and correlations:\n  nsAsyncDOMEvent::nsAsyncDOMEvent(nsINode*, nsAString_internal const&, bool, bool)|EXCEPTION_ACCESS_VIOLATION_READ (329 crashes)\n     99% (327/329) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n  nsView::NotifyEffectiveVisibilityChanged(bool)|EXCEPTION_ACCESS_VIOLATION_READ (272 crashes)\n     99% (268/272) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n  nsView::DropMouseGrabbing()|EXCEPTION_ACCESS_VIOLATION_READ (96 crashes)\n    100% (96/96) vs.  81% (3846/4760) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)"},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-09-19T19:20:33Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"As TestPilot is the culprit, bug 785626 is no longer suspected.","id":6648565,"creation_time":"2012-09-19T19:20:33Z","raw_text":"As TestPilot is the culprit, bug 785626 is no longer suspected."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-10-13T14:33:43Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"Now that version 18 is in Aurora with TestPilot, it's affected.\nWith combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2.","id":6725819,"creation_time":"2012-10-13T14:33:43Z","raw_text":"Now that version 18 is in Aurora with TestPilot, it's affected.\nWith combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2."},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-17T21:28:58Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to Scoobidiver from comment #30)\n> Now that version 18 is in Aurora with TestPilot, it's affected.\n> With combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2.\n\nJet - this is really hurting our TestPilot users on Aurora/Beta. Would you mind finding an assignee?","id":6739642,"creation_time":"2012-10-17T21:28:58Z","raw_text":"(In reply to Scoobidiver from comment #30)\n> Now that version 18 is in Aurora with TestPilot, it's affected.\n> With combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2.\n\nJet - this is really hurting our TestPilot users on Aurora/Beta. Would you mind finding an assignee?"},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-17T21:29:48Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to Scoobidiver from comment #30)\n> Now that version 18 is in Aurora with TestPilot, it's affected.\n> With combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2.\n\nSame correlation on Beta?","id":6739645,"creation_time":"2012-10-17T21:29:48Z","raw_text":"(In reply to Scoobidiver from comment #30)\n> Now that version 18 is in Aurora with TestPilot, it's affected.\n> With combined signatures, it's #7 top crasher in 17.0b1 and #2 in 18.0a2.\n\nSame correlation on Beta?"},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-10-17T21:56:12Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"(In reply to Alex Keybl [:akeybl] from comment #32)\n> Same correlation on Beta?\nYes. Here they are:\n  nsView::NotifyEffectiveVisibilityChanged(bool)|EXCEPTION_ACCESS_VIOLATION_READ (138 crashes)\n     97% (134/138) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n\n  nsAsyncDOMEvent::nsAsyncDOMEvent(nsINode*, nsAString_internal const&, bool, bool)|EXCEPTION_ACCESS_VIOLATION_READ (101 crashes)\n     97% (98/101) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n      8% (8/101) vs.   2% (717/39681) mozilla_cc@internetdownloadmanager.com (IDM CC, https://addons.mozilla.org/addon/6973)\n\n  nsView::DropMouseGrabbing()|EXCEPTION_ACCESS_VIOLATION_READ (40 crashes)\n     95% (38/40) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n      8% (3/40) vs.   1% (546/39681) firebug@software.joehewitt.com (Firebug, https://addons.mozilla.org/addon/1843)","id":6739726,"creation_time":"2012-10-17T21:56:12Z","raw_text":"(In reply to Alex Keybl [:akeybl] from comment #32)\n> Same correlation on Beta?\nYes. Here they are:\n  nsView::NotifyEffectiveVisibilityChanged(bool)|EXCEPTION_ACCESS_VIOLATION_READ (138 crashes)\n     97% (134/138) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n\n  nsAsyncDOMEvent::nsAsyncDOMEvent(nsINode*, nsAString_internal const&, bool, bool)|EXCEPTION_ACCESS_VIOLATION_READ (101 crashes)\n     97% (98/101) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n      8% (8/101) vs.   2% (717/39681) mozilla_cc@internetdownloadmanager.com (IDM CC, https://addons.mozilla.org/addon/6973)\n\n  nsView::DropMouseGrabbing()|EXCEPTION_ACCESS_VIOLATION_READ (40 crashes)\n     95% (38/40) vs.  82% (32437/39681) testpilot@labs.mozilla.com (Mozilla Labs - Test Pilot, https://addons.mozilla.org/addon/13661)\n      8% (3/40) vs.   1% (546/39681) firebug@software.joehewitt.com (Firebug, https://addons.mozilla.org/addon/1843)"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-10-18T02:25:27Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"If it happens with Test Pilot maybe we could play around with Test Pilot and try to find some steps to reproduce?","id":6740659,"creation_time":"2012-10-18T02:25:27Z","raw_text":"If it happens with Test Pilot maybe we could play around with Test Pilot and try to find some steps to reproduce?"},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-10-18T06:31:33Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"(In reply to Timothy Nikkel (:tn) from comment #34)\n> If it happens with Test Pilot maybe we could play around with Test Pilot and\n> try to find some steps to reproduce?\nAccording to comments in 18.0a2, it's easy to reproduce:\n\"closing a popup notice for a firefox survey\"\n\"I clicked the \"X\" button to close the notification for the test pilot survey and firefox crashed.\"\n\"I was rearranging my toolbar and had just declined to take a survey\"","id":6741067,"creation_time":"2012-10-18T06:31:33Z","raw_text":"(In reply to Timothy Nikkel (:tn) from comment #34)\n> If it happens with Test Pilot maybe we could play around with Test Pilot and\n> try to find some steps to reproduce?\nAccording to comments in 18.0a2, it's easy to reproduce:\n\"closing a popup notice for a firefox survey\"\n\"I clicked the \"X\" button to close the notification for the test pilot survey and firefox crashed.\"\n\"I was rearranging my toolbar and had just declined to take a survey\""},{"is_private":false,"attachment_id":null,"creator":"cww@mozilla.com","time":"2012-10-18T16:35:10Z","author":"cww@mozilla.com","bug_id":787818,"tags":[],"text":"I'm asking the Test pilot team to push out surveys next week (on both 17 and 18).  Should I hold off?","id":6742430,"creation_time":"2012-10-18T16:35:10Z","raw_text":"I'm asking the Test pilot team to push out surveys next week (on both 17 and 18).  Should I hold off?"},{"is_private":false,"attachment_id":null,"creator":"enndeakin@gmail.com","time":"2012-10-22T19:02:45Z","author":"enndeakin@gmail.com","bug_id":787818,"tags":[],"text":"Is there a way to get the survey to appear so that this bug can be reproduced?","id":6752201,"creation_time":"2012-10-22T19:02:45Z","raw_text":"Is there a way to get the survey to appear so that this bug can be reproduced?"},{"is_private":false,"attachment_id":null,"creator":"dveditz@mozilla.com","time":"2012-10-23T03:25:29Z","author":"dveditz@mozilla.com","bug_id":787818,"tags":[],"text":"a lot of the nsMenuFrame::HidePopup crashes in 17.0a2 were at high addresses and EXCEPTION_ACCESS_VIOLATION_EXEC -- definitely exploitable if we could reproduce it, but they're all clustered around reporting date of Sept 26 - Oct 2. Does that correspond with a Test Pilot survey?  The build dates were from a month prior to that, Aug 31 - Sept 4. Who keeps their Aurora builds that out of date?\n\nThe overwhelming majority of the crashes at nsView::NotifyEffectiveVisibilityChanged(bool) were\nEXCEPTION_ACCESS_VIOLATION_READ at 0x72657397 -- always that address, across different versions of windows and different Firefox builds (but all 17 or 18). Very suspicious to have such a fixed address, unless it's data. \"res<?>\" ?","id":6753799,"creation_time":"2012-10-23T03:25:29Z","raw_text":"a lot of the nsMenuFrame::HidePopup crashes in 17.0a2 were at high addresses and EXCEPTION_ACCESS_VIOLATION_EXEC -- definitely exploitable if we could reproduce it, but they're all clustered around reporting date of Sept 26 - Oct 2. Does that correspond with a Test Pilot survey?  The build dates were from a month prior to that, Aug 31 - Sept 4. Who keeps their Aurora builds that out of date?\n\nThe overwhelming majority of the crashes at nsView::NotifyEffectiveVisibilityChanged(bool) were\nEXCEPTION_ACCESS_VIOLATION_READ at 0x72657397 -- always that address, across different versions of windows and different Firefox builds (but all 17 or 18). Very suspicious to have such a fixed address, unless it's data. \"res<?>\" ?"},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-23T22:57:48Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to [:Cww] from comment #36)\n> I'm asking the Test pilot team to push out surveys next week (on both 17 and\n> 18).  Should I hold off?\n\nIf we got actionable results from the last survey (similarly affected), we shouldn't block on this.","id":6756928,"creation_time":"2012-10-23T22:57:48Z","raw_text":"(In reply to [:Cww] from comment #36)\n> I'm asking the Test pilot team to push out surveys next week (on both 17 and\n> 18).  Should I hold off?\n\nIf we got actionable results from the last survey (similarly affected), we shouldn't block on this."},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-23T22:58:36Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to Neil Deakin from comment #37)\n> Is there a way to get the survey to appear so that this bug can be\n> reproduced?\n\nGregg - can you advise Neil here?","id":6756935,"creation_time":"2012-10-23T22:58:36Z","raw_text":"(In reply to Neil Deakin from comment #37)\n> Is there a way to get the survey to appear so that this bug can be\n> reproduced?\n\nGregg - can you advise Neil here?"},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-10-23T23:07:46Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"Can someone from this team schedule a bit of phone time tomorrow (glind@moz will get my calendar) on this.  I don't really understand the issues here.  Thanks!","id":6756971,"creation_time":"2012-10-23T23:07:46Z","raw_text":"Can someone from this team schedule a bit of phone time tomorrow (glind@moz will get my calendar) on this.  I don't really understand the issues here.  Thanks!"},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-23T23:13:09Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to Gregg Lind (User Research - Test Pilot) from comment #41)\n> Can someone from this team schedule a bit of phone time tomorrow (glind@moz\n> will get my calendar) on this.  I don't really understand the issues here. \n> Thanks!\n\nNeil would like to figure out how to trigger a test pilot survey, to reproduce this crash.","id":6756991,"creation_time":"2012-10-23T23:13:09Z","raw_text":"(In reply to Gregg Lind (User Research - Test Pilot) from comment #41)\n> Can someone from this team schedule a bit of phone time tomorrow (glind@moz\n> will get my calendar) on this.  I don't really understand the issues here. \n> Thanks!\n\nNeil would like to figure out how to trigger a test pilot survey, to reproduce this crash."},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-10-26T22:05:51Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"Cheng - do you know the answer to Commment 42?","id":6768323,"creation_time":"2012-10-26T22:05:51Z","raw_text":"Cheng - do you know the answer to Commment 42?"},{"is_private":false,"attachment_id":null,"creator":"cww@mozilla.com","time":"2012-10-31T23:42:01Z","author":"cww@mozilla.com","bug_id":787818,"tags":[],"text":"Sorry, I should have passed this off to someone ... we're at a workweek and I spaced. Sending over to ilana.","id":6782058,"creation_time":"2012-10-31T23:42:01Z","raw_text":"Sorry, I should have passed this off to someone ... we're at a workweek and I spaced. Sending over to ilana."},{"is_private":false,"attachment_id":null,"creator":"kairo@kairo.at","time":"2012-11-07T17:03:42Z","author":"kairo@kairo.at","bug_id":787818,"tags":[],"text":"Cheng, I guess this work week is over, and we still have no reply from you or Ilana on the tracking+ bug for 17.\nThis has resided in 17, though, I guess because we are not running a Testpilot survey right now, but I see it at #9 in 18 data from yesterday. We really should move forward here.","id":6801009,"creation_time":"2012-11-07T17:03:42Z","raw_text":"Cheng, I guess this work week is over, and we still have no reply from you or Ilana on the tracking+ bug for 17.\nThis has resided in 17, though, I guess because we are not running a Testpilot survey right now, but I see it at #9 in 18 data from yesterday. We really should move forward here."},{"is_private":false,"attachment_id":null,"creator":"lukasblakk+bugs@gmail.com","time":"2012-11-08T01:49:58Z","author":"lukasblakk+bugs@gmail.com","bug_id":787818,"tags":[],"text":"We will have to keep chasing this down for 18, but at this point we're too late for 17.","id":6803331,"creation_time":"2012-11-08T01:49:58Z","raw_text":"We will have to keep chasing this down for 18, but at this point we're too late for 17."},{"is_private":false,"attachment_id":null,"creator":"cww@mozilla.com","time":"2012-11-08T18:45:06Z","author":"cww@mozilla.com","bug_id":787818,"tags":[],"text":"I'm confused, Ilana sent an email to a lot of people offering help to work on it but it seems to have gotten dropped.\n\nHopefully, it can make 18. We're deliberately not running anything on test pilot (which means no aurora survey this cycle) as we're holding on this bug.","id":6805427,"creation_time":"2012-11-08T18:45:06Z","raw_text":"I'm confused, Ilana sent an email to a lot of people offering help to work on it but it seems to have gotten dropped.\n\nHopefully, it can make 18. We're deliberately not running anything on test pilot (which means no aurora survey this cycle) as we're holding on this bug."},{"is_private":false,"attachment_id":null,"creator":"scoobidiver@netcourrier.com","time":"2012-11-09T12:32:44Z","author":"scoobidiver@netcourrier.com","bug_id":787818,"tags":[],"text":"*** Bug 810158 has been marked as a duplicate of this bug. ***","id":6807994,"creation_time":"2012-11-09T12:32:44Z","raw_text":""},{"is_private":false,"attachment_id":null,"creator":"mozillamarcia.knous@gmail.com","time":"2012-11-10T17:03:08Z","author":"mozillamarcia.knous@gmail.com","bug_id":787818,"tags":[],"text":"This is showing up on the explosive report today for FF 17 - https://crash-analysis.mozilla.com/rkaiser/2012-11-09/2012-11-09.firefox.17.explosiveness.html - although volume wise for the week it only has 542 crashes across all versions.","id":6811065,"creation_time":"2012-11-10T17:03:08Z","raw_text":"This is showing up on the explosive report today for FF 17 - https://crash-analysis.mozilla.com/rkaiser/2012-11-09/2012-11-09.firefox.17.explosiveness.html - although volume wise for the week it only has 542 crashes across all versions."},{"is_private":false,"attachment_id":null,"creator":"mozillamarcia.knous@gmail.com","time":"2012-11-10T17:11:59Z","author":"mozillamarcia.knous@gmail.com","bug_id":787818,"tags":[],"text":"The 542 crashes I cited in comment was for the nsMenuPopupFrame::HidePopup(bool, nsPopupState) signature.  nsView::NotifyEffectiveVisibilityChanged(bool) has 2327 in the last week across all versions, so when you start adding these signatures up - 771 for nsView::DropMouseGrabbing() and the final signature has 1329 in the last week - that totals to almost 5K crashes in the last week.","id":6811074,"creation_time":"2012-11-10T17:11:59Z","raw_text":"The 542 crashes I cited in comment was for the nsMenuPopupFrame::HidePopup(bool, nsPopupState) signature.  nsView::NotifyEffectiveVisibilityChanged(bool) has 2327 in the last week across all versions, so when you start adding these signatures up - 771 for nsView::DropMouseGrabbing() and the final signature has 1329 in the last week - that totals to almost 5K crashes in the last week."},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-11-13T21:56:42Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"Okay, I am free anytime until EOD today, or tomorrow to work through this.  \n\nhttp://hg.mozilla.org/labs/testpilotweb/raw-file/tip/README.md  is our debug procedure, but it will be much easier to work with someone in real-time to reproduce this.  \n\nThanks!\n\nGregg","id":6818839,"creation_time":"2012-11-13T21:56:42Z","raw_text":"Okay, I am free anytime until EOD today, or tomorrow to work through this.  \n\nhttp://hg.mozilla.org/labs/testpilotweb/raw-file/tip/README.md  is our debug procedure, but it will be much easier to work with someone in real-time to reproduce this.  \n\nThanks!\n\nGregg"},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-11-13T22:12:05Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"I am practicing with my local copies of everything and am unable to reproduce this bug.","id":6818899,"creation_time":"2012-11-13T22:12:05Z","raw_text":"I am practicing with my local copies of everything and am unable to reproduce this bug."},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-11-14T16:00:15Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"This should help:  (also, `testpilothelper` above is an alternate path)\n\n#. edit setting to fake version of the testcases directory\nextensions.testpilot.indexBaseURL -> https://people.mozilla.com/~glind/onesurvey/testcases/ \n\n#. Restart (sorry!)\n\n#. Open TP Debug page\nchrome://testpilot/content/debug.html\n\n#. Error console\nchrome://global/content/console.xul\n\n#. After some hard refreshes, once things load, choose:  \n`a_survey_for_testing_crashes` and use the dummy popup button.  \n\nIf this is too complicated (which it is!), ask me for help, and we can try to make another pass at simplifying.","id":6821255,"creation_time":"2012-11-14T16:00:15Z","raw_text":"This should help:  (also, `testpilothelper` above is an alternate path)\n\n#. edit setting to fake version of the testcases directory\nextensions.testpilot.indexBaseURL -> https://people.mozilla.com/~glind/onesurvey/testcases/ \n\n#. Restart (sorry!)\n\n#. Open TP Debug page\nchrome://testpilot/content/debug.html\n\n#. Error console\nchrome://global/content/console.xul\n\n#. After some hard refreshes, once things load, choose:  \n`a_survey_for_testing_crashes` and use the dummy popup button.  \n\nIf this is too complicated (which it is!), ask me for help, and we can try to make another pass at simplifying."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-14T20:55:38Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Thanks. With the steps from comment 53 I've been able to get a crash two times now, but with a lot of trying. I'm trying to determine steps that more reliably cause a crash.","id":6822554,"creation_time":"2012-11-14T20:55:38Z","raw_text":"Thanks. With the steps from comment 53 I've been able to get a crash two times now, but with a lot of trying. I'm trying to determine steps that more reliably cause a crash."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-14T21:08:14Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Oh and I don't get the test survey (a_survey_for_testing_crashes), I only get the real surveys.","id":6822607,"creation_time":"2012-11-14T21:08:14Z","raw_text":"Oh and I don't get the test survey (a_survey_for_testing_crashes), I only get the real surveys."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-14T21:53:59Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Reliable steps: once you get a test pilot popup, bring another window to the foreground, and with that other window still the foreground window click on the submit button on the test pilot notification popup.","id":6822789,"creation_time":"2012-11-14T21:53:59Z","raw_text":"Reliable steps: once you get a test pilot popup, bring another window to the foreground, and with that other window still the foreground window click on the submit button on the test pilot notification popup."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-14T22:40:17Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Regression range\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=86ee4deea55b&tochange=50e4ff05741e","id":6823013,"creation_time":"2012-11-14T22:40:17Z","raw_text":"Regression range\nhttp://hg.mozilla.org/mozilla-central/pushloghtml?fromchange=86ee4deea55b&tochange=50e4ff05741e"},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-11-14T23:13:50Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"Tn,\n\nPoke me on IRC if you want to work this real time.","id":6823147,"creation_time":"2012-11-14T23:13:50Z","raw_text":"Tn,\n\nPoke me on IRC if you want to work this real time."},{"is_private":false,"attachment_id":null,"creator":"glind@mozilla.com","time":"2012-11-14T23:14:22Z","author":"glind@mozilla.com","bug_id":787818,"tags":[],"text":"Tn,\n\nPoke me on IRC if you want to work this real time.  (gregglind)","id":6823151,"creation_time":"2012-11-14T23:14:22Z","raw_text":"Tn,\n\nPoke me on IRC if you want to work this real time.  (gregglind)"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-14T23:32:25Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Thanks Gregg, I think we have everything we need right now to reproduce and debug this. If we need more Test Pilot info we'll let you know.","id":6823214,"creation_time":"2012-11-14T23:32:25Z","raw_text":"Thanks Gregg, I think we have everything we need right now to reproduce and debug this. If we need more Test Pilot info we'll let you know."},{"is_private":false,"attachment_id":682155,"creator":"tnikkel@gmail.com","time":"2012-11-15T21:08:11Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Created attachment 682155\nstack\n\nnsMenuPopupFrame::HidePopup sets the view visibility to hidden, which calls nsWindow::Show(false), which calls ::ShowWindow() to tell Windows to hide the window. This responds synchronously with a WM_SETFOCUS message on the main toplevel window. And the focus subsystem flushes in CheckIfFocusable and that kills the menupopup frame because the onPopupHiding event handler for the event we dispatch just a little earlier made some changes that required a frame reconstruct of the popup.","id":6826751,"creation_time":"2012-11-15T21:08:11Z","raw_text":"nsMenuPopupFrame::HidePopup sets the view visibility to hidden, which calls nsWindow::Show(false), which calls ::ShowWindow() to tell Windows to hide the window. This responds synchronously with a WM_SETFOCUS message on the main toplevel window. And the focus subsystem flushes in CheckIfFocusable and that kills the menupopup frame because the onPopupHiding event handler for the event we dispatch just a little earlier made some changes that required a frame reconstruct of the popup."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-15T21:11:06Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"So if calling nsWindow::Show can flush and destroy anything we are going to need to add protections in a lot of places.\n\nBut I'm suspicious as to why this only started crashing with the regression range in comment 57. I think perhaps http://hg.mozilla.org/mozilla-central/diff/448410c2035e/widget/windows/nsWindow.cpp from bug 743975 could have been what triggered this, but I don't see how.","id":6826766,"creation_time":"2012-11-15T21:11:06Z","raw_text":"So if calling nsWindow::Show can flush and destroy anything we are going to need to add protections in a lot of places.\n\nBut I'm suspicious as to why this only started crashing with the regression range in comment 57. I think perhaps http://hg.mozilla.org/mozilla-central/diff/448410c2035e/widget/windows/nsWindow.cpp from bug 743975 could have been what triggered this, but I don't see how."},{"is_private":false,"attachment_id":null,"creator":"enndeakin@gmail.com","time":"2012-11-15T21:33:56Z","author":"enndeakin@gmail.com","bug_id":787818,"tags":[],"text":"Which popup is being hidden here?","id":6826846,"creation_time":"2012-11-15T21:33:56Z","raw_text":"Which popup is being hidden here?"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-15T21:47:10Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"The Test Pilot notification popup.","id":6826890,"creation_time":"2012-11-15T21:47:10Z","raw_text":"The Test Pilot notification popup."},{"is_private":false,"attachment_id":682181,"creator":"enndeakin@gmail.com","time":"2012-11-15T22:08:32Z","author":"enndeakin@gmail.com","bug_id":787818,"tags":[],"text":"Created attachment 682181\nTestcase\n\nTo reproduce:\n\n1. Open as a chrome window.\n2. Press the Open button.\n3. Click on another application.\n4. Without focusing the testcase window again, press the Close button.\n\nNote that the mouse click fires before the window is raised.\n\nIt's possible that bug 743975 changed the event firing in some manner that caused the focus event to now fire when it didn't before.","id":6826975,"creation_time":"2012-11-15T22:08:32Z","raw_text":"To reproduce:\n\n1. Open as a chrome window.\n2. Press the Open button.\n3. Click on another application.\n4. Without focusing the testcase window again, press the Close button.\n\nNote that the mouse click fires before the window is raised.\n\nIt's possible that bug 743975 changed the event firing in some manner that caused the focus event to now fire when it didn't before."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-15T22:29:57Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"I think so, in older builds I think clicking on the button in the popup when another application is foreground would bring Firefox and the popup to the front but the button wouldn't get a click event.","id":6827058,"creation_time":"2012-11-15T22:29:57Z","raw_text":"I think so, in older builds I think clicking on the button in the popup when another application is foreground would bring Firefox and the popup to the front but the button wouldn't get a click event."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-16T07:56:36Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"The change that http://hg.mozilla.org/mozilla-central/diff/448410c2035e/widget/windows/nsWindow.cpp made that causes this is that nsWindow::DispatchFocusToTopLevelWindow now finds the top level window and then dispatches the active/deactivate to our mWidgetListener and not the mWidgetListener of the top level window we just found. I'll post a patch tomorrow.","id":6828175,"creation_time":"2012-11-16T07:56:36Z","raw_text":"The change that http://hg.mozilla.org/mozilla-central/diff/448410c2035e/widget/windows/nsWindow.cpp made that causes this is that nsWindow::DispatchFocusToTopLevelWindow now finds the top level window and then dispatches the active/deactivate to our mWidgetListener and not the mWidgetListener of the top level window we just found. I'll post a patch tomorrow."},{"is_private":false,"attachment_id":682552,"creator":"tnikkel@gmail.com","time":"2012-11-16T19:19:40Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Created attachment 682552\npatch\n\nThis makes us send activate and deactivate notifications to the toplevel window, like we used to before bug 743975, instead of the panel.","id":6829743,"creation_time":"2012-11-16T19:19:40Z","raw_text":"This makes us send activate and deactivate notifications to the toplevel window, like we used to before bug 743975, instead of the panel."},{"is_private":false,"attachment_id":682552,"creator":"tnikkel@gmail.com","time":"2012-11-16T19:46:32Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Comment on attachment 682552\npatch\n\n[Security approval request comment]\nHow easily can the security issue be deduced from the patch?\nI don't think it's easy at all.\n\nDo comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?\nNo, I don't think so.\n\nWhich older supported branches are affected by this flaw?\nversion 17 through to current.\n\nIf not all supported branches, which bug introduced the flaw?\nThis is a regression from bug 743975.\n\nDo you have backports for the affected branches? If not, how different, hard to create, and risky will they be?\nThe patch should apply directly, if not it will be very simple, the code hasn't change since the original regression.\n\nHow likely is this patch to cause regressions; how much testing does it need?\nIt restores us to the behaviour we had pre bug 743975, I don't think it needs extensive testing.","id":6829852,"creation_time":"2012-11-16T19:46:32Z","raw_text":"[Security approval request comment]\nHow easily can the security issue be deduced from the patch?\nI don't think it's easy at all.\n\nDo comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?\nNo, I don't think so.\n\nWhich older supported branches are affected by this flaw?\nversion 17 through to current.\n\nIf not all supported branches, which bug introduced the flaw?\nThis is a regression from bug 743975.\n\nDo you have backports for the affected branches? If not, how different, hard to create, and risky will they be?\nThe patch should apply directly, if not it will be very simple, the code hasn't change since the original regression.\n\nHow likely is this patch to cause regressions; how much testing does it need?\nIt restores us to the behaviour we had pre bug 743975, I don't think it needs extensive testing."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-16T19:48:12Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"We're releasing Firefox 17 on tuesday and it is affected by this bug. I don't think it's reasonable to land this patch in Firefox 17, which is sad because it will be the only release to be affected by this bug.","id":6829859,"creation_time":"2012-11-16T19:48:12Z","raw_text":"We're releasing Firefox 17 on tuesday and it is affected by this bug. I don't think it's reasonable to land this patch in Firefox 17, which is sad because it will be the only release to be affected by this bug."},{"is_private":false,"attachment_id":null,"creator":"dveditz@mozilla.com","time":"2012-11-16T21:48:44Z","author":"dveditz@mozilla.com","bug_id":787818,"tags":[],"text":"lowering security severity, it looks like there's no way for web content to trigger this otherwise exploitable condition.","id":6830184,"creation_time":"2012-11-16T21:48:44Z","raw_text":"lowering security severity, it looks like there's no way for web content to trigger this otherwise exploitable condition."},{"is_private":false,"attachment_id":682552,"creator":"dveditz@mozilla.com","time":"2012-11-16T21:49:27Z","author":"dveditz@mozilla.com","bug_id":787818,"tags":[],"text":"Comment on attachment 682552\npatch\n\nsec-approval+ for mozilla-central.","id":6830185,"creation_time":"2012-11-16T21:49:27Z","raw_text":"sec-approval+ for mozilla-central."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-16T23:42:42Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"https://hg.mozilla.org/integration/mozilla-inbound/rev/094819a5ee7a","id":6830536,"creation_time":"2012-11-16T23:42:42Z","raw_text":"https://hg.mozilla.org/integration/mozilla-inbound/rev/094819a5ee7a"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-16T23:43:45Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"https://tbpl.mozilla.org/?tree=Try&rev=5370c404d3d2","id":6830539,"creation_time":"2012-11-16T23:43:45Z","raw_text":"https://tbpl.mozilla.org/?tree=Try&rev=5370c404d3d2"},{"is_private":false,"attachment_id":null,"creator":"ryanvm@gmail.com","time":"2012-11-17T13:21:54Z","author":"ryanvm@gmail.com","bug_id":787818,"tags":[],"text":"https://hg.mozilla.org/mozilla-central/rev/094819a5ee7a","id":6831296,"creation_time":"2012-11-17T13:21:54Z","raw_text":"https://hg.mozilla.org/mozilla-central/rev/094819a5ee7a"},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-17T21:22:46Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"The patch here means that we no longer hit a bad case which destroys us when calling nsWindow::Show (via setting view visibility). The badness happens because Windows sends us back a focus notification in response to hiding a window. There is no obvious reason why Windows can't send us a focus notification when we are hiding or showing a window, and so if that is true there are a lot of other places that we should guard against to be safe from this type of problem. However the fact that we've never been bitten by this before makes me wonder if there is a reason for that.","id":6831723,"creation_time":"2012-11-17T21:22:46Z","raw_text":"The patch here means that we no longer hit a bad case which destroys us when calling nsWindow::Show (via setting view visibility). The badness happens because Windows sends us back a focus notification in response to hiding a window. There is no obvious reason why Windows can't send us a focus notification when we are hiding or showing a window, and so if that is true there are a lot of other places that we should guard against to be safe from this type of problem. However the fact that we've never been bitten by this before makes me wonder if there is a reason for that."},{"is_private":false,"attachment_id":682552,"creator":"cww@mozilla.com","time":"2012-11-20T16:42:04Z","author":"cww@mozilla.com","bug_id":787818,"tags":[],"text":"Comment on attachment 682552\npatch\n\nCan we please have it in beta\n\nUser impact if declined: We can't run test pilot studies which puts us back 6 weeks on some key studies for this quarter and general crashiness.","id":6838239,"creation_time":"2012-11-20T16:42:04Z","raw_text":"Can we please have it in beta\n\nUser impact if declined: We can't run test pilot studies which puts us back 6 weeks on some key studies for this quarter and general crashiness."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-20T18:48:37Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"Yeah, I was going to request approval today, just wanted a bit of time on nightly to catch any regressions. We should take this on beta, it restores our window focus notifications to how we did them prior to bug 743975, so it should be low risk.","id":6838751,"creation_time":"2012-11-20T18:48:37Z","raw_text":"Yeah, I was going to request approval today, just wanted a bit of time on nightly to catch any regressions. We should take this on beta, it restores our window focus notifications to how we did them prior to bug 743975, so it should be low risk."},{"is_private":false,"attachment_id":null,"creator":"akeybl@mozilla.com","time":"2012-11-20T19:37:27Z","author":"akeybl@mozilla.com","bug_id":787818,"tags":[],"text":"(In reply to Timothy Nikkel (:tn) from comment #78)\n> Yeah, I was going to request approval today, just wanted a bit of time on\n> nightly to catch any regressions. We should take this on beta, it restores\n> our window focus notifications to how we did them prior to bug 743975, so it\n> should be low risk.\n\nIf we land now, we can still make it into beta 1.","id":6838947,"creation_time":"2012-11-20T19:37:27Z","raw_text":"(In reply to Timothy Nikkel (:tn) from comment #78)\n> Yeah, I was going to request approval today, just wanted a bit of time on\n> nightly to catch any regressions. We should take this on beta, it restores\n> our window focus notifications to how we did them prior to bug 743975, so it\n> should be low risk.\n\nIf we land now, we can still make it into beta 1."},{"is_private":false,"attachment_id":null,"creator":"tnikkel@gmail.com","time":"2012-11-20T19:45:18Z","author":"tnikkel@gmail.com","bug_id":787818,"tags":[],"text":"https://hg.mozilla.org/releases/mozilla-beta/rev/9e7aeb6be40a","id":6838980,"creation_time":"2012-11-20T19:45:18Z","raw_text":"https://hg.mozilla.org/releases/mozilla-beta/rev/9e7aeb6be40a"}]}},"comments":{}}