46485: <head>
46485:   <title>Plugin crashing</title>
46485:   <script type="application/javascript" src="chrome://mochikit/content/MochiKit/packed.js"></script>
46485:   <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
46485: 
46485: <body onload="mainLoaded()">
46485:   <iframe id="iframe1" src="about:blank" width="600" height="600"></iframe>
46485: 
46485:   <script class="testbody" type="application/javascript">
46485:   SimpleTest.waitForExplicitFinish();
46485: 
46485:   var iframe = document.getElementById('iframe1');
46485: 
46485:   function mainLoaded() {
46485:     netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
46485:     var prefs = Components.classes['@mozilla.org/preferences-service;1']
46485:       .getService(Components.interfaces.nsIPrefBranch);
46485:     if (!prefs.getBoolPref('dom.ipc.plugins.enabled')) {
46485:       ok(true, "Skipping this test when IPC plugins are not enabled.");
46485:       SimpleTest.finish();
46485:       return;
46485:     }
46485: 
46485:     var p = iframe.contentDocument.createElement('embed');
46485:     p.setAttribute('id', 'plugin1');
46485:     p.setAttribute('type', 'application/x-test');
46485:     p.setAttribute('width', '400');
46485:     p.setAttribute('height', '400');
46485:     p.setAttribute('drawmode', 'solid');
46485:     p.setAttribute('color', 'FF00FFFF');
46485:     p.setAttribute('newCrash', 'true');
46485:     iframe.contentDocument.body.appendChild(p);
46485: 
46486:     // The plugin will now crash when it is instantiated, but
46486:     // that happens asynchronously. HACK: this should use an
46486:     // event instead of nested pending runnables, but I don't
46486:     // know of any DOM event that's fired when a plugin is
46486:     // instantiated.
46486:     SimpleTest.executeSoon(function() {
46486:       SimpleTest.executeSoon(function() {
46486:         ok(p.setColor === undefined,
46486:            "Plugin should have crashed on creation");
46485: 
46485:         window.frameLoaded = reloaded1;
46485:         iframe.contentWindow.location.replace('crashing_subpage.html');
46486:       })
46486:     });
46485:   }
46485: 
46485:   function reloaded1() {
46485:     var p = iframe.contentDocument.getElementById('plugin1');
46485:     try {
46485:       p.setColor('FF00FF00');
46485:       ok(true, "Reloading worked");
46485:     }
46485:     catch (e) {
46485:       ok(false, "Reloading didn't give us a usable plugin");
46485:     }
46485:     p.crashOnDestroy();
46486:     // the child crash should happen here
46486:     p.parentNode.removeChild(p);
46486: 
46485:     window.frameLoaded = reloaded2;
46485:     iframe.contentWindow.location.reload();
46485:   }
46485: 
46485:   function reloaded2() {
46485:     var p = iframe.contentDocument.getElementById('plugin1');
46485:     try {
46485:       p.setColor('FF00FF00');
46485:       ok(true, "Reloading worked");
46485:     }
46485:     catch (e) {
46485:       ok(false, "Reloading didn't give us a usable plugin");
46485:     }
46485:     SimpleTest.finish();
46485:   }
46485:   </script>
