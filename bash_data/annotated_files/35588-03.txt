10334: <!DOCTYPE HTML>
10334: <html>
10334: <head>
10334:     <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
10334:     <title>Mochitest for DOCTYPE parsing</title>
10334: 
28048:   <script type="text/javascript" src="/MochiKit/packed.js"></script>
10334:   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
10334:   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
10334: </head>
10334: <body>
10334: <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=363883">Mozilla Bug 363883</a>
10334: 
10334: <p id="display"></p>
10334: <div id="content" style="display: none">
10334: 
10334: </div>
10334: 
10334: <pre id="test">
10334: <script class="testbody" type="text/javascript">
10334: 
10334: var doctypes = [
10334: /* from bug 363883 */
10334: 'BackCompat' , '<!DOCTYPE>',
10334: 'BackCompat' , '<!DOCTYPEz>',
10334: 'BackCompat' , '<! DOCTYPE>',
10334: 'BackCompat' , '<!zDOCTYPE>',
10334: 'CSS1Compat' , '<!DOCTYPEHTML>',
10334: 'BackCompat' , '<!DOCTYPEz HTML>',
10334: 'CSS1Compat' , '<!DOCTYPE HTML>',
10334: 'BackCompat' , '<!zDOCTYPE HTML>',
10334: 'BackCompat' , '<!DOCTYPE HTMLz>',
10334: 'BackCompat' , '<!DOCTYPE zHTML>',
10334: 'BackCompat' , '<!DOCTYPE XHTML>',
10334: 'BackCompat' , '<!DOCTYPE zzHTML>',
10334: 'BackCompat' , '<!DOCTYPEzHTML>',
10334: 'BackCompat' , '<!DOCTYPEzzHTML>',
10334: 'BackCompat' , '<!DOCTYPE "bla">',
10334: 'BackCompat' , '<!DOCTYPE HTML "bla">',
10334: 'BackCompat' , '<!DOCTYPE HTML "html">',
10334: 'BackCompat' , '<!DOCTYPE PUBLIC>',
10334: 'BackCompat' , '<!DOCTYPE PUBLIC "bla">',
10334: 'BackCompat' , '<!DOCTYPE PUBLIC "html">',
10334: 'CSS1Compat' , '<!DOCTYPE HTML PUBLIC "bla">',
10334: 'BackCompat' , '<!DOCTYPE HTML PUBLIC "html">',
10334: 'BackCompat' , '<!DOCTYPEz HTML PUBLIC "html">',
10334: 'BackCompat' , '<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 3.2//en">',
10334: 'BackCompat' , '<!DOCTYPEz HTML PUBLIC "-//IETF//DTD HTML 3.2//en">',
10334: 'BackCompat' , '<!DOCTYPE HTMLz PUBLIC "DTD HTML 3.2">',
10334: 'BackCompat' , '<!DOCTYPE "DTD HTML 3.2">',
10334: /* end from bug 363883 */
31193: // from bug 502600
31193: 'BackCompat' , '<!doctype HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">',
10334: ];
10334: 
31193: ////
31193: // Restore the original value of the html5.enable pref,
31193: // and finish.
31193: //
31193: function finishTest() {
31193:   netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
31193:   var prefs = Components.classes["@mozilla.org/preferences-service;1"]
31193:             .getService(Components.interfaces.nsIPrefBranch);
31193:   prefs.setBoolPref("html5.enable", gOriginalHtml5Pref);
31193:   SimpleTest.finish();  
31193: }
31193: 
31193: ////
31193: // Verify that the iframe's compatibility mode matches
31193: // the expected value.  This function is called from the
31193: // test iframe's onload handler.  When verifying the
31193: // last test in the group, if there is no original
31193: // value for the html5.enable pref stored in the
31193: // 'gOriginalHtml5Pref' variable, then run the tests
31193: // again in HTML5 mode.  Otherwise, finish the test.
31193: //
10334: function test(mode,i){
31193:   is(mode,doctypes[i],doctypes[i+1]);
31193:   if (i == doctypes.length - 2) {
35588:     if (typeof(gOriginalHtml5Pref) == "undefined") {
35588:       doTestHtml5();
35588:     }
35588:     else {
31193:       finishTest();
35588:     }
31193:   }
31193: }
31193: 
31193: ////
31193: // Enable the HTML5 parser, then iterate through the tests
31193: // a second time.
31193: //
31193: function doTestHtml5() {
31193:   netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
31193:   var prefs = Components.classes["@mozilla.org/preferences-service;1"]
31193:             .getService(Components.interfaces.nsIPrefBranch);
31193:   gOriginalHtml5Pref = prefs.getBoolPref("html5.enable");
31193:   prefs.setBoolPref("html5.enable", true);
31193:   
31193:   doTest();
31193: }
31193: 
31193: ////
31193: // Insert a hidden iframe into the document, with the src 
31193: // containing the test doctype.  The iframe's onload
31193: // function is set to call the test's verification step.
31193: //
10334: function insert_iframe(doctype,expected) {
10334:   var elm = document.createElement('iframe');
31193:   elm.setAttribute('src', 'data:text/html,' + doctype +
31193:     '<html><body onload="parent.test(document.compatMode,'+i+')"></body>');
10334:   elm.setAttribute('style', 'display:none');
10334:   document.getElementsByTagName('body')[0].appendChild(elm);
10334: }
10334: 
31193: ////
31193: // First iteration of the compatibility mode tests, without
31193: // the HTML5 parser enabled.
31193: //
31193: function doTest() {
10334:   for (i=0; i < doctypes.length; i+=2) {
10334:     insert_iframe(doctypes[i+1],doctypes[i]);
10334:   }
31193: }
31193: 
31193: ////
31193: // Run the compatbility mode tests.  First, the tests are run
31193: // without the HTML5 parser enabled.  Completing the last test
31193: // then triggers a second iteration, this time with the HTML5
31193: // parser enabled.
31193: //
31193: var gOriginalHtml5Pref;
31193: SimpleTest.waitForExplicitFinish();
31193: doTest();
10334: 
10334: </script>
10334: </pre>
10334: </body>
10334: </html>
