 41554: /* Any copyright is dedicated to the Public Domain.
 41554:  * http://creativecommons.org/publicdomain/zero/1.0/
 41554:  */
 41554: 
 41554: // This verifies that AddonUpdateChecker works correctly
 41554: 
 41554: Components.utils.import("resource://gre/modules/AddonUpdateChecker.jsm");
 41554: 
107780: Components.utils.import("resource://testing-common/httpd.js");
 84412: var testserver;
 84412: 
 84412: function run_test() {
 84412:   createAppInfo("xpcshell@tests.mozilla.org", "XPCShell", "1", "1.9.2");
 83134: 
 41554:   // Create and configure the HTTP server.
107780:   testserver = new HttpServer();
 41554:   testserver.registerDirectory("/data/", do_get_file("data"));
 41554:   testserver.start(4444);
 41554: 
 41554:   do_test_pending();
 41554:   run_test_1();
 41554: }
 41554: 
 41554: function end_test() {
 41554:   testserver.stop(do_test_finished);
 41554: }
 41554: 
 41554: // Test that a basic update check returns the expected available updates
 41554: function run_test_1() {
 41554:   AddonUpdateChecker.checkForUpdates("updatecheck1@tests.mozilla.org", "extension", null,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       check_test_1(updates);
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function check_test_1(updates) {
 41554:   do_check_eq(updates.length, 5);
 41554:   let update = AddonUpdateChecker.getNewestCompatibleUpdate(updates);
 41554:   do_check_neq(update, null);
 41554:   do_check_eq(update.version, 3);
 41554:   update = AddonUpdateChecker.getCompatibilityUpdate(updates, "2");
 41554:   do_check_neq(update, null);
 41554:   do_check_eq(update.version, 2);
 41554:   do_check_eq(update.targetApplications[0].minVersion, 1);
 41554:   do_check_eq(update.targetApplications[0].maxVersion, 2);
 41554: 
 41554:   run_test_2();
 41554: }
 41554: 
 41554: /*
 41554:  * Tests that the security checks are applied correctly
 41554:  *
 41554:  * Test     signature   updateHash  updateLink   expected
 41554:  *--------------------------------------------------------
 41554:  * 2        absent      absent      http         fail
 41554:  * 3        broken      absent      http         fail
 41554:  * 4        correct     absent      http         no update
 41554:  * 5        correct     sha1        http         update
 41554:  * 6        corrent     absent      https        update
 41554:  * 7        corrent     sha1        https        update
 41554:  * 8        corrent     md2         http         no update
 41554:  * 9        corrent     md2         https        update
 41554:  */
 41554: 
 41554: let updateKey = "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDK426erD/H3XtsjvaB5+PJqbhj" +
 41554:                 "Zc9EDI5OCJS8R3FIObJ9ZHJK1TXeaE7JWqt9WUmBWTEFvwS+FI9vWu8058N9CHhD" +
 41554:                 "NyeP6i4LuUYjTURnn7Yw/IgzyIJ2oKsYa32RuxAyteqAWqPT/J63wBixIeCxmysf" +
 41554:                 "awB/zH4KaPiY3vnrzQIDAQAB";
 41554: 
 41554: function run_test_2() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_5@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_throw("Expected the update check to fail");
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       run_test_3();
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_3() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_7@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_throw("Expected the update check to fail");
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       run_test_4();
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_4() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_8@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_false("updateURL" in updates[0]);
 41554:       run_test_5();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_5() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_9@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_eq(updates[0].version, "2.0");
 41554:       do_check_true("updateURL" in updates[0]);
 41554:       run_test_6();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_6() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_10@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_eq(updates[0].version, "2.0");
 41554:       do_check_true("updateURL" in updates[0]);
 41554:       run_test_7();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_7() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_11@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_eq(updates[0].version, "2.0");
 41554:       do_check_true("updateURL" in updates[0]);
 41554:       run_test_8();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_8() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_12@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_false("updateURL" in updates[0]);
 41554:       run_test_9();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 41554: 
 41554: function run_test_9() {
 41554:   AddonUpdateChecker.checkForUpdates("test_bug378216_13@tests.mozilla.org",
 41554:                                      "extension", updateKey,
 41554:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 41554:     onUpdateCheckComplete: function(updates) {
 41554:       do_check_eq(updates.length, 1);
 41554:       do_check_eq(updates[0].version, "2.0");
 41554:       do_check_true("updateURL" in updates[0]);
 69712:       run_test_10();
 41554:     },
 41554: 
 41554:     onUpdateCheckError: function(status) {
 41554:       do_throw("Update check failed with status " + status);
 41554:     }
 41554:   });
 41554: }
 69712: 
 69712: function run_test_10() {
 69712:   AddonUpdateChecker.checkForUpdates("test_bug378216_14@tests.mozilla.org",
 69712:                                      "extension", null,
 69712:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 69712:     onUpdateCheckComplete: function(updates) {
 69712:       do_check_eq(updates.length, 0);
 69712:       run_test_11();
 69712:     },
 69712: 
 69712:     onUpdateCheckError: function(status) {
 69712:       do_throw("Update check failed with status " + status);
 69712:     }
 69712:   });
 69712: }
 69712: 
 69712: function run_test_11() {
 69712:   AddonUpdateChecker.checkForUpdates("test_bug378216_15@tests.mozilla.org",
 69712:                                      "extension", null,
 69712:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 69712:     onUpdateCheckComplete: function(updates) {
 69712:       do_throw("Update check should have failed");
 69712:     },
 69712: 
 69712:     onUpdateCheckError: function(status) {
 69712:       do_check_eq(status, AddonUpdateChecker.ERROR_PARSE_ERROR);
 83134:       run_test_12();
 69712:     }
 69712:   });
 69712: }
 83134: 
 83134: function run_test_12() {
 83134:   AddonUpdateChecker.checkForUpdates("ignore-compat@tests.mozilla.org",
 83134:                                      "extension", null,
 83134:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 83134:     onUpdateCheckComplete: function(updates) {
 83134:       do_check_eq(updates.length, 3);
 83134:       let update = AddonUpdateChecker.getNewestCompatibleUpdate(updates,
 83134:                                                                 null,
 83134:                                                                 null,
 83134:                                                                 true);
 83134:       do_check_neq(update, null);
 83134:       do_check_eq(update.version, 2);
 83134:       run_test_13();
 83134:     },
 83134: 
 83134:     onUpdateCheckError: function(status) {
 83134:       do_throw("Update check failed with status " + status);
 83134:     }
 83134:   });
 83134: }
 83134: 
 83134: function run_test_13() {
 83134:   AddonUpdateChecker.checkForUpdates("compat-override@tests.mozilla.org",
 83134:                                      "extension", null,
 83134:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 83134:     onUpdateCheckComplete: function(updates) {
 83134:       do_check_eq(updates.length, 3);
 83134:       let overrides = [{
 83134:         type: "incompatible",
 83134:         minVersion: 1,
 83134:         maxVersion: 2,
 83134:         appID: "xpcshell@tests.mozilla.org",
 83134:         appMinVersion: 0.1,
 83134:         appMaxVersion: 0.2
 83134:       }, {
 83134:         type: "incompatible",
 83134:         minVersion: 2,
 83134:         maxVersion: 2,
 83134:         appID: "xpcshell@tests.mozilla.org",
 83134:         appMinVersion: 1,
 83134:         appMaxVersion: 2
 83134:       }];
 83134:       let update = AddonUpdateChecker.getNewestCompatibleUpdate(updates,
 83134:                                                                 null,
 83134:                                                                 null,
 83134:                                                                 true,
 83135:                                                                 false,
 83134:                                                                 overrides);
 83134:       do_check_neq(update, null);
 83134:       do_check_eq(update.version, 1);
 83135:       run_test_14();
 83135:     },
 83135: 
 83135:     onUpdateCheckError: function(status) {
 83135:       do_throw("Update check failed with status " + status);
 83135:     }
 83135:   });
 83135: }
 83135: 
 83135: function run_test_14() {
 83135:   AddonUpdateChecker.checkForUpdates("compat-strict-optin@tests.mozilla.org",
 83135:                                      "extension", null,
 83135:                                      "http://localhost:4444/data/test_updatecheck.rdf", {
 83135:     onUpdateCheckComplete: function(updates) {
 83135:       do_check_eq(updates.length, 1);
 83135:       let update = AddonUpdateChecker.getNewestCompatibleUpdate(updates,
 83135:                                                                 null,
 83135:                                                                 null,
 83135:                                                                 true,
 83135:                                                                 false);
 83135:       do_check_eq(update, null);
 83134:       end_test();
 83134:     },
 83134: 
 83134:     onUpdateCheckError: function(status) {
 83134:       do_throw("Update check failed with status " + status);
 83134:     }
 83134:   });
 83134: }
