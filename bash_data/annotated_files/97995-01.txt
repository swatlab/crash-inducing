    1: /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
    1:  *
    1:  * ***** BEGIN LICENSE BLOCK *****
    1:  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
    1:  *
    1:  * The contents of this file are subject to the Mozilla Public License Version
    1:  * 1.1 (the "License"); you may not use this file except in compliance with
    1:  * the License. You may obtain a copy of the License at
    1:  * http://www.mozilla.org/MPL/
    1:  *
    1:  * Software distributed under the License is distributed on an "AS IS" basis,
    1:  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
    1:  * for the specific language governing rights and limitations under the
    1:  * License.
    1:  *
    1:  * The Original Code is mozilla.org code.
    1:  *
    1:  * The Initial Developer of the Original Code is
    1:  * Netscape Communications Corporation.
    1:  * Portions created by the Initial Developer are Copyright (C) 2001
    1:  * the Initial Developer. All Rights Reserved.
    1:  *
    1:  * Contributor(s):
    1:  *   Stuart Parmenter <pavlov@netscape.com>
    1:  *
    1:  * Alternatively, the contents of this file may be used under the terms of
    1:  * either the GNU General Public License Version 2 or later (the "GPL"), or
    1:  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
    1:  * in which case the provisions of the GPL or the LGPL are applicable instead
    1:  * of those above. If you wish to allow use of your version of this file only
    1:  * under the terms of either the GPL or the LGPL, and not to allow others to
    1:  * use your version of this file under the terms of the MPL, indicate your
    1:  * decision by deleting the provisions above and replace them with the notice
    1:  * and other provisions required by the GPL or the LGPL. If you do not delete
    1:  * the provisions above, a recipient may use your version of this file under
    1:  * the terms of any one of the MPL, the GPL or the LGPL.
    1:  *
    1:  * ***** END LICENSE BLOCK ***** */
    1: 
46998: #include "mozilla/ModuleUtils.h"
    1: 
50551: #include "RasterImage.h"
48312: 
48312: /* We end up pulling in windows.h because we eventually hit gfxWindowsSurface;
48312:  * windows.h defines LoadImage, so we have to #undef it or imgLoader::LoadImage
48312:  * gets changed.
48312:  * This #undef needs to be in multiple places because we don't always pull
48312:  * headers in in the same order.
48312:  */
48312: #undef LoadImage
48312: 
    1: #include "imgLoader.h"
    1: #include "imgRequest.h"
    1: #include "imgRequestProxy.h"
10224: #include "imgTools.h"
50548: #include "DiscardTracker.h"
    1: 
77232: #include "nsICOEncoder.h"
    1: #include "nsPNGEncoder.h"
    1: #include "nsJPEGEncoder.h"
77230: #include "nsBMPEncoder.h"
    1: 
    1: // objects that just require generic constructors
50549: namespace mozilla {
87852: namespace image {
50549: NS_GENERIC_FACTORY_CONSTRUCTOR(RasterImage)
50549: }
50549: }
87852: using namespace mozilla::image;
    1: 
30324: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(imgLoader, Init)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(imgRequestProxy)
10224: NS_GENERIC_FACTORY_CONSTRUCTOR(imgTools)
77232: NS_GENERIC_FACTORY_CONSTRUCTOR(nsICOEncoder)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsJPEGEncoder)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsPNGEncoder)
77230: NS_GENERIC_FACTORY_CONSTRUCTOR(nsBMPEncoder)
46998: NS_DEFINE_NAMED_CID(NS_IMGLOADER_CID);
46998: NS_DEFINE_NAMED_CID(NS_IMGREQUESTPROXY_CID);
46998: NS_DEFINE_NAMED_CID(NS_IMGTOOLS_CID);
50549: NS_DEFINE_NAMED_CID(NS_RASTERIMAGE_CID);
77232: NS_DEFINE_NAMED_CID(NS_ICOENCODER_CID);
46998: NS_DEFINE_NAMED_CID(NS_JPEGENCODER_CID);
46998: NS_DEFINE_NAMED_CID(NS_PNGENCODER_CID);
77230: NS_DEFINE_NAMED_CID(NS_BMPENCODER_CID);
46998: 
46998: static const mozilla::Module::CIDEntry kImageCIDs[] = {
46998:   { &kNS_IMGLOADER_CID, false, NULL, imgLoaderConstructor, },
46998:   { &kNS_IMGREQUESTPROXY_CID, false, NULL, imgRequestProxyConstructor, },
46998:   { &kNS_IMGTOOLS_CID, false, NULL, imgToolsConstructor, },
50549:   { &kNS_RASTERIMAGE_CID, false, NULL, RasterImageConstructor, },
77232:   { &kNS_ICOENCODER_CID, false, NULL, nsICOEncoderConstructor, },
46998:   { &kNS_JPEGENCODER_CID, false, NULL, nsJPEGEncoderConstructor, },
46998:   { &kNS_PNGENCODER_CID, false, NULL, nsPNGEncoderConstructor, },
77230:   { &kNS_BMPENCODER_CID, false, NULL, nsBMPEncoderConstructor, },
46998:   { NULL }
    1: };
    1: 
46998: static const mozilla::Module::ContractIDEntry kImageContracts[] = {
46998:   { "@mozilla.org/image/cache;1", &kNS_IMGLOADER_CID },
46998:   { "@mozilla.org/image/loader;1", &kNS_IMGLOADER_CID },
46998:   { "@mozilla.org/image/request;1", &kNS_IMGREQUESTPROXY_CID },
46998:   { "@mozilla.org/image/tools;1", &kNS_IMGTOOLS_CID },
50549:   { "@mozilla.org/image/rasterimage;1", &kNS_RASTERIMAGE_CID },
77232:   { "@mozilla.org/image/encoder;2?type=image/vnd.microsoft.icon", &kNS_ICOENCODER_CID },
46998:   { "@mozilla.org/image/encoder;2?type=image/jpeg", &kNS_JPEGENCODER_CID },
46998:   { "@mozilla.org/image/encoder;2?type=image/png", &kNS_PNGENCODER_CID },
77230:   { "@mozilla.org/image/encoder;2?type=image/bmp", &kNS_BMPENCODER_CID },
46998:   { NULL }
46998: };
46998: 
46998: static const mozilla::Module::CategoryEntry kImageCategories[] = {
46998:   { "Gecko-Content-Viewers", "image/gif", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/jpeg", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/pjpeg", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/jpg", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/x-icon", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/vnd.microsoft.icon", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/bmp", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/x-ms-bmp", "@mozilla.org/content/document-loader-factory;1" },
50542:   { "Gecko-Content-Viewers", "image/icon", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/png", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "Gecko-Content-Viewers", "image/x-png", "@mozilla.org/content/document-loader-factory;1" },
46998:   { "content-sniffing-services", "@mozilla.org/image/loader;1", "@mozilla.org/image/loader;1" },
46998:   { NULL }
    1: };
    1: 
20261: static nsresult
46998: imglib_Initialize()
    1: {
97995:   mozilla::image::DiscardTracker::Initialize();
18827:   imgLoader::InitCache();
    1:   return NS_OK;
    1: }
    1: 
20261: static void
46998: imglib_Shutdown()
    1: {
18827:   imgLoader::Shutdown();
87852:   mozilla::image::DiscardTracker::Shutdown();
    1: }
    1: 
46998: static const mozilla::Module kImageModule = {
46998:   mozilla::Module::kVersion,
46998:   kImageCIDs,
46998:   kImageContracts,
46998:   kImageCategories,
46998:   NULL,
46998:   imglib_Initialize,
46998:   imglib_Shutdown
46998: };
    1: 
46998: NSMODULE_DEFN(nsImageLib2Module) = &kImageModule;
