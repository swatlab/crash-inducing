 51933: function test() {
 51933: 
 51933:   // ----------
 51933:   // Test setup
 51933: 
 51933:   waitForExplicitFinish();
 51933: 
137506:   let oldOLC = FullZoom.onLocationChange;
137506:   FullZoom.onLocationChange = function(aURI, aIsTabSwitch, aBrowser) {
137506:     // Ignore calls that are not about tab switching on this test
137506:     if (aIsTabSwitch)
137506:       oldOLC.call(FullZoom, aURI, aIsTabSwitch, aBrowser);
137506:   };
137506: 
 51933:   gPrefService.setBoolPref("browser.zoom.updateBackgroundTabs", true);
 51933:   gPrefService.setBoolPref("browser.zoom.siteSpecific", true);
 51933: 
137506:   let oldAPTS = FullZoom._applyPrefToSetting;
 51933:   let uri = "http://example.org/browser/browser/base/content/test/dummy_page.html";
 51933: 
137506:   let tab = gBrowser.addTab();
137506:   tab.linkedBrowser.addEventListener("load", function(event) {
137506:     tab.linkedBrowser.removeEventListener("load", arguments.callee, true);
 51933: 
 51933:     // -------------------------------------------------------------------
 59709:     // Test - Trigger a tab switch that should update the zoom level
137506:     FullZoom._applyPrefToSetting = function() {
 51933:       ok(true, "applyPrefToSetting was called");
137506:       endTest();
 51933:     }
137506:     gBrowser.selectedTab = tab;
137506: 
137506:   }, true); 
137506:   tab.linkedBrowser.loadURI(uri);
 51933: 
 51933:   // -------------
 51933:   // Test clean-up
 51933:   function endTest() {
137506:     FullZoom._applyPrefToSetting = oldAPTS;
137506:     FullZoom.onLocationChange = oldOLC;
 52406:     gBrowser.removeTab(tab);
 51933: 
137506:     oldAPTS = null;
137506:     oldOLC = null;
 51933:     tab = null;
 51933: 
 51933:     if (gPrefService.prefHasUserValue("browser.zoom.updateBackgroundTabs"))
 51933:       gPrefService.clearUserPref("browser.zoom.updateBackgroundTabs");
 51933: 
 51933:     if (gPrefService.prefHasUserValue("browser.zoom.siteSpecific"))
 51933:       gPrefService.clearUserPref("browser.zoom.siteSpecific");
 51933: 
 51933:     finish();
 51933:   }
137506: 
137506: }
137506: 
