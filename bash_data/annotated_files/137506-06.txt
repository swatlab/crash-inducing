 98983: /* This Source Code Form is subject to the terms of the Mozilla Public
 98983:  * License, v. 2.0. If a copy of the MPL was not distributed with this
 98983:  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 17075: 
 17075: /*
 17075:  * Test the fix for bug 441778 to ensure site-specific page zoom doesn't get
 17075:  * modified by sub-document loads of content from a different domain.
 17075:  */
 17075: 
 17075: function test() {
 17075:   waitForExplicitFinish();
 17075: 
 34999:   const TEST_PAGE_URL = 'data:text/html,<body><iframe src=""></iframe></body>';
 34999:   const TEST_IFRAME_URL = "http://test2.example.org/";
 17075: 
 17075:   // Prepare the test tab
137506:   gBrowser.selectedTab = gBrowser.addTab();
137506:   let testBrowser = gBrowser.selectedBrowser;
 17075: 
137506:   testBrowser.addEventListener("load", function () {
137506:     testBrowser.removeEventListener("load", arguments.callee, true);
 17075: 
 17075:     // Change the zoom level and then save it so we can compare it to the level
 17075:     // after loading the sub-document.
137506:     FullZoom.enlarge();
 34999:     var zoomLevel = ZoomManager.zoom;
 17075: 
 17075:     // Start the sub-document load.
 34999:     executeSoon(function () {
 34999:       testBrowser.addEventListener("load", function (e) {
 34999:         testBrowser.removeEventListener("load", arguments.callee, true);
 17075: 
 34999:         is(e.target.defaultView.location, TEST_IFRAME_URL, "got the load event for the iframe");
 34999:         is(ZoomManager.zoom, zoomLevel, "zoom is retained after sub-document load");
 22395: 
 34999:         gBrowser.removeCurrentTab();
137506:         finish();
 34999:       }, true);
 34999:       content.document.querySelector("iframe").src = TEST_IFRAME_URL;
 34999:     });
137506:   }, true);
137506: 
137506:   content.location = TEST_PAGE_URL;
 17075: }
