 98983: /* This Source Code Form is subject to the terms of the Mozilla Public
 98983:  * License, v. 2.0. If a copy of the MPL was not distributed with this
 98983:  * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 31149:  */
 31149: 
 31149: // Finds the test plugin library
 31149: function get_test_plugin() {
126164:   var pluginEnum = gDirSvc.get("APluginsDL", Ci.nsISimpleEnumerator);
126164:   while (pluginEnum.hasMoreElements()) {
126164:     let dir = pluginEnum.getNext().QueryInterface(Ci.nsILocalFile);
126164:     let plugin = dir.clone();
 31149:     // OSX plugin
 31149:     plugin.append("Test.plugin");
 31149:     if (plugin.exists()) {
 31149:       plugin.normalize();
 31149:       return plugin;
 31149:     }
126164:     plugin = dir.clone();
 31149:     // *nix plugin
 31149:     plugin.append("libnptest.so");
 31149:     if (plugin.exists()) {
 31149:       plugin.normalize();
 31149:       return plugin;
 31149:     }
 31149:     // Windows plugin
126164:     plugin = dir.clone();
 31149:     plugin.append("nptest.dll");
 31149:     if (plugin.exists()) {
 31149:       plugin.normalize();
 31149:       return plugin;
 31149:     }
126164:   }
 31149:   return null;
 31149: }
129942: 
129942: // Finds the test nsIPluginTag
129942: function get_test_plugintag() {
129942:   const Cc = Components.classes;
129942:   const Ci = Components.interfaces;
129942: 
129942:   var host = Cc["@mozilla.org/plugin/host;1"].
129942:              getService(Ci.nsIPluginHost);
129942:   var tags = host.getPluginTags();
129942:   for (var i = 0; i < tags.length; i++) {
129942:     if (tags[i].name == "Test Plug-in")
129942:       return tags[i];
129942:   }
129942:   return null;
129942: }
129942: 
129942: // Creates a fake ProfDS directory key, copied from do_get_profile
129942: function do_get_profile_startup() {
129942:   let env = Components.classes["@mozilla.org/process/environment;1"]
129942:                       .getService(Components.interfaces.nsIEnvironment);
129942:   // the python harness sets this in the environment for us
129942:   let profd = env.get("XPCSHELL_TEST_PROFILE_DIR");
129942:   let file = Components.classes["@mozilla.org/file/local;1"]
129942:                        .createInstance(Components.interfaces.nsILocalFile);
129942:   file.initWithPath(profd);
129942: 
129942:   let dirSvc = Components.classes["@mozilla.org/file/directory_service;1"]
129942:                          .getService(Components.interfaces.nsIProperties);
129942:   let provider = {
129942:     getFile: function(prop, persistent) {
129942:       persistent.value = true;
129942:       if (prop == "ProfDS") {
129942:         return file.clone();
129942:       }
129942:       throw Components.results.NS_ERROR_FAILURE;
129942:     },
129942:     QueryInterface: function(iid) {
129942:       if (iid.equals(Components.interfaces.nsIDirectoryServiceProvider) ||
129942:           iid.equals(Components.interfaces.nsISupports)) {
129942:         return this;
129942:       }
129942:       throw Components.results.NS_ERROR_NO_INTERFACE;
129942:     }
129942:   };
129942:   dirSvc.QueryInterface(Components.interfaces.nsIDirectoryService)
129942:         .registerProvider(provider);
129942:   return file.clone();
129942: }
