 98983: /* This Source Code Form is subject to the terms of the Mozilla Public
 98983:  * License, v. 2.0. If a copy of the MPL was not distributed with this
 98983:  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
     1: 
108496: #include "base/basictypes.h"
108496: 
     1: #include "nsLayoutStatics.h"
     1: #include "nscore.h"
     1: 
     1: #include "nsAttrValue.h"
     1: #include "nsAutoCopyListener.h"
     1: #include "nsColorNames.h"
     1: #include "nsComputedDOMStyle.h"
     1: #include "nsContentDLF.h"
     1: #include "nsContentUtils.h"
     1: #include "nsCSSAnonBoxes.h"
122036: #include "mozilla/css/ErrorReporter.h"
     1: #include "nsCSSKeywords.h"
 38849: #include "nsCSSParser.h"
     1: #include "nsCSSProps.h"
     1: #include "nsCSSPseudoClasses.h"
     1: #include "nsCSSPseudoElements.h"
     1: #include "nsCSSRendering.h"
     1: #include "nsDOMAttribute.h"
     1: #include "nsDOMClassInfo.h"
     1: #include "nsEventListenerManager.h"
     1: #include "nsFrame.h"
     1: #include "nsGlobalWindow.h"
     1: #include "nsGkAtoms.h"
     1: #include "nsImageFrame.h"
     1: #include "nsLayoutStylesheetCache.h"
     1: #include "nsNodeInfo.h"
     1: #include "nsRange.h"
 32353: #include "nsRegion.h"
     1: #include "nsRepeatService.h"
 23306: #include "nsFloatManager.h"
     1: #include "nsSprocketLayout.h"
     1: #include "nsStackLayout.h"
     1: #include "nsStyleSet.h"
     1: #include "nsTextControlFrame.h"
     1: #include "nsXBLWindowKeyHandler.h"
 99253: #include "nsXBLService.h"
     1: #include "txMozillaXSLTProcessor.h"
     1: #include "nsDOMStorage.h"
 74556: #include "nsTreeSanitizer.h"
     1: #include "nsCellMap.h"
  1327: #include "nsTextFrameTextRunCache.h"
  1353: #include "nsCCUncollectableMarker.h"
  3049: #include "nsTextFragment.h"
  8187: #include "nsCSSRuleProcessor.h"
 64069: #include "nsCrossSiteListenerProxy.h"
 21577: #include "nsHTMLDNSPrefetch.h"
 29805: #include "nsHtml5Module.h"
 29018: #include "nsFocusManager.h"
 30781: #include "nsFrameList.h"
 31248: #include "nsListControlFrame.h"
 51580: #include "nsHTMLInputElement.h"
 43773: #include "nsSVGUtils.h"
 71203: #include "nsMathMLAtoms.h"
 71203: #include "nsMathMLOperators.h"
 81313: #include "Navigator.h"
113879: #include "nsDOMStorageBaseDB.h"
     1: 
124804: #include "AudioChannelService.h"
124804: 
     1: #ifdef MOZ_XUL
  3799: #include "nsXULPopupManager.h"
     1: #include "nsXULContentUtils.h"
     1: #include "nsXULPrototypeCache.h"
   502: #include "nsXULTooltipListener.h"
  3604: 
  3604: #include "inDOMView.h"
  3604: #endif
     1: 
     1: #include "nsHTMLEditor.h"
     1: #include "nsTextServicesDocument.h"
     1: 
 99962: #ifdef MOZ_MEDIA_PLUGINS
121916: #include "MediaPluginHost.h"
 99962: #endif
 99962: 
 21394: #ifdef MOZ_SYDNEYAUDIO
121916: #include "AudioStream.h"
 16300: #endif
 16300: 
     1: #include "nsError.h"
     1: 
 11957: #include "nsCycleCollector.h"
 19157: #include "nsJSEnvironment.h"
 41408: #include "nsContentSink.h"
 49304: #include "nsFrameMessageManager.h"
 63688: #include "nsRefreshDriver.h"
 94465: #include "nsDOMMutationObserver.h"
 69311: #include "nsHyphenationManager.h"
 77070: #include "nsEditorSpellCheck.h"
 91414: #include "nsWindowMemoryReporter.h"
108496: #include "mozilla/dom/ContentParent.h"
107484: #include "mozilla/dom/ipc/ProcessPriorityManager.h"
110878: #include "nsPermissionManager.h"
115219: #include "nsCookieService.h"
115835: #include "nsApplicationCacheService.h"
119197: #include "mozilla/dom/time/DateCacheCleaner.h"
119248: #include "nsIMEStateManager.h"
 69311: 
 29260: extern void NS_ShutdownChainItemPool();
 29260: 
 63836: using namespace mozilla;
 87527: using namespace mozilla::dom;
107484: using namespace mozilla::dom::ipc;
119197: using namespace mozilla::dom::time;
 63836: 
 42131: nsrefcnt nsLayoutStatics::sLayoutStaticRefcnt = 0;
     1: 
     1: nsresult
     1: nsLayoutStatics::Initialize()
     1: {
     1:   NS_ASSERTION(sLayoutStaticRefcnt == 0,
     1:                "nsLayoutStatics isn't zero!");
     1: 
     1:   sLayoutStaticRefcnt = 1;
     1:   NS_LOG_ADDREF(&sLayoutStaticRefcnt, sLayoutStaticRefcnt,
     1:                 "nsLayoutStatics", 1);
     1: 
     1:   nsresult rv;
     1: 
108496:   ContentParent::StartUp();
108496: 
   265:   // Register all of our atoms once
   265:   nsCSSAnonBoxes::AddRefAtoms();
   265:   nsCSSPseudoClasses::AddRefAtoms();
   265:   nsCSSPseudoElements::AddRefAtoms();
   265:   nsCSSKeywords::AddRefTable();
   265:   nsCSSProps::AddRefTable();
   265:   nsColorNames::AddRefTable();
   265:   nsGkAtoms::AddRefAtoms();
   265: 
 19157:   nsJSRuntime::Startup();
 32353:   rv = nsRegion::InitStatic();
 32353:   if (NS_FAILED(rv)) {
 32353:     NS_ERROR("Could not initialize nsRegion");
 32353:     return rv;
 32353:   }
 32353: 
 77579:   nsGlobalWindow::Init();
 87527:   Navigator::Init();
 99253:   nsXBLService::Init();
 77579: 
     1:   rv = nsContentUtils::Init();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize nsContentUtils");
     1:     return rv;
     1:   }
     1: 
     1:   rv = nsAttrValue::Init();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize nsAttrValue");
     1:     return rv;
     1:   }
     1: 
     1:   rv = nsTextFragment::Init();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize nsTextFragment");
     1:     return rv;
     1:   }
     1: 
 73868:   nsCellMap::Init();
     1: 
 71172:   nsCSSRendering::Init();
     1: 
 72507:   nsTextFrameTextRunCache::Init();
  1327: 
 21577:   rv = nsHTMLDNSPrefetch::Initialize();
 21577:   if (NS_FAILED(rv)) {
 21577:     NS_ERROR("Could not initialize HTML DNS prefetch");
 21577:     return rv;
 21577:   }
 21577: 
     1: #ifdef MOZ_XUL
     1:   rv = nsXULContentUtils::Init();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize nsXULContentUtils");
     1:     return rv;
     1:   }
  3603: 
  3603:   inDOMView::InitAtoms();
  3603: 
     1: #endif
     1: 
     1:   nsMathMLOperators::AddRefTable();
     1: 
     1:   nsEditProperty::RegisterAtoms();
     1:   nsTextServicesDocument::RegisterAtoms();
     1: 
     1: #ifdef DEBUG
     1:   nsFrame::DisplayReflowStartup();
     1: #endif
     1:   nsDOMAttribute::Initialize();
     1: 
  3582:   rv = txMozillaXSLTProcessor::Startup();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize txMozillaXSLTProcessor");
     1:     return rv;
     1:   }
     1: 
     1:   rv = nsDOMStorageManager::Initialize();
     1:   if (NS_FAILED(rv)) {
     1:     NS_ERROR("Could not initialize nsDOMStorageManager");
     1:     return rv;
     1:   }
     1: 
  1353:   rv = nsCCUncollectableMarker::Init();
  1353:   if (NS_FAILED(rv)) {
  1353:     NS_ERROR("Could not initialize nsCCUncollectableMarker");
  1353:     return rv;
  1353:   }
  1353: 
 40547:   rv = nsCSSRuleProcessor::Startup();
 40547:   if (NS_FAILED(rv)) {
 40547:     NS_ERROR("Could not initialize nsCSSRuleProcessor");
 40547:     return rv;
 40547:   }
 20706: 
  3799: #ifdef MOZ_XUL
  3129:   rv = nsXULPopupManager::Init();
  3129:   if (NS_FAILED(rv)) {
  3129:     NS_ERROR("Could not initialize nsXULPopupManager");
  3129:     return rv;
  3129:   }
  3799: #endif
  3129: 
 29018:   rv = nsFocusManager::Init();
 29018:   if (NS_FAILED(rv)) {
 29018:     NS_ERROR("Could not initialize nsFocusManager");
 29018:     return rv;
 29018:   }
 29018: 
 21394: #ifdef MOZ_SYDNEYAUDIO
121916:   AudioStream::InitLibrary();
 16300: #endif
 16300: 
 41408:   nsContentSink::InitializeStatics();
 29805:   nsHtml5Module::InitializeStatics();
 82670:   nsLayoutUtils::Initialize();
 42982:   nsIPresShell::InitializeStatics();
 63688:   nsRefreshDriver::InitializeStatics();
 29805: 
 64070:   nsCORSListenerProxy::Startup();
 28680: 
 72506:   nsFrameList::Init();
 30781: 
 34937:   NS_SealStaticAtomTable();
 34937: 
 91414:   nsWindowMemoryReporter::Init();
 72690: 
 98710:   nsSVGUtils::Init();
 98710: 
107484:   InitProcessPriorityManager();
107484: 
110878:   nsPermissionManager::AppUninstallObserverInit();
116494:   nsCookieService::AppClearDataObserverInit();
115835:   nsApplicationCacheService::AppClearDataObserverInit();
110878: 
113879:   nsDOMStorageBaseDB::Init();
113879: 
119197:   InitializeDateCacheCleaner();
119197: 
     1:   return NS_OK;
     1: }
     1: 
     1: void
     1: nsLayoutStatics::Shutdown()
     1: {
 91414:   // Don't need to shutdown nsWindowMemoryReporter, that will be done by the
 91414:   // memory reporter manager.
 72690: 
 49304:   nsFrameScriptExecutor::Shutdown();
 29018:   nsFocusManager::Shutdown();
  3799: #ifdef MOZ_XUL
  3129:   nsXULPopupManager::Shutdown();
  3799: #endif
     1:   nsDOMStorageManager::Shutdown();
     1:   txMozillaXSLTProcessor::Shutdown();
     1:   nsDOMAttribute::Shutdown();
     1:   nsEventListenerManager::Shutdown();
119248:   nsIMEStateManager::Shutdown();
     1:   nsComputedDOMStyle::Shutdown();
 38849:   nsCSSParser::Shutdown();
 40547:   nsCSSRuleProcessor::Shutdown();
  1327:   nsTextFrameTextRunCache::Shutdown();
 21577:   nsHTMLDNSPrefetch::Shutdown();
     1:   nsCSSRendering::Shutdown();
     1: #ifdef DEBUG
     1:   nsFrame::DisplayReflowShutdown();
     1: #endif
     1:   nsCellMap::Shutdown();
 47753:   nsFrame::ShutdownLayerActivityTimer();
     1: 
     1:   // Release all of our atoms
     1:   nsColorNames::ReleaseTable();
     1:   nsCSSProps::ReleaseTable();
     1:   nsCSSKeywords::ReleaseTable();
     1:   nsRepeatService::Shutdown();
     1:   nsStackLayout::Shutdown();
     1:   nsBox::Shutdown();
     1: 
     1: #ifdef MOZ_XUL
     1:   nsXULContentUtils::Finish();
     1:   nsXULPrototypeCache::ReleaseGlobals();
     1:   nsSprocketLayout::Shutdown();
     1: #endif
     1: 
     1:   nsMathMLOperators::ReleaseTable();
     1: 
 23305:   nsFloatManager::Shutdown();
     1:   nsImageFrame::ReleaseGlobals();
     1: 
122036:   mozilla::css::ErrorReporter::ReleaseGlobals();
     1: 
     1:   nsTextFragment::Shutdown();
     1: 
     1:   nsAttrValue::Shutdown();
     1:   nsContentUtils::Shutdown();
 10498:   nsNodeInfo::ClearCache();
     1:   nsLayoutStylesheetCache::Shutdown();
     1:   NS_NameSpaceManagerShutdown();
     1: 
 19157:   nsJSRuntime::Shutdown();
     1:   nsGlobalWindow::ShutDown();
     1:   nsDOMClassInfo::ShutDown();
 31248:   nsListControlFrame::Shutdown();
     1:   nsXBLWindowKeyHandler::ShutDown();
 99253:   nsXBLService::Shutdown();
     1:   nsAutoCopyListener::Shutdown();
102920:   FrameLayerBuilder::Shutdown();
     1: 
 99962: #ifdef MOZ_MEDIA_PLUGINS
121916:   MediaPluginHost::Shutdown();  
 99962: #endif
 99962: 
 21394: #ifdef MOZ_SYDNEYAUDIO
121916:   AudioStream::ShutdownLibrary();
 16300: #endif
 20049: 
 64070:   nsCORSListenerProxy::Shutdown();
 29260:   
 42982:   nsIPresShell::ReleaseStatics();
 42982: 
 74556:   nsTreeSanitizer::ReleaseStatics();
 74556: 
 29805:   nsHtml5Module::ReleaseStatics();
 29805: 
 32353:   nsRegion::ShutdownStatic();
 32353: 
 29260:   NS_ShutdownChainItemPool();
 30781: 
 30781:   nsFrameList::Shutdown();
 38054: 
 51580:   nsHTMLInputElement::DestroyUploadLastDir();
 60450: 
 60450:   nsLayoutUtils::Shutdown();
 69311: 
 69311:   nsHyphenationManager::Shutdown();
 77070:   nsEditorSpellCheck::ShutDown();
 94465:   nsDOMMutationObserver::Shutdown();
108496: 
124804:   AudioChannelService::Shutdown();
124804: 
108496:   ContentParent::ShutDown();
125567: 
125567:   nsRefreshDriver::Shutdown();
     1: }
