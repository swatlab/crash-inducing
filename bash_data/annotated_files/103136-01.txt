 99874: /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
 99874: /* vim: set ts=2 et sw=2 tw=80: */
 99874: /* This Source Code Form is subject to the terms of the Mozilla Public
 99874:  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 99874:  * You can obtain one at http://mozilla.org/MPL/2.0/. */
 99874: 
 99874: #ifndef mozilla_net_AutoClose_h
 99874: #define mozilla_net_AutoClose_h
 99874: 
 99874: #include "nsCOMPtr.h"
 99874: 
 99874: namespace mozilla { namespace net {
 99874: 
 99874: // Like an nsAutoPtr for XPCOM streams (e.g. nsIAsyncInputStream) and other
 99874: // refcounted classes that need to have the Close() method called explicitly
 99874: // before they are destroyed.
 99874: template <typename T>
 99874: class AutoClose
 99874: {
 99874: public:
 99874:   AutoClose() { } 
 99874:   ~AutoClose(){
 99874:     Close();
 99874:   }
 99874: 
 99874:   operator bool() const
 99874:   {
 99874:     return mPtr;
 99874:   }
 99874: 
 99874:   already_AddRefed<T> forget()
 99874:   {
 99874:     return mPtr.forget();
 99874:   }
 99874: 
103136:   void takeOver(nsCOMPtr<T> & rhs)
103136:   {
103136:     Close();
103136:     mPtr = rhs.forget();
103136:   }
103136: 
 99874:   void takeOver(AutoClose<T> & rhs)
 99874:   {
 99874:     Close();
 99874:     mPtr = rhs.mPtr.forget();
 99874:   }
 99874: 
 99874:   void CloseAndRelease()
 99874:   {
 99874:     Close();
 99874:     mPtr = nsnull;
 99874:   }
 99874: 
 99874:   T* operator->() const
 99874:   {
 99874:     return mPtr.operator->();
 99874:   }
 99874: 
 99874: private:
 99874:   void Close()
 99874:   {
 99874:     if (mPtr) {
 99874:       mPtr->Close();
 99874:     }
 99874:   }
 99874: 
 99874:   void operator=(const AutoClose<T> &) MOZ_DELETE;
 99874:   AutoClose(const AutoClose<T> &) MOZ_DELETE;
 99874: 
 99874:   nsCOMPtr<T> mPtr;
 99874: };
 99874: 
 99874: } } // namespace mozilla::net
 99874: 
 99874: #endif // mozilla_net_AutoClose_h
