43113: /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-
43113:  *
43113:  * ***** BEGIN LICENSE BLOCK *****
43113:  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
43113:  *
43113:  * The contents of this file are subject to the Mozilla Public License Version
43113:  * 1.1 (the "License"); you may not use this file except in compliance with
43113:  * the License. You may obtain a copy of the License at
43113:  * http://www.mozilla.org/MPL/
43113:  *
43113:  * Software distributed under the License is distributed on an "AS IS" basis,
43113:  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
43113:  * for the specific language governing rights and limitations under the
43113:  * License.
43113:  *
43113:  * The Original Code is nsDiskCacheStreams.h, released
43113:  * June 13, 2001.
43113:  *
43113:  * The Initial Developer of the Original Code is
43113:  * Netscape Communications Corporation.
43113:  * Portions created by the Initial Developer are Copyright (C) 2001
43113:  * the Initial Developer. All Rights Reserved.
43113:  *
43113:  * Contributor(s):
43113:  *   Gordon Sheridan <gordon@netscape.com>
43113:  *
43113:  * Alternatively, the contents of this file may be used under the terms of
43113:  * either the GNU General Public License Version 2 or later (the "GPL"), or
43113:  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
43113:  * in which case the provisions of the GPL or the LGPL are applicable instead
43113:  * of those above. If you wish to allow use of your version of this file only
43113:  * under the terms of either the GPL or the LGPL, and not to allow others to
43113:  * use your version of this file under the terms of the MPL, indicate your
43113:  * decision by deleting the provisions above and replace them with the notice
43113:  * and other provisions required by the GPL or the LGPL. If you do not delete
43113:  * the provisions above, a recipient may use your version of this file under
43113:  * the terms of any one of the MPL, the GPL or the LGPL.
43113:  *
43113:  * ***** END LICENSE BLOCK ***** */
43113: 
43113: 
43113: #ifndef _nsDiskCacheStreams_h_
43113: #define _nsDiskCacheStreams_h_
43113: 
43113: #include "nsDiskCacheBinding.h"
43113: 
43113: #include "nsCache.h"
43113: 
43113: #include "nsIInputStream.h"
43113: #include "nsIOutputStream.h"
43113: 
43113: #include "pratom.h"
43113: 
43113: class nsDiskCacheInputStream;
43113: class nsDiskCacheOutputStream;
43113: class nsDiskCacheDevice;
43113: 
43113: class nsDiskCacheStreamIO : public nsISupports {
43113: public:
43113:              nsDiskCacheStreamIO(nsDiskCacheBinding *   binding);
43113:     virtual ~nsDiskCacheStreamIO();
43113:     
43113:     NS_DECL_ISUPPORTS
43113: 
43113:     nsresult    GetInputStream(PRUint32 offset, nsIInputStream ** inputStream);
43113:     nsresult    GetOutputStream(PRUint32 offset, nsIOutputStream ** outputStream);
43113: 
43113:     nsresult    CloseOutputStream(nsDiskCacheOutputStream * outputStream);
60325:     nsresult    CloseOutputStreamInternal(nsDiskCacheOutputStream * outputStream);
43113:         
43113:     nsresult    Write( const char * buffer,
43113:                        PRUint32     count,
43113:                        PRUint32 *   bytesWritten);
43113: 
43113:     nsresult    Seek(PRInt32 whence, PRInt32 offset);
43113:     nsresult    Tell(PRUint32 * position);    
43113:     nsresult    SetEOF();
43113: 
88288:     nsresult    ClearBinding();
43113:     
64101:     void        IncrementInputStreamCount() { PR_ATOMIC_INCREMENT(&mInStreamCount); }
43113:     void        DecrementInputStreamCount()
43113:                 {
64101:                     PR_ATOMIC_DECREMENT(&mInStreamCount);
43113:                     NS_ASSERTION(mInStreamCount >= 0, "mInStreamCount has gone negative");
43113:                 }
43113: 
43113:     // GCC 2.95.2 requires this to be defined, although we never call it.
43113:     // and OS/2 requires that it not be private
43113:     nsDiskCacheStreamIO() { NS_NOTREACHED("oops"); }
43113: private:
43113: 
43113: 
43113:     void        Close();
43113:     nsresult    OpenCacheFile(PRIntn flags, PRFileDesc ** fd);
43113:     nsresult    ReadCacheBlocks();
43113:     nsresult    FlushBufferToFile();
43113:     void        UpdateFileSize();
43113:     void        DeleteBuffer();
43113:     nsresult    Flush();
43113: 
43113: 
43113:     nsDiskCacheBinding *        mBinding;       // not an owning reference
43113:     nsDiskCacheDevice *         mDevice;
43113:     nsDiskCacheOutputStream *   mOutStream;     // not an owning reference
43113:     PRInt32                     mInStreamCount;
43113:     nsCOMPtr<nsILocalFile>      mLocalFile;
43113:     PRFileDesc *                mFD;
43113: 
43113:     PRUint32                    mStreamPos;     // for Output Streams
43113:     PRUint32                    mStreamEnd;
43113:     PRUint32                    mBufPos;        // current mark in buffer
43113:     PRUint32                    mBufEnd;        // current end of data in buffer
43113:     PRUint32                    mBufSize;       // current end of buffer
79445:     bool                        mBufDirty;
43113:     char *                      mBuffer;
43113:     
43113: };
43113: 
43113: #endif // _nsDiskCacheStreams_h_
