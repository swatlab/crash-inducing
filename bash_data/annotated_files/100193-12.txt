 87862: /* Any copyright is dedicated to the Public Domain.
 87862:    http://creativecommons.org/publicdomain/zero/1.0/ */
 87862: "use strict";
 87862: 
100193: let tiltOpened = false;
100193: 
 87862: function test() {
 87862:   if (!isTiltEnabled()) {
 87862:     info("Skipping part of the arcball test because Tilt isn't enabled.");
 87862:     return;
 87862:   }
 87862:   if (!isWebGLSupported()) {
 87862:     info("Skipping part of the arcball test because WebGL isn't supported.");
 87862:     return;
 87862:   }
 87862: 
 88193:   requestLongerTimeout(10);
 87862:   waitForExplicitFinish();
 87862:   Services.prefs.setBoolPref("accessibility.typeaheadfind", true);
 87862: 
 87862:   createTab(function() {
 87862:     createTilt({
 87862:       onTiltOpen: function(instance)
 87862:       {
100193:         tiltOpened = true;
100193: 
 87862:         performTest(instance.presenter.canvas,
 87862:                     instance.controller.arcball, function() {
 87862: 
 87862:           info("Killing arcball reset test.");
 87862: 
 87862:           Services.prefs.setBoolPref("accessibility.typeaheadfind", false);
 88393:           Services.obs.addObserver(cleanup, DESTROYED, false);
 87862:           InspectorUI.closeInspectorUI();
 87862:         });
 87862:       }
100193:     }, false, function suddenDeath()
100193:     {
100193:       info("Tilt could not be initialized properly.");
100193:       cleanup();
 87862:     });
 87862:   });
 87862: }
 87862: 
 87862: function performTest(canvas, arcball, callback) {
 87862:   is(document.activeElement, canvas,
 87862:     "The visualizer canvas should be focused when performing this test.");
 87862: 
 87862: 
 87862:   info("Starting arcball reset test.");
 87862: 
 87862:   // start translating and rotating sometime at random
 87862: 
 88393:   window.setTimeout(function() {
 87862:     info("Synthesizing key down events.");
 87862: 
 88393:     EventUtils.synthesizeKey("VK_S", { type: "keydown" });     // add a little
 88393:     EventUtils.synthesizeKey("VK_RIGHT", { type: "keydown" }); // diversity
 87862: 
 87862:     // wait for some arcball translations and rotations to happen
 87862: 
 88393:     window.setTimeout(function() {
 87862:       info("Synthesizing key up events.");
 87862: 
 88393:       EventUtils.synthesizeKey("VK_S", { type: "keyup" });
 88393:       EventUtils.synthesizeKey("VK_RIGHT", { type: "keyup" });
 87862: 
 87862:       // ok, transformations finished, we can now try to reset the model view
 87862: 
 88393:       window.setTimeout(function() {
 87862:         info("Synthesizing arcball reset key press.");
 87862: 
 91042:         arcball._onResetStart = function() {
 88193:           info("Starting arcball reset animation.");
 88193:         };
 88193: 
 91042:         arcball._onResetStep = function() {
 91040:           info("\nlastRot: " + quat4.str(arcball._lastRot) +
 91040:                "\ndeltaRot: " + quat4.str(arcball._deltaRot) +
 91040:                "\ncurrentRot: " + quat4.str(arcball._currentRot) +
 91040:                "\nlastTrans: " + vec3.str(arcball._lastTrans) +
 91040:                "\ndeltaTrans: " + vec3.str(arcball._deltaTrans) +
 91040:                "\ncurrentTrans: " + vec3.str(arcball._currentTrans) +
 91040:                "\nadditionalRot: " + vec3.str(arcball._additionalRot) +
 91040:                "\nadditionalTrans: " + vec3.str(arcball._additionalTrans) +
 91040:                "\nzoomAmount: " + arcball._zoomAmount);
 91040:         };
 91040: 
 91042:         arcball._onResetFinish = function() {
 87862:           ok(isApproxVec(arcball._lastRot, [0, 0, 0, 1]),
 87862:             "The arcball _lastRot field wasn't reset correctly.");
 87862:           ok(isApproxVec(arcball._deltaRot, [0, 0, 0, 1]),
 87862:             "The arcball _deltaRot field wasn't reset correctly.");
 87862:           ok(isApproxVec(arcball._currentRot, [0, 0, 0, 1]),
 87862:             "The arcball _currentRot field wasn't reset correctly.");
 87862: 
 87862:           ok(isApproxVec(arcball._lastTrans, [0, 0, 0]),
 87862:             "The arcball _lastTrans field wasn't reset correctly.");
 87862:           ok(isApproxVec(arcball._deltaTrans, [0, 0, 0]),
 87862:             "The arcball _deltaTrans field wasn't reset correctly.");
 87862:           ok(isApproxVec(arcball._currentTrans, [0, 0, 0]),
 87862:             "The arcball _currentTrans field wasn't reset correctly.");
 87862: 
 87862:           ok(isApproxVec(arcball._additionalRot, [0, 0, 0]),
 87862:             "The arcball _additionalRot field wasn't reset correctly.");
 87862:           ok(isApproxVec(arcball._additionalTrans, [0, 0, 0]),
 87862:             "The arcball _additionalTrans field wasn't reset correctly.");
 87862: 
 87862:           ok(isApproxVec([arcball._zoomAmount], [0]),
 87862:             "The arcball _zoomAmount field wasn't reset correctly.");
 87862: 
 91042:           executeSoon(function() {
 87862:             info("Finishing arcball reset test.");
 87862:             callback();
 91042:           });
 87862:         };
 87862: 
 87862:         EventUtils.synthesizeKey("VK_R", { type: "keydown" });
 88393: 
 88393:       }, Math.random() * 1000); // leave enough time for transforms to happen
 88393:     }, Math.random() * 1000);
 88393:   }, Math.random() * 1000);
 87862: }
 87862: 
 88396: function cleanup() {
 87862:   info("Cleaning up arcball reset test.");
 87862: 
100193:   if (tiltOpened) { Services.obs.removeObserver(cleanup, DESTROYED); }
 87862:   gBrowser.removeCurrentTab();
 87862:   finish();
 87862: }
