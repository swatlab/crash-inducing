 88191: /* Any copyright is dedicated to the Public Domain.
 88191:    http://creativecommons.org/publicdomain/zero/1.0/ */
 88191: "use strict";
 88191: 
100193: let nodeHighlighted = false;
 88393: let presenter;
 88393: 
 88191: function test() {
 88191:   if (!isTiltEnabled()) {
 88191:     info("Skipping highlight test because Tilt isn't enabled.");
 88191:     return;
 88191:   }
 88191:   if (!isWebGLSupported()) {
 88191:     info("Skipping highlight test because WebGL isn't supported.");
 88191:     return;
 88191:   }
 88191: 
 88191:   waitForExplicitFinish();
 88191: 
 88191:   createTab(function() {
 88191:     createTilt({
 88191:       onTiltOpen: function(instance)
 88191:       {
 88393:         presenter = instance.presenter;
 88393:         Services.obs.addObserver(whenHighlighting, HIGHLIGHTING, false);
 88191: 
 94260:         presenter._onInitializationFinished = function() {
 88191:           let contentDocument = presenter.contentWindow.document;
 88393:           let div = contentDocument.getElementById("first-law");
 88191: 
100193:           nodeHighlighted = true;
 89941:           presenter.highlightNode(div, "moveIntoView");
 88393:         };
 88393:       }
100193:     }, false, function suddenDeath()
100193:     {
100193:       info("Tilt could not be initialized properly.");
100193:       cleanup();
 88393:     });
 88393:   });
 88393: }
 88191: 
 88393: function whenHighlighting() {
 88191:   ok(presenter._currentSelection > 0,
 88191:     "Highlighting a node didn't work properly.");
 91042:   ok(!presenter._highlight.disabled,
 88191:     "After highlighting a node, it should be highlighted. D'oh.");
 91040:   ok(!presenter.controller.arcball._resetInProgress,
 89941:     "Highlighting a node that's already visible shouldn't trigger a reset.");
 88191: 
 88393:   executeSoon(function() {
 93471:     Services.obs.removeObserver(whenHighlighting, HIGHLIGHTING);
 88393:     Services.obs.addObserver(whenUnhighlighting, UNHIGHLIGHTING, false);
 88393:     presenter.highlightNode(null);
 88393:   });
 88393: }
 88393: 
 88393: function whenUnhighlighting() {
 88393:   ok(presenter._currentSelection < 0,
 88393:     "Unhighlighting a should remove the current selection.");
 91042:   ok(presenter._highlight.disabled,
 88393:     "After unhighlighting a node, it shouldn't be highlighted anymore. D'oh.");
 88393: 
 88393:   executeSoon(function() {
 93471:     Services.obs.removeObserver(whenUnhighlighting, UNHIGHLIGHTING);
 88393:     Services.obs.addObserver(cleanup, DESTROYED, false);
 88191:     InspectorUI.closeInspectorUI();
 88191:   });
 88191: }
 88191: 
 88191: function cleanup() {
100193:   if (nodeHighlighted) { Services.obs.removeObserver(cleanup, DESTROYED); }
 88191:   gBrowser.removeCurrentTab();
 88191:   finish();
 88191: }
