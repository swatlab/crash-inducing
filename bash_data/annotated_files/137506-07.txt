 98983: /* This Source Code Form is subject to the terms of the Mozilla Public
 98983:  * License, v. 2.0. If a copy of the MPL was not distributed with this
 98983:  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 40026: const TEST_PAGE = "/browser/browser/base/content/test/dummy_page.html";
 40026: var gTestTab, gBgTab, gTestZoom;
 40026: 
137506: function afterZoomAndLoad(aCallback, aTab) {
137506:   let didLoad = false;
137506:   let didZoom = false;
137506:   aTab.linkedBrowser.addEventListener("load", function() {
137506:     aTab.linkedBrowser.removeEventListener("load", arguments.callee, true);
137506:     didLoad = true;
137506:     if (didZoom)
137506:       executeSoon(aCallback);
137506:   }, true);
137506:   let oldAPTS = FullZoom._applyPrefToSetting;
137506:   FullZoom._applyPrefToSetting = function(value, browser) {
137506:     if (!value)
137506:       value = undefined;
137506:     oldAPTS.call(FullZoom, value, browser);
137506:     // Don't reset _applyPrefToSetting until we've seen the about:blank load(s)
137506:     if (browser && browser.currentURI.spec.startsWith("http:")) {
137506:       FullZoom._applyPrefToSetting = oldAPTS;
137506:       didZoom = true;
137506:     }
137506:     if (didLoad && didZoom)
137506:       executeSoon(aCallback);
137506:   };
137506: }
137506: 
 40026: function testBackgroundLoad() {
 40026:   is(ZoomManager.zoom, gTestZoom, "opening a background tab should not change foreground zoom");
 40026: 
 40026:   gBrowser.removeTab(gBgTab);
 40026: 
137506:   FullZoom.reset();
 40026:   gBrowser.removeTab(gTestTab);
137506: 
137506:   finish();
 40026: }
 40026: 
 40026: function testInitialZoom() {
 40026:   is(ZoomManager.zoom, 1, "initial zoom level should be 1");
137506:   FullZoom.enlarge();
 40026: 
 40026:   gTestZoom = ZoomManager.zoom;
 40026:   isnot(gTestZoom, 1, "zoom level should have changed");
 40026: 
137506:   afterZoomAndLoad(testBackgroundLoad,
137506:                    gBgTab = gBrowser.loadOneTab("http://mochi.test:8888" + TEST_PAGE,
137506:                                                 {inBackground: true}));
 40026: }
 40026: 
 40026: function test() {
 40026:   waitForExplicitFinish();
 40026: 
 40026:   gTestTab = gBrowser.addTab();
137506:   gBrowser.selectedTab = gTestTab;
137506: 
137506:   afterZoomAndLoad(testInitialZoom, gTestTab);
137506:   content.location = "http://example.org" + TEST_PAGE;
 40026: }
