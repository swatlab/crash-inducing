68747: /* ***** BEGIN LICENSE BLOCK *****
68747:  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
68747:  *
68747:  * The contents of this file are subject to the Mozilla Public License Version
68747:  * 1.1 (the "License"); you may not use this file except in compliance with
68747:  * the License. You may obtain a copy of the License at
68747:  * http://www.mozilla.org/MPL/
68747:  *
68747:  * Software distributed under the License is distributed on an "AS IS" basis,
68747:  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
68747:  * for the specific language governing rights and limitations under the
68747:  * License.
68747:  *
68747:  * The Original Code is mozilla.org code.
68747:  *
68747:  * The Initial Developer of the Original Code is
68747:  * The Mozilla Foundation.
68747:  * Portions created by the Initial Developer are Copyright (C) 2011
68747:  * the Initial Developer. All Rights Reserved.
68747:  *
68747:  * Contributor(s):
68747:  *   Ted Mielczarek <ted.mielczarek@gmail.com>
68747:  *
68747:  * Alternatively, the contents of this file may be used under the terms of
68747:  * either the GNU General Public License Version 2 or later (the "GPL"), or
68747:  * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
68747:  * in which case the provisions of the GPL or the LGPL are applicable instead
68747:  * of those above. If you wish to allow use of your version of this file only
68747:  * under the terms of either the GPL or the LGPL, and not to allow others to
68747:  * use your version of this file under the terms of the MPL, indicate your
68747:  * decision by deleting the provisions above and replace them with the notice
68747:  * and other provisions required by the GPL or the LGPL. If you do not delete
68747:  * the provisions above, a recipient may use your version of this file under
68747:  * the terms of any one of the MPL, the GPL or the LGPL.
68747:  *
68747:  * ***** END LICENSE BLOCK ***** */
68747: 
68747: #include "mozilla/WidgetTraceEvent.h"
68747: 
68747: #include <glib.h>
68747: #include <mozilla/CondVar.h>
68747: #include <mozilla/Mutex.h>
68747: #include <stdio.h>
68747: 
68747: using mozilla::CondVar;
68747: using mozilla::Mutex;
68747: using mozilla::MutexAutoLock;
68747: 
68747: namespace {
68747: 
68747: Mutex* sMutex = NULL;
68747: CondVar* sCondVar = NULL;
68747: bool sTracerProcessed = false;
68747: 
68747: // This function is called from the main (UI) thread.
68747: gboolean TracerCallback(gpointer data)
68747: {
80547:   mozilla::SignalTracerThread();
68747:   return FALSE;
68747: }
68747: 
68747: } // namespace
68747: 
68747: namespace mozilla {
68747: 
68747: bool InitWidgetTracing()
68747: {
68747:   sMutex = new Mutex("Event tracer thread mutex");
68747:   sCondVar = new CondVar(*sMutex, "Event tracer thread condvar");
68747:   return sMutex && sCondVar;
68747: }
68747: 
68747: void CleanUpWidgetTracing()
68747: {
68747:   delete sMutex;
68747:   delete sCondVar;
68747:   sMutex = NULL;
68747:   sCondVar = NULL;
68747: }
68747: 
68747: // This function is called from the background tracer thread.
68747: bool FireAndWaitForTracerEvent()
68747: {
68747:   NS_ABORT_IF_FALSE(sMutex && sCondVar, "Tracing not initialized!");
68747: 
68747:   // Send a default-priority idle event through the
68747:   // event loop, and wait for it to finish.
68747:   MutexAutoLock lock(*sMutex);
68747:   NS_ABORT_IF_FALSE(!sTracerProcessed, "Tracer synchronization state is wrong");
68747:   g_idle_add_full(G_PRIORITY_DEFAULT,
68747:                   TracerCallback,
68747:                   NULL,
68747:                   NULL);
68747:   while (!sTracerProcessed)
68747:     sCondVar->Wait();
68747:   sTracerProcessed = false;
68747:   return true;
68747: }
68747: 
80547: void SignalTracerThread()
80547: {
92127:   if (!sMutex || !sCondVar)
92127:     return;
80547:   MutexAutoLock lock(*sMutex);
80547:   NS_ABORT_IF_FALSE(!sTracerProcessed, "Tracer synchronization state is wrong");
80547:   sTracerProcessed = true;
80547:   sCondVar->Notify();
80547: }
80547: 
68747: }  // namespace mozilla
