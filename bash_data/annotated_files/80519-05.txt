    1: /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-
    1:  *
    1:  * ***** BEGIN LICENSE BLOCK *****
    1:  * Version: MPL 1.1/GPL 2.0/LGPL 2.1
    1:  *
    1:  * The contents of this file are subject to the Mozilla Public License Version
    1:  * 1.1 (the "License"); you may not use this file except in compliance with
    1:  * the License. You may obtain a copy of the License at
    1:  * http://www.mozilla.org/MPL/
    1:  *
    1:  * Software distributed under the License is distributed on an "AS IS" basis,
    1:  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
    1:  * for the specific language governing rights and limitations under the
    1:  * License.
    1:  *
    1:  * The Original Code is the Mozilla browser.
    1:  *
    1:  * The Initial Developer of the Original Code is
    1:  * Netscape Communications, Inc.
    1:  * Portions created by the Initial Developer are Copyright (C) 1999
    1:  * the Initial Developer. All Rights Reserved.
    1:  *
    1:  * Contributor(s):
    1:  *   Travis Bogard <travis@netscape.com>
    1:  *
    1:  * Alternatively, the contents of this file may be used under the terms of
    1:  * either of the GNU General Public License Version 2 or later (the "GPL"),
    1:  * or the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
    1:  * in which case the provisions of the GPL or the LGPL are applicable instead
    1:  * of those above. If you wish to allow use of your version of this file only
    1:  * under the terms of either the GPL or the LGPL, and not to allow others to
    1:  * use your version of this file under the terms of the MPL, indicate your
    1:  * decision by deleting the provisions above and replace them with the notice
    1:  * and other provisions required by the GPL or the LGPL. If you do not delete
    1:  * the provisions above, a recipient may use your version of this file under
    1:  * the terms of any one of the MPL, the GPL or the LGPL.
    1:  *
    1:  * ***** END LICENSE BLOCK ***** */
    1: 
46998: #include "mozilla/ModuleUtils.h"
    1: #include "nsDocShellCID.h"
    1: 
28078: #include "nsDocShell.h"
    1: #include "nsDefaultURIFixup.h"
    1: #include "nsWebNavigationInfo.h"
    1: 
    1: #include "nsAboutRedirector.h"
    1: 
    1: // uriloader
    1: #include "nsURILoader.h"
    1: #include "nsDocLoader.h"
    1: #include "nsOSHelperAppService.h"
    1: #include "nsExternalProtocolHandler.h"
    1: #include "nsPrefetchService.h"
 3942: #include "nsOfflineCacheUpdate.h"
 4630: #include "nsLocalHandlerApp.h"
16243: #ifdef MOZ_ENABLE_DBUS
16237: #include "nsDBusHandlerApp.h"
16243: #endif 
56000: #if defined(ANDROID) || defined(MOZ_ENABLE_MEEGOTOUCHSHARE)
54802: #include "nsExternalSharingAppService.h"
54802: #endif
59260: #if defined(ANDROID)
59260: #include "nsExternalURLHandlerService.h"
59260: #endif
    1: 
    1: // session history
    1: #include "nsSHEntry.h"
80519: #include "nsSHEntryShared.h"
    1: #include "nsSHistory.h"
    1: #include "nsSHTransaction.h"
    1: 
 8309: // download history
 8309: #include "nsDownloadHistory.h"
 8309: 
79445: static bool gInitialized = false;
    1: 
    1: // The one time initialization for this module
20261: static nsresult
46998: Initialize()
    1: {
    1:   NS_PRECONDITION(!gInitialized, "docshell module already initialized");
    1:   if (gInitialized) {
    1:     return NS_OK;
    1:   }
80486:   gInitialized = true;
    1: 
    1:   nsresult rv = nsSHistory::Startup();
 6187:   NS_ENSURE_SUCCESS(rv, rv);
 6187: 
80519:   nsSHEntryShared::Startup();
80519:   return NS_OK;
    1: }
    1: 
20261: static void
46998: Shutdown()
    1: {
72449:   nsSHistory::Shutdown();
80519:   nsSHEntryShared::Shutdown();
80486:   gInitialized = false;
    1: }
    1: 
    1: // docshell
28078: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsDocShell, Init)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsDefaultURIFixup)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsWebNavigationInfo, Init)
    1: 
    1: // uriloader
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsURILoader)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsDocLoader, Init)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsOSHelperAppService, Init)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsExternalProtocolHandler)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsPrefetchService, Init)
 3942: NS_GENERIC_FACTORY_SINGLETON_CONSTRUCTOR(nsOfflineCacheUpdateService,
 3942:                                          nsOfflineCacheUpdateService::GetInstance)
 3942: NS_GENERIC_FACTORY_CONSTRUCTOR(nsOfflineCacheUpdate)
 6644: NS_GENERIC_FACTORY_CONSTRUCTOR(PlatformLocalHandlerApp_t)
16243: #ifdef MOZ_ENABLE_DBUS
16237: NS_GENERIC_FACTORY_CONSTRUCTOR(nsDBusHandlerApp)
16243: #endif 
56000: #if defined(ANDROID) || defined(MOZ_ENABLE_MEEGOTOUCHSHARE)
54802: NS_GENERIC_FACTORY_CONSTRUCTOR(nsExternalSharingAppService)
54802: #endif
59260: #if defined(ANDROID)
59260: NS_GENERIC_FACTORY_CONSTRUCTOR(nsExternalURLHandlerService)
59260: #endif
    1: 
    1: // session history
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsSHEntry)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsSHTransaction)
    1: NS_GENERIC_FACTORY_CONSTRUCTOR(nsSHistory)
    1: 
 8309: // download history
 8309: NS_GENERIC_FACTORY_CONSTRUCTOR(nsDownloadHistory)
 8309: 
46998: NS_DEFINE_NAMED_CID(NS_DOCSHELL_CID);
46998: NS_DEFINE_NAMED_CID(NS_DEFAULTURIFIXUP_CID);
46998: NS_DEFINE_NAMED_CID(NS_WEBNAVIGATION_INFO_CID);
46998: NS_DEFINE_NAMED_CID(NS_ABOUT_REDIRECTOR_MODULE_CID);
46998: NS_DEFINE_NAMED_CID(NS_URI_LOADER_CID);
46998: NS_DEFINE_NAMED_CID(NS_DOCUMENTLOADER_SERVICE_CID);
46998: NS_DEFINE_NAMED_CID(NS_EXTERNALHELPERAPPSERVICE_CID);
46998: NS_DEFINE_NAMED_CID(NS_EXTERNALPROTOCOLHANDLER_CID);
46998: NS_DEFINE_NAMED_CID(NS_PREFETCHSERVICE_CID);
46998: NS_DEFINE_NAMED_CID(NS_OFFLINECACHEUPDATESERVICE_CID);
46998: NS_DEFINE_NAMED_CID(NS_OFFLINECACHEUPDATE_CID);
46998: NS_DEFINE_NAMED_CID(NS_LOCALHANDLERAPP_CID);
46998: #ifdef MOZ_ENABLE_DBUS
46998: NS_DEFINE_NAMED_CID(NS_DBUSHANDLERAPP_CID);
46998: #endif
56000: #if defined(ANDROID) || defined(MOZ_ENABLE_MEEGOTOUCHSHARE)
54802: NS_DEFINE_NAMED_CID(NS_EXTERNALSHARINGAPPSERVICE_CID);
54802: #endif
59260: #if defined(ANDROID)
59260: NS_DEFINE_NAMED_CID(NS_EXTERNALURLHANDLERSERVICE_CID);
59260: #endif
46998: NS_DEFINE_NAMED_CID(NS_SHENTRY_CID);
46998: NS_DEFINE_NAMED_CID(NS_HISTORYENTRY_CID);
46998: NS_DEFINE_NAMED_CID(NS_SHTRANSACTION_CID);
46998: NS_DEFINE_NAMED_CID(NS_SHISTORY_CID);
46998: NS_DEFINE_NAMED_CID(NS_SHISTORY_INTERNAL_CID);
46998: NS_DEFINE_NAMED_CID(NS_DOWNLOADHISTORY_CID);
    1: 
46998: 
46998: const mozilla::Module::CIDEntry kDocShellCIDs[] = {
46998:   { &kNS_DOCSHELL_CID, false, NULL, nsDocShellConstructor },
46998:   { &kNS_DEFAULTURIFIXUP_CID, false, NULL, nsDefaultURIFixupConstructor },
46998:   { &kNS_WEBNAVIGATION_INFO_CID, false, NULL, nsWebNavigationInfoConstructor },
46998:   { &kNS_ABOUT_REDIRECTOR_MODULE_CID, false, NULL, nsAboutRedirector::Create },
46998:   { &kNS_URI_LOADER_CID, false, NULL, nsURILoaderConstructor },
46998:   { &kNS_DOCUMENTLOADER_SERVICE_CID, false, NULL, nsDocLoaderConstructor },
46998:   { &kNS_EXTERNALHELPERAPPSERVICE_CID, false, NULL, nsOSHelperAppServiceConstructor },
46998:   { &kNS_EXTERNALPROTOCOLHANDLER_CID, false, NULL, nsExternalProtocolHandlerConstructor },
46998:   { &kNS_PREFETCHSERVICE_CID, false, NULL, nsPrefetchServiceConstructor },
46998:   { &kNS_OFFLINECACHEUPDATESERVICE_CID, false, NULL, nsOfflineCacheUpdateServiceConstructor },
46998:   { &kNS_OFFLINECACHEUPDATE_CID, false, NULL, nsOfflineCacheUpdateConstructor },
46998:   { &kNS_LOCALHANDLERAPP_CID, false, NULL, PlatformLocalHandlerApp_tConstructor },
46998: #ifdef MOZ_ENABLE_DBUS
46998:   { &kNS_DBUSHANDLERAPP_CID, false, NULL, nsDBusHandlerAppConstructor },
10628: #endif
56000: #if defined(ANDROID) || defined(MOZ_ENABLE_MEEGOTOUCHSHARE)
54802:   { &kNS_EXTERNALSHARINGAPPSERVICE_CID, false, NULL, nsExternalSharingAppServiceConstructor },
54802: #endif
59260: #if defined(ANDROID)
59260:   { &kNS_EXTERNALURLHANDLERSERVICE_CID, false, NULL, nsExternalURLHandlerServiceConstructor },
59260: #endif
46998:   { &kNS_SHENTRY_CID, false, NULL, nsSHEntryConstructor },
46998:   { &kNS_HISTORYENTRY_CID, false, NULL, nsSHEntryConstructor },
46998:   { &kNS_SHTRANSACTION_CID, false, NULL, nsSHTransactionConstructor },
46998:   { &kNS_SHISTORY_CID, false, NULL, nsSHistoryConstructor },
46998:   { &kNS_SHISTORY_INTERNAL_CID, false, NULL, nsSHistoryConstructor },
46998:   { &kNS_DOWNLOADHISTORY_CID, false, NULL, nsDownloadHistoryConstructor },
46998:   { NULL }
    1: };
    1: 
46998: const mozilla::Module::ContractIDEntry kDocShellContracts[] = {
46998:   { "@mozilla.org/docshell;1", &kNS_DOCSHELL_CID },
46998:   { NS_URIFIXUP_CONTRACTID, &kNS_DEFAULTURIFIXUP_CID },
46998:   { NS_WEBNAVIGATION_INFO_CONTRACTID, &kNS_WEBNAVIGATION_INFO_CID },
55853:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "about", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "config", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998: #ifdef MOZ_CRASHREPORTER
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "crashes", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998: #endif
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "credits", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "plugins", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "mozilla", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "logo", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "buildconfig", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "license", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "neterror", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "memory", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "addons", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
75339:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "newaddon", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_ABOUT_MODULE_CONTRACTID_PREFIX "support", &kNS_ABOUT_REDIRECTOR_MODULE_CID },
46998:   { NS_URI_LOADER_CONTRACTID, &kNS_URI_LOADER_CID },
46998:   { NS_DOCUMENTLOADER_SERVICE_CONTRACTID, &kNS_DOCUMENTLOADER_SERVICE_CID },
46998:   { NS_EXTERNALHELPERAPPSERVICE_CONTRACTID, &kNS_EXTERNALHELPERAPPSERVICE_CID },
46998:   { NS_EXTERNALPROTOCOLSERVICE_CONTRACTID, &kNS_EXTERNALHELPERAPPSERVICE_CID },
46998:   { NS_MIMESERVICE_CONTRACTID, &kNS_EXTERNALHELPERAPPSERVICE_CID },
46998:   { NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX"default", &kNS_EXTERNALPROTOCOLHANDLER_CID },
46998:   { NS_PREFETCHSERVICE_CONTRACTID, &kNS_PREFETCHSERVICE_CID },
46998:   { NS_OFFLINECACHEUPDATESERVICE_CONTRACTID, &kNS_OFFLINECACHEUPDATESERVICE_CID },
46998:   { NS_OFFLINECACHEUPDATE_CONTRACTID, &kNS_OFFLINECACHEUPDATE_CID },
46998:   { NS_LOCALHANDLERAPP_CONTRACTID, &kNS_LOCALHANDLERAPP_CID },
46998: #ifdef MOZ_ENABLE_DBUS
46998:   { NS_DBUSHANDLERAPP_CONTRACTID, &kNS_DBUSHANDLERAPP_CID },
46998: #endif
56000: #if defined(ANDROID) || defined(MOZ_ENABLE_MEEGOTOUCHSHARE)
54802:   { NS_EXTERNALSHARINGAPPSERVICE_CONTRACTID, &kNS_EXTERNALSHARINGAPPSERVICE_CID },
54802: #endif
59260: #if defined(ANDROID)
59260:   { NS_EXTERNALURLHANDLERSERVICE_CONTRACTID, &kNS_EXTERNALURLHANDLERSERVICE_CID },
59260: #endif
46998:   { NS_SHENTRY_CONTRACTID, &kNS_SHENTRY_CID },
46998:   { NS_HISTORYENTRY_CONTRACTID, &kNS_HISTORYENTRY_CID },
46998:   { NS_SHTRANSACTION_CONTRACTID, &kNS_SHTRANSACTION_CID },
46998:   { NS_SHISTORY_CONTRACTID, &kNS_SHISTORY_CID },
46998:   { NS_SHISTORY_INTERNAL_CONTRACTID, &kNS_SHISTORY_INTERNAL_CID },
46998:   { NS_DOWNLOADHISTORY_CONTRACTID, &kNS_DOWNLOADHISTORY_CID },
46998:   { NULL }
46998: };
46998: 
46998: static const mozilla::Module kDocShellModule = {
46998:   mozilla::Module::kVersion,
46998:   kDocShellCIDs,
46998:   kDocShellContracts,
46998:   NULL,
46998:   NULL,
46998:   Initialize,
46998:   Shutdown
46998: };
46998: 
46998: NSMODULE_DEFN(docshell_provider) = &kDocShellModule;
