 22501: var tabElm, zoomLevel;
 22501: function start_test_prefNotSet() {
 22501:   is(ZoomManager.zoom, 1, "initial zoom level should be 1");
137506:   FullZoom.enlarge();
 22501: 
 22501:   //capture the zoom level to test later
 22501:   zoomLevel = ZoomManager.zoom;
 22501:   isnot(zoomLevel, 1, "zoom level should have changed");
 22501: 
137506:   afterZoomAndLoad(continue_test_prefNotSet);
137506:   content.location = 
137506:     "http://mochi.test:8888/browser/browser/base/content/test/moz.png";
 22501: }
 22501: 
 22501: function continue_test_prefNotSet () {
 32357:   is(ZoomManager.zoom, 1, "zoom level pref should not apply to an image");
137506:   FullZoom.reset();
 22501: 
137506:   afterZoomAndLoad(end_test_prefNotSet);
137506:   content.location = 
137506:     "http://mochi.test:8888/browser/browser/base/content/test/zoom_test.html";
 22501: }
 22501: 
 22501: function end_test_prefNotSet() {
 22501:   is(ZoomManager.zoom, zoomLevel, "the zoom level should have persisted");
 22501: 
 23252:   // Reset the zoom so that other tests have a fresh zoom level
137506:   FullZoom.reset();
 22501:   gBrowser.removeCurrentTab();
137506:   finish();
 22501: }
 22501: 
137506: 
 22501: function test() {
 22501:   waitForExplicitFinish();
 22501: 
 22501:   tabElm = gBrowser.addTab();
137506:   gBrowser.selectedTab = tabElm;
137506: 
137506:   afterZoomAndLoad(start_test_prefNotSet);
137506:   content.location = 
137506:     "http://mochi.test:8888/browser/browser/base/content/test/zoom_test.html";
 39808: }
137506: 
137506: function afterZoomAndLoad(cb) {
137506:   let didLoad = false;
137506:   let didZoom = false;
137506:   tabElm.linkedBrowser.addEventListener("load", function() {
137506:     tabElm.linkedBrowser.removeEventListener("load", arguments.callee, true);
137506:     didLoad = true;
137506:     if (didZoom)
137506:       executeSoon(cb);
137506:   }, true);
137506:   let oldSZFB = ZoomManager.setZoomForBrowser;
137506:   ZoomManager.setZoomForBrowser = function(browser, value) {
137506:     oldSZFB.call(ZoomManager, browser, value);
137506:     ZoomManager.setZoomForBrowser = oldSZFB;
137506:     didZoom = true;
137506:     if (didLoad)
137506:       executeSoon(cb);
137506:   };
137506: }
