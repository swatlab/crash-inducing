 6778: <!DOCTYPE HTML>
 6778: <html>
 6778: <head>
 6778:   <title>Test Word Movement (including nsTextFrame::PeekOffsetWord)</title>
 6778:   <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
 6778:   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
 6778:   <script type="application/javascript" src="/tests/SimpleTest/EventUtils.js"></script>
 6778:   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 6778: </head>
 6778: <body>
 6778: <p id="display"></p>
 6778: <div id="content" style="display: block">
 6778: <div contentEditable id="editor"></div>
 6778: </div>
 7735: <p id="catch">Catch-all
 7735: <pre id="test"><script class="testbody" type="text/javascript;version=1.7">
 6778: 
 6778: /** Test for Bug 384147 **/
 6778: 
 6778: SimpleTest.waitForExplicitFinish();
 6778: 
 6778: // This seems to be necessary because the selection is not set up properly otherwise
27682: addLoadEvent(function() { SimpleTest.executeSoon(test); });
 6778: 
 7735: var eatSpace;
 7735: 
 6802: function getPrefs() {
 6802:   const prefSvcContractID = "@mozilla.org/preferences-service;1";
 6802:   const prefSvcIID = Components.interfaces.nsIPrefService;
 6802:   return Components.classes[prefSvcContractID].getService(prefSvcIID)
 6802:                                                .getBranch("layout.word_select.");
 6802: }
 6802: 
12505: function setPrefs(eat_space, stop_at_punctuation) {
12505:   getPrefs().setBoolPref("eat_space_to_next_word", eat_space);
12505:   getPrefs().setBoolPref("stop_at_punctuation", stop_at_punctuation);
12505:   eatSpace = eat_space;
 6802: }
 6802: 
12505: function restorePrefs() {
 6802:   getPrefs().clearUserPref("eat_space_to_next_word");
12505:   getPrefs().clearUserPref("stop_at_punctuation");
 6802: }
 6802: 
 6778: function test() {
 6802:   netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
 6802: 
 6778:   var wordModifiers =
 6778:       (navigator.platform.indexOf("Mac") >= 0) ? {altKey:true} : {ctrlKey:true};
 6778:   var sel = window.getSelection();
 6778:   var editor = document.getElementById("editor");
 6778: 
 7735:   function errString(dir) {
 7735:     return dir + " movement broken with eatSpace=" + eatSpace + " in \"" + editor.innerHTML +
 7735:       "\"; sel.anchorNode.parentNode=" + sel.anchorNode.parentNode;
 7735:   }
 7735: 
 6778:   function testRight(node, offset) {
 6778:     synthesizeKey("VK_RIGHT", wordModifiers);
 7735:     is(sel.anchorNode, node, errString("Right"));
 7735:     is(sel.anchorOffset, offset, errString("Right"));
 6778:   }
 6778: 
 6778:   function testLeft(node, offset) {
 6778:     synthesizeKey("VK_LEFT", wordModifiers);
 7735:     is(sel.anchorNode, node, errString("Left"));
 7735:     is(sel.anchorOffset, offset, errString("Left"));
 6778:   }
 6778: 
 7735:   var afterEditorNode = document.getElementById("catch").firstChild;
 7735: 
12505:   setPrefs(false, true);
 6802: 
 6778:   editor.innerHTML = "Hello Kitty";
 6778:   sel.collapse(editor.firstChild, 0);
 6778:   testRight(editor.firstChild, 5);
 6778:   testRight(editor.firstChild, 11);
 6778:   testLeft(editor.firstChild, 6);
 6778:   testLeft(editor.firstChild, 0);
 6778: 
 6778:   editor.innerHTML = "<b>Hello</b> Kitty";
 6778:   sel.collapse(editor.firstChild.firstChild, 0);
 6778:   testRight(editor.firstChild.nextSibling, 0);
 6778:   testRight(editor.firstChild.nextSibling, 6);
 6778:   testLeft(editor.firstChild.nextSibling, 1);
 6778:   testLeft(editor.firstChild.firstChild, 0);
 6778: 
 6778:   editor.innerHTML = "<b>Hello </b>Kitty";
 6778:   sel.collapse(editor.firstChild.firstChild, 0);
 6778:   testRight(editor.firstChild.firstChild, 5);
 6778:   testRight(editor.firstChild.nextSibling, 5);
 6778:   testLeft(editor.firstChild.firstChild, 6);
 6778:   testLeft(editor.firstChild.firstChild, 0);
 6778: 
 6778:   editor.innerHTML = "<b>Log out</b>  roc";
 6778:   sel.collapse(editor.firstChild.firstChild, 0);
 6778:   testRight(editor.firstChild.firstChild, 3);
 6778:   testRight(editor.firstChild.nextSibling, 0);
 6778:   testRight(editor.firstChild.nextSibling, 5);
 6778:   // In the next test, we expect to be at the end of the
 6778:   // space that is not collapsed away
 6778:   testLeft(editor.firstChild.nextSibling, 1);
 6778:   testLeft(editor.firstChild.firstChild, 4);
 6778:   testLeft(editor.firstChild.firstChild, 0);
 6778: 
12505:   editor.innerHTML = "http://www.mozilla.org";
12505:   sel.collapse(editor.firstChild, 0);
12505:   testRight(editor.firstChild, 7);
12505:   testRight(editor.firstChild, 11);
12505:   testRight(editor.firstChild, 19);
12505:   testLeft(editor.firstChild, 11);
12505:   testLeft(editor.firstChild, 7);
12505:   testLeft(editor.firstChild, 0);
12505: 
12505:   editor.innerHTML = "Set .rc to <b>'</b>quiz'";
12505:   sel.collapse(editor.firstChild, 0);
12505:   testRight(editor.firstChild, 3);
12505:   testRight(editor.firstChild, 7);
12505:   testRight(editor.firstChild, 10);
12505:   testRight(editor.firstChild.nextSibling.nextSibling, 5);
12505:   testLeft(editor.firstChild.nextSibling.firstChild, 1);
12505:   testLeft(editor.firstChild, 10);
12505:   testLeft(editor.firstChild, 8);
12505:   testLeft(editor.firstChild, 5);
12505:   testLeft(editor.firstChild, 3);
12505:   testLeft(editor.firstChild, 0);
12505: 
15752:   var ChineseChars = "&#x6F22;&#x5B57;";
15752:   var HiraganaChars = "&#x3072;&#x3089;&#x304C;&#x306A;";
15752:   var KatakanaChars = "&#x30AB;&#x30BF;&#x30AB;&#x30CA;";
15752:   var JapaneseFullStop = "&#x3002;";
15752:   var JapaneseComma = "&#x3001";
15752: 
15752:   editor.innerHTML = ChineseChars + HiraganaChars + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 2);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(editor.firstChild, 8);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 2);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = ChineseChars + KatakanaChars + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 2);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(editor.firstChild, 8);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 2);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = KatakanaChars + HiraganaChars + KatakanaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 4);
15752:   testRight(editor.firstChild, 8);
15752:   testRight(editor.firstChild, 12);
15752:   testLeft(editor.firstChild, 8);
15752:   testLeft(editor.firstChild, 4);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = HiraganaChars + JapaneseComma + HiraganaChars + JapaneseFullStop + HiraganaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 5);
15752:   testRight(editor.firstChild, 10);
15752:   testRight(editor.firstChild, 14);
15752:   testLeft(editor.firstChild, 10);
15752:   testLeft(editor.firstChild, 5);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = KatakanaChars + JapaneseComma + KatakanaChars + JapaneseFullStop + KatakanaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 5);
15752:   testRight(editor.firstChild, 10);
15752:   testRight(editor.firstChild, 14);
15752:   testLeft(editor.firstChild, 10);
15752:   testLeft(editor.firstChild, 5);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = ChineseChars + JapaneseComma + ChineseChars + JapaneseFullStop + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 3);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(editor.firstChild, 8);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 3);
15752:   testLeft(editor.firstChild, 0);
15752: 
12505:   setPrefs(true, true);
 7735: 
 7735:   // test basic word movement with eat_space_next_to_word true.
 7735: 
 7735:   editor.innerHTML = "Hello Kitty";
 7735:   sel.collapse(editor.firstChild, 0);
 7735:   testRight(editor.firstChild, 6);
 7735:   testRight(afterEditorNode, 0);
 7735:   testLeft(editor.firstChild, 6);
 7735:   testLeft(editor.firstChild, 0);
 7735: 
 7735:   editor.innerHTML = "<b>Hello</b> Kitty";
 7735:   sel.collapse(editor.firstChild.firstChild, 0);
 7735:   testRight(editor.firstChild.nextSibling, 1);
 7735:   testRight(afterEditorNode, 0);
 7735:   testLeft(editor.firstChild.nextSibling, 1);
 7735:   testLeft(editor.firstChild.firstChild, 0);
 7735: 
 7735:   editor.innerHTML = "<b>Hello </b>Kitty";
 7735:   sel.collapse(editor.firstChild.firstChild, 0);
 7735:   testRight(editor.firstChild.nextSibling, 0);
 7735:   testRight(afterEditorNode, 0);
 7735:   testLeft(editor.firstChild.firstChild, 6);
 7735:   testLeft(editor.firstChild.firstChild, 0);
 7735: 
 7735:   editor.innerHTML = "<b>Log out</b>  roc";
 7735:   sel.collapse(editor.firstChild.firstChild, 0);
 7735:   testRight(editor.firstChild.firstChild, 4);
 7735:   testRight(editor.firstChild.nextSibling, 2);
 7735:   testRight(afterEditorNode, 0);
 7735:   testLeft(editor.firstChild.nextSibling, 1);
 7735:   testLeft(editor.firstChild.firstChild, 4);
 7735:   testLeft(editor.firstChild.firstChild, 0);
 7735: 
12505:   editor.innerHTML = "http://www.mozilla.org";
12505:   sel.collapse(editor.firstChild, 0);
12505:   testRight(editor.firstChild, 7);
12505:   testRight(editor.firstChild, 11);
12505:   testRight(editor.firstChild, 19);
12505:   testLeft(editor.firstChild, 11);
12505:   testLeft(editor.firstChild, 7);
12505:   testLeft(editor.firstChild, 0);
12505: 
12505:   editor.innerHTML = "Set .rc to <b>'</b>quiz'";
12505:   sel.collapse(editor.firstChild, 0);
12505:   testRight(editor.firstChild, 4);
12505:   testRight(editor.firstChild, 8);
12505:   testRight(editor.firstChild.nextSibling.firstChild, 0);
12505:   testRight(afterEditorNode, 0);
12505:   testLeft(editor.firstChild.nextSibling.firstChild, 1);
12505:   testLeft(editor.firstChild, 10);
12505:   testLeft(editor.firstChild, 8);
12505:   testLeft(editor.firstChild, 5);
12505:   testLeft(editor.firstChild, 3);
12505:   testLeft(editor.firstChild, 0);
12505: 
15752:   editor.innerHTML = ChineseChars + HiraganaChars + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 2);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 2);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = ChineseChars + KatakanaChars + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 2);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 2);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = KatakanaChars + HiraganaChars + KatakanaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 4);
15752:   testRight(editor.firstChild, 8);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 8);
15752:   testLeft(editor.firstChild, 4);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = HiraganaChars + JapaneseComma + HiraganaChars + JapaneseFullStop + HiraganaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 5);
15752:   testRight(editor.firstChild, 10);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 10);
15752:   testLeft(editor.firstChild, 5);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = KatakanaChars + JapaneseComma + KatakanaChars + JapaneseFullStop + KatakanaChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 5);
15752:   testRight(editor.firstChild, 10);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 10);
15752:   testLeft(editor.firstChild, 5);
15752:   testLeft(editor.firstChild, 0);
15752: 
15752:   editor.innerHTML = ChineseChars + JapaneseComma + ChineseChars + JapaneseFullStop + ChineseChars;
15752:   sel.collapse(editor.firstChild, 0);
15752:   testRight(editor.firstChild, 3);
15752:   testRight(editor.firstChild, 6);
15752:   testRight(afterEditorNode, 0);
15752:   testLeft(editor.firstChild, 6);
15752:   testLeft(editor.firstChild, 3);
15752:   testLeft(editor.firstChild, 0);
15752: 
12505:   restorePrefs();
 6802: 
 6778:   SimpleTest.finish();
 6778: }
 6778: 
 6778: 
 7735: </script></pre>
 6778: </body>
 6778: </html>
